<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#0a0a0f"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Vault Dex"/>
<title>Vault Dex</title>
<link rel="manifest" href="./manifest.json"/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>
<style>
  :root{
    --bg:#0a0a0f;--bg2:#111118;--bg3:#1a1a24;
    --accent:#00ff88;--warn:#ffaa00;--danger:#ff4466;
    --text:#e8e8f0;--muted:#555570;--border:#22223a;--radius:14px;
    --font-display:'Syne',sans-serif;--font-mono:'JetBrains Mono',monospace;
  }
  /* Light theme override */
  [data-theme="light"]{
    --bg:#f2f2f7;--bg2:#ffffff;--bg3:#e5e5ea;
    --accent:#00994d;--warn:#b87800;--danger:#cc2244;
    --text:#0a0a18;--muted:#8e8ea0;--border:#c8c8d8;
  }
  /* Auto: resolved by time-of-day via JS */
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font-display);overflow-x:hidden;transition:background .3s,color .3s;overscroll-behavior-y:none}
  body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
    background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");opacity:.4}
  #app{position:relative;z-index:1;max-width:480px;margin:0 auto;height:100dvh;display:flex;flex-direction:column;padding:env(safe-area-inset-top,0) 0 env(safe-area-inset-bottom,0)}

  header{padding:20px 20px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0}
  .header-left{display:flex;flex-direction:column;gap:2px}
  .header-title{font-size:22px;font-weight:800;letter-spacing:-.5px}
  .header-date{font-size:11px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1px}
  .header-actions{display:flex;gap:8px}
  .icon-btn{width:38px;height:38px;border-radius:10px;border:1px solid var(--border);background:var(--bg2);color:var(--text);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
  .icon-btn:active{transform:scale(.92);background:var(--bg3)}

  .reconnect-area-wrap{flex-shrink:0}

  .card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;animation:fadeUp .4s ease both;flex-shrink:0}
  .card-header{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
  .card-header.clickable{cursor:pointer;user-select:none;border-bottom:none}
  .card-header.clickable:active{background:var(--bg3)}
  .card-label{font-size:10px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1.5px;color:var(--muted)}
  .card-body{padding:16px}
  .card-body.collapsed{display:none}
  .collapse-arrow{font-size:11px;color:var(--muted);transition:transform .25s;display:inline-block;font-family:var(--font-mono)}
  .collapse-arrow.open{transform:rotate(180deg)}

  /* countdown */
  .cw{display:flex;flex-direction:column;gap:10px}
  .ca{font-size:17px;font-weight:700;line-height:1.3}
  .cm{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
  .cl{font-size:11px;font-family:var(--font-mono);color:var(--muted)}
  .ct{font-size:36px;font-weight:800;font-family:var(--font-mono);color:var(--accent);letter-spacing:-1px;line-height:1;font-variant-numeric:tabular-nums}
  .ct.urgent{color:var(--warn);animation:pulse 1s ease infinite}
  .pb-wrap{height:3px;background:var(--bg3);border-radius:2px;overflow:hidden}
  .pb-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 1s linear}
  .snooze-row{display:flex;gap:8px;flex-wrap:wrap}
  .sn-btn{padding:6px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:12px;font-family:var(--font-mono);cursor:pointer;transition:all .15s}
  .sn-btn:active{background:var(--border);color:var(--text);transform:scale(.95)}
  .snoozed-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:rgba(255,170,0,.12);border:1px solid rgba(255,170,0,.3);border-radius:20px;font-size:11px;font-family:var(--font-mono);color:var(--warn)}

  /* habits */
  .habits-grid{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;padding:4px 2px 8px}
  .habit-col{display:flex;flex-direction:row;align-items:center;gap:5px;cursor:pointer}
  .habit-bar-track{width:6px;height:52px;background:var(--bg3);border-radius:4px;position:relative;overflow:hidden;border:1px solid var(--border);flex-shrink:0}
  .habit-bar-fill{position:absolute;bottom:0;left:0;right:0;border-radius:3px;background:linear-gradient(to top,var(--accent),rgba(0,255,136,.5));transition:height .4s cubic-bezier(.34,1.56,.64,1)}
  .habit-bar-fill.complete{background:var(--accent)}
  .habit-icon{font-size:26px;cursor:pointer;transition:transform .2s cubic-bezier(.34,1.56,.64,1);user-select:none;line-height:1;width:48px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:12px;border:1.5px solid var(--border);background:var(--bg2);position:relative;flex-shrink:0}
  .habit-icon.complete{border-color:rgba(0,255,136,.4);background:rgba(0,255,136,.06)}
  .habit-icon:active{transform:scale(1.25)}
  .habit-val{font-size:9px;font-family:var(--font-mono);color:var(--muted);background:var(--bg3);padding:1px 4px;border-radius:10px}
  .habit-val.complete{color:var(--accent)}
  /* habit edit mode */
  .habit-remove-btn{position:absolute;top:-6px;right:-6px;width:18px;height:18px;border-radius:50%;background:var(--danger);color:#fff;font-size:10px;font-weight:700;border:2px solid var(--bg2);cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:2;padding:0;box-shadow:0 1px 4px rgba(0,0,0,.35)}
  .habit-remove-btn:active{transform:scale(.88)}
  .habit-add-col{display:flex;flex-direction:column;align-items:center;gap:6px;width:56px;cursor:pointer}
  .habit-add-btn{width:44px;height:44px;border-radius:12px;background:rgba(0,255,136,.08);border:1.5px dashed rgba(0,255,136,.35);color:var(--accent);font-size:22px;display:flex;align-items:center;justify-content:center;transition:all .15s}
  .habit-add-btn:active{background:rgba(0,255,136,.18);transform:scale(.92)}
  .habit-add-label{font-size:9px;font-family:var(--font-mono);color:var(--muted)}
  /* habit edit done pill ‚Äî small, tucked into card header area */
  .habit-done-pill{display:none;align-items:center;gap:6px;padding:5px 12px;background:var(--accent);color:var(--bg);border:none;border-radius:20px;font-size:11px;font-family:var(--font-mono);font-weight:700;cursor:pointer;transition:all .15s;flex-shrink:0}
  .habit-done-pill:active{transform:scale(.93)}
  .habit-done-pill.visible{display:flex}

  /* pomodoro */
  .pomo-btn{width:22px;height:22px;border-radius:50%;border:2px solid var(--border);background:var(--bg3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;padding:0}
  @keyframes pomoActivePulse{0%,100%{box-shadow:0 0 0 3px rgba(0,255,136,.12),0 0 0 0 rgba(0,255,136,.0)}50%{box-shadow:0 0 0 3px rgba(0,255,136,.25),0 0 8px 2px rgba(0,255,136,.18)}}
  .pomo-btn.active{border-color:var(--accent);background:rgba(0,255,136,.15);animation:pomoActivePulse 2.4s ease-in-out infinite}
  .pomo-btn .pomo-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);transition:background .2s}
  .pomo-btn.active .pomo-dot{background:var(--accent)}
  .pomo-ring{position:relative;width:60px;height:60px;flex-shrink:0}
  .pomo-ring svg{position:absolute;inset:0;transform:rotate(-90deg)}
  .pomo-ring-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-family:var(--font-mono);font-weight:700;color:var(--accent)}

  /* schedule */
  .sched-list{display:flex;flex-direction:column;gap:2px}
  .sched-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;position:relative}
  .sched-item.current{background:rgba(0,255,136,.07)}
  .sched-item.past{opacity:.4}
  .sched-item.current::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:60%;background:var(--accent);border-radius:2px}
  .sched-time{font-size:11px;font-family:var(--font-mono);color:var(--muted);min-width:52px}
  .sched-act{font-size:14px;flex:1;line-height:1.3}
  .sched-preview{padding:10px 16px 12px;font-size:13px;font-family:var(--font-mono);display:flex;align-items:center;gap:8px;border-top:1px solid var(--border)}

  /* modal */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:500;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(6px);animation:fadeIn .2s ease}
  .modal-overlay.center{align-items:center}
  .modal{background:var(--bg2);border:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-width:480px;padding:20px 20px calc(20px + env(safe-area-inset-bottom,0px));animation:slideUp .3s cubic-bezier(.34,1.56,.64,1);max-height:92dvh;overflow-y:auto}
  .modal.cm-modal{border-radius:20px;animation:scaleIn .25s cubic-bezier(.34,1.56,.64,1);margin:16px}
  .modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px}
  .modal-title{font-size:20px;font-weight:800;margin-bottom:6px}
  .alarm-activity{font-size:18px;font-weight:700;padding:16px;background:var(--bg3);border-radius:12px;text-align:center;margin-bottom:8px;line-height:1.4}
  .alarm-time{font-size:13px;font-family:var(--font-mono);color:var(--accent);text-align:center;margin-bottom:20px}

  /* buttons */
  .btn{padding:12px 22px;border-radius:12px;border:none;cursor:pointer;font-family:var(--font-display);font-size:15px;font-weight:700;transition:all .15s;min-height:48px;display:flex;align-items:center;justify-content:center;gap:6px}
  .btn:active{transform:scale(.95)}
  .btn-green{background:var(--accent);color:var(--bg)}
  .btn-red{background:var(--danger);color:#fff}
  .btn-ghost{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
  .btn-icon{width:52px;height:52px;padding:0;font-size:22px;border-radius:14px;flex-shrink:0}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

  /* reconnect banner */
  .reconnect-banner{margin:12px 20px 0;background:rgba(255,170,0,.07);border:1px solid rgba(255,170,0,.2);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:12px;animation:fadeUp .3s ease}
  .rb-text{flex:1;font-size:12px;color:var(--warn);font-family:var(--font-mono);line-height:1.5}
  .rb-sub{font-size:11px;color:var(--muted);margin-top:2px}
  .reconnect-btn{padding:8px 16px;background:var(--warn);color:#000;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;font-family:var(--font-display);flex-shrink:0}
  .reconnect-btn:active{transform:scale(.95)}

  /* app update banner */
  .update-banner{margin:8px 20px 0;background:rgba(0,255,136,.07);border:1px solid rgba(0,255,136,.25);border-radius:12px;padding:10px 14px;display:flex;align-items:center;gap:10px;animation:fadeUp .35s ease;flex-shrink:0}
  .update-banner-text{flex:1;font-size:12px;color:var(--accent);font-family:var(--font-mono);line-height:1.5}
  .update-banner-text b{color:var(--text)}
  .update-btn{padding:7px 14px;background:var(--accent);color:var(--bg);border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;font-family:var(--font-display);flex-shrink:0;transition:opacity .15s}
  .update-btn:active{opacity:.8}
  .update-dismiss{width:26px;height:26px;border-radius:7px;border:1px solid rgba(0,255,136,.25);background:transparent;color:var(--muted);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .15s;padding:0}
  .update-dismiss:active{background:rgba(0,255,136,.1)}

  /* first-run setup */
  .setup-screen{position:fixed;inset:0;background:var(--bg);z-index:300;overflow-y:auto;padding:48px 24px calc(48px + env(safe-area-inset-bottom,0px));display:flex;flex-direction:column;align-items:center;justify-content:center}
  .setup-inner{width:100%;max-width:360px;display:flex;flex-direction:column;gap:20px;align-items:center}
  .setup-icon{font-size:72px;line-height:1}
  .setup-title{font-size:28px;font-weight:800;letter-spacing:-.5px;text-align:center}
  .setup-desc{font-size:13px;color:var(--muted);line-height:1.7;text-align:center;font-family:var(--font-mono)}
  .setup-note{font-size:11px;color:var(--muted);font-family:var(--font-mono);line-height:1.7;padding:14px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;width:100%}
  .setup-note b{color:var(--warn)}

  /* install guide */
  .install-guide{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:400;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(8px);animation:fadeIn .2s ease}
  .install-modal{background:var(--bg2);border:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-width:480px;padding:24px 24px calc(24px + env(safe-area-inset-bottom,0px));max-height:90dvh;overflow-y:auto;animation:slideUp .3s cubic-bezier(.34,1.56,.64,1)}
  .install-step{display:flex;gap:14px;padding:14px 0;border-bottom:1px solid var(--border)}
  .install-step:last-child{border-bottom:none}
  .install-num{width:28px;height:28px;border-radius:8px;background:rgba(0,255,136,.12);border:1px solid rgba(0,255,136,.25);display:flex;align-items:center;justify-content:center;font-size:11px;font-family:var(--font-mono);color:var(--accent);flex-shrink:0;margin-top:2px}
  .install-text{font-size:13px;line-height:1.6;color:var(--text)}
  .install-text b{color:var(--accent)}
  .install-text small{display:block;margin-top:4px;font-size:11px;font-family:var(--font-mono);color:var(--muted)}
  .platform-tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
  .ptab{padding:7px 14px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--muted);font-size:12px;font-family:var(--font-mono);cursor:pointer;transition:all .15s}
  .ptab.active{background:rgba(0,255,136,.12);border-color:rgba(0,255,136,.3);color:var(--accent)}
  .ptab:active{transform:scale(.95)}
  .platform-steps{display:none}
  .platform-steps.active{display:block}
  .notif-fix{background:rgba(255,170,0,.07);border:1px solid rgba(255,170,0,.2);border-radius:10px;padding:12px 14px;font-size:12px;font-family:var(--font-mono);color:var(--warn);line-height:1.6;margin-top:8px}
  .notif-fix b{color:var(--text)}

  /* settings */
  .s-section{margin-bottom:24px}
  .s-section-title{font-size:10px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px}
  .s-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border);gap:12px}
  .s-row:last-child{border-bottom:none}
  .s-label{font-size:15px;font-weight:600}
  .s-sub{font-size:12px;color:var(--muted);margin-top:2px;font-family:var(--font-mono);word-break:break-all}
  .pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:20px;font-size:11px;font-family:var(--font-mono);font-weight:600;white-space:nowrap}
  .pill-green{background:rgba(0,255,136,.12);color:var(--accent);border:1px solid rgba(0,255,136,.25)}
  .pill-red{background:rgba(255,68,102,.12);color:var(--danger);border:1px solid rgba(255,68,102,.25)}
  .pill-amber{background:rgba(255,170,0,.12);color:var(--warn);border:1px solid rgba(255,170,0,.25)}
  /* theme segment control */
  .theme-seg{display:flex;background:var(--bg3);border-radius:10px;padding:3px;gap:2px}
  .theme-seg-btn{flex:1;padding:7px 10px;border-radius:7px;border:none;background:transparent;color:var(--muted);font-size:11px;font-family:var(--font-mono);font-weight:600;cursor:pointer;transition:all .15s;text-align:center}
  .theme-seg-btn.active{background:var(--bg2);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.18)}
  .empty-state{text-align:center;padding:40px 20px;color:var(--muted);font-size:14px;line-height:1.6}
  .toast{position:fixed;top:calc(16px + env(safe-area-inset-top,0px));left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:10px 18px;font-size:13px;font-family:var(--font-mono);color:var(--text);z-index:1000;white-space:normal;max-width:calc(100vw - 40px);text-align:center;box-shadow:0 4px 24px rgba(0,0,0,.5);animation:toastIn .3s ease;pointer-events:none}

  @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
  @keyframes scaleIn{from{opacity:0;transform:scale(.88)}to{opacity:1;transform:scale(1)}}
  @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  @keyframes emojiPop{0%{opacity:1;transform:translate(-50%,0) scale(1)}60%{opacity:1;transform:translate(-50%,-52px) scale(1.5)}100%{opacity:0;transform:translate(-50%,-80px) scale(.9)}}
  ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

  /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
  .tab-bar{display:flex;border-bottom:1px solid var(--border);background:var(--bg);flex-shrink:0;z-index:10}
  .tab-btn{flex:1;padding:12px 8px;font-size:12px;font-family:var(--font-mono);font-weight:600;letter-spacing:.5px;color:var(--muted);background:none;border:none;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;text-transform:uppercase}
  .tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
  .tab-btn:active{background:var(--bg3)}
  .tabs-container{flex:1;overflow:hidden;display:flex;flex-direction:column;min-height:0}
  .tab-panels{position:relative;flex:1;min-height:0;overflow:hidden}
  .tab-panel{position:absolute;top:0;left:0;width:100%;height:100%;overflow-y:auto;overflow-x:hidden;padding:16px 20px 120px;display:flex;flex-direction:column;gap:16px;-webkit-overflow-scrolling:touch;transform:translateX(100%);transition:transform .28s cubic-bezier(.4,0,.2,1);will-change:transform}
  .tab-panel.active{transform:translateX(0%)}
  .tab-panel.left{transform:translateX(-100%)}
  .tab-panel.dragging{transition:none!important}

  /* ‚îÄ‚îÄ SCHEDULE TAB ‚îÄ‚îÄ */
  .sched-tab-list{display:flex;flex-direction:column;gap:6px}
  /* View mode items ‚Äî card-like, bigger */
  .sched-tab-item{display:flex;align-items:center;gap:14px;padding:14px 16px;border-radius:14px;background:var(--bg2);border:1px solid var(--border);position:relative;transition:background .15s,border-color .15s}
  .sched-tab-item.current{background:rgba(0,255,136,.07);border-color:rgba(0,255,136,.25)}
  .sched-tab-item.past{opacity:.38}
  .sched-tab-item.current::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:50%;background:var(--accent);border-radius:0 2px 2px 0}
  .sched-tab-time-block{display:flex;flex-direction:column;align-items:flex-start;gap:2px;min-width:64px;flex-shrink:0}
  .sched-tab-time{font-size:13px;font-family:var(--font-mono);font-weight:700;color:var(--accent)}
  .sched-tab-item.past .sched-tab-time{color:var(--muted)}
  .sched-tab-divider{width:1px;height:32px;background:var(--border);flex-shrink:0}
  .sched-tab-act{font-size:15px;font-weight:600;flex:1;line-height:1.35;color:var(--text)}
  .sched-current-label{font-size:9px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px;color:var(--accent);font-weight:700}
  /* Delete button ‚Äî only in edit mode */
  .sched-tab-del{width:34px;height:34px;border-radius:9px;border:1px solid rgba(255,68,102,.3);background:rgba(255,68,102,.08);color:var(--danger);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
  .sched-tab-del:active{background:rgba(255,68,102,.2);transform:scale(.9)}
  /* FABs */
  .edit-fab{position:fixed;bottom:calc(24px + env(safe-area-inset-bottom,0px));right:20px;height:50px;min-width:50px;border-radius:16px;background:var(--accent);color:var(--bg);font-size:20px;font-weight:800;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0 18px;box-shadow:0 4px 20px rgba(0,255,136,.4);transition:all .22s;z-index:50;white-space:nowrap;gap:6px}
  .edit-fab:active{transform:scale(.92)}
  .edit-fab.editing{background:var(--warn);box-shadow:0 4px 20px rgba(255,170,0,.4);font-size:14px;font-weight:700}
  .add-fab{position:fixed;bottom:calc(88px + env(safe-area-inset-bottom,0px));right:20px;height:50px;min-width:50px;border-radius:16px;background:var(--bg2);color:var(--accent);font-size:24px;font-weight:800;border:1px solid rgba(0,255,136,.35);cursor:pointer;display:none;align-items:center;justify-content:center;padding:0 18px;box-shadow:0 4px 16px rgba(0,0,0,.3);transition:all .22s;z-index:50}
  .add-fab:active{transform:scale(.92)}
  .add-fab.visible{display:flex}
  .schedule-empty{text-align:center;padding:60px 20px;color:var(--muted);font-size:14px;line-height:1.8}
  /* Inline edit row */
  .sched-edit-row{background:var(--bg3);border:1px solid var(--border);border-radius:14px;padding:12px 14px;display:flex;align-items:center;gap:10px}
  .sched-edit-fields{display:flex;gap:8px;align-items:center;flex:1;min-width:0}
  .sched-edit-time{width:96px;flex-shrink:0;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px 10px;color:var(--text);font-family:var(--font-mono);font-size:12px;outline:none;transition:border-color .15s}
  .sched-edit-time:focus{border-color:var(--accent)}
  .sched-edit-act{flex:1;min-width:0;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px 10px;color:var(--text);font-family:var(--font-display);font-size:14px;outline:none;transition:border-color .15s}
  .sched-edit-act:focus{border-color:var(--accent)}
  /* Add modal */
  .add-sched-modal{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(6px);animation:fadeIn .2s ease}
  .add-sched-sheet{background:var(--bg2);border:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-width:480px;padding:20px 20px calc(20px + env(safe-area-inset-bottom,0px));animation:slideUp .3s cubic-bezier(.34,1.56,.64,1)}
  .add-sched-sheet input,.sched-edit-sheet input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:13px 14px;color:var(--text);font-family:var(--font-mono);font-size:14px;outline:none;margin-bottom:10px;transition:border-color .15s}
  .add-sched-sheet input:focus{border-color:var(--accent)}
  .add-sched-sheet input::placeholder{color:var(--muted)}

  /* ‚îÄ‚îÄ LOGS TAB ‚îÄ‚îÄ */
  .logs-toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-shrink:0}
  .logs-search{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:9px 13px;color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none;transition:border-color .15s}
  .logs-search:focus{border-color:var(--accent)}
  .logs-search::placeholder{color:var(--muted)}
  .logs-container{flex:1;overflow:hidden;position:relative;border:1px solid var(--border);border-radius:12px;background:var(--bg2)}
  .logs-viewport{height:100%;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
  .logs-spacer{position:relative}
  .log-item{position:absolute;left:0;right:0;padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .12s;display:flex;flex-direction:column;gap:3px}
  .log-item:last-child{border-bottom:none}
  .log-item:active,.log-item.hovered{background:var(--bg3)}
  .log-item-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .log-item-time{font-size:11px;font-family:var(--font-mono);color:var(--accent);flex-shrink:0}
  .log-item-filename{font-size:10px;font-family:var(--font-mono);color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:140px}
  .log-item-preview{font-size:12px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;opacity:.8}
  .log-item-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:2px}
  .log-item-tag{font-size:10px;font-family:var(--font-mono);color:var(--accent);background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.2);border-radius:10px;padding:1px 7px}
  .logs-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:13px;line-height:1.8;text-align:center;padding:20px}
  .logs-status{font-size:11px;font-family:var(--font-mono);color:var(--muted);text-align:right;margin-top:6px;flex-shrink:0}
  /* log detail modal */
  .log-detail-body{font-size:13px;font-family:var(--font-mono);line-height:1.7;color:var(--text);white-space:pre-wrap;word-break:break-word;max-height:55dvh;overflow-y:auto;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:14px}
  /* output format input */
  .fmt-input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:10px 13px;color:var(--text);font-family:var(--font-mono);font-size:12px;outline:none;transition:border-color .15s;margin-top:6px}
  .fmt-input:focus{border-color:var(--accent)}
  .fmt-hint{font-size:10px;font-family:var(--font-mono);color:var(--muted);line-height:1.7;margin-top:5px}

  .sched-edit-popup{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1000;display:flex;align-items:flex-end;justify-content:center}
  .sched-edit-sheet{background:var(--bg2);border-radius:20px 20px 0 0;padding:20px 20px 32px;width:100%;max-width:480px;max-height:90dvh;overflow-y:auto}
  .time-picker-wrap{display:flex;gap:6px;align-items:center;justify-content:center;padding:8px 0 16px}
  .time-drum-col{display:flex;flex-direction:column;align-items:center;gap:4px}
  .time-drum-label{font-size:9px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1px}
  .time-drum{height:140px;width:64px;overflow:hidden;position:relative;border-radius:10px;background:var(--bg3);border:1px solid var(--border);cursor:pointer;user-select:none;touch-action:none}
  .time-drum-inner{position:absolute;left:0;right:0;top:0;display:flex;flex-direction:column;align-items:center}
  .time-drum-item{height:44px;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;font-family:var(--font-mono);color:var(--muted);transition:color .15s;flex-shrink:0;width:100%}
  .time-drum-item.selected{color:var(--text)}
  .time-drum::before,.time-drum::after{content:'';position:absolute;left:0;right:0;height:44px;z-index:2;pointer-events:none}
  .time-drum::before{top:0;background:linear-gradient(to bottom,var(--bg3),transparent)}
  .time-drum::after{bottom:0;background:linear-gradient(to top,var(--bg3),transparent)}
  .time-drum-highlight{position:absolute;top:44px;left:0;right:0;height:44px;border-top:1px solid var(--accent);border-bottom:1px solid var(--accent);pointer-events:none;opacity:.5;z-index:1}
  .time-colon{font-size:28px;font-weight:800;font-family:var(--font-mono);color:var(--text);padding-bottom:4px}
  .ampm-drum{width:56px}
  .ampm-drum .time-drum-item{font-size:15px}
  /* Clickable schedule items */
  .sched-tab-item{cursor:pointer;transition:background .15s}
  .sched-tab-item:active{background:var(--bg3)}
  .sched-edit-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border)}
  .sched-edit-row .sched-item-text{flex:1;display:flex;flex-direction:column;gap:2px;cursor:pointer}
  .sched-edit-row .sched-item-time{font-size:13px;font-family:var(--font-mono);color:var(--accent);font-weight:700}
  .sched-edit-row .sched-item-act{font-size:14px;color:var(--text)}
  .sched-edit-row .sched-item-edit-hint{font-size:10px;color:var(--muted);font-family:var(--font-mono)}

  /* ‚îÄ‚îÄ SCHEDULE VIEW TOGGLE ‚îÄ‚îÄ */
  .sched-view-toggle{display:flex;background:var(--bg3);border-radius:10px;padding:3px;gap:2px;margin-bottom:12px;flex-shrink:0}
  .sched-view-btn{flex:1;padding:7px 12px;border-radius:7px;border:none;background:transparent;color:var(--muted);font-size:11px;font-family:var(--font-mono);font-weight:700;cursor:pointer;transition:all .18s;letter-spacing:.3px}
  .sched-view-btn.active{background:var(--bg2);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.22)}

  /* ‚îÄ‚îÄ CALENDAR VIEW ‚îÄ‚îÄ */
  .cal-view-wrap{display:flex;flex-direction:column;gap:0;flex:1;min-height:0}
  .cal-grid-wrap{flex-shrink:0;background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:14px 12px 10px;margin-bottom:10px}
  .cal-grid-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .cal-nav-btn{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;transition:all .12s;flex-shrink:0}
  .cal-nav-btn:active{background:var(--border)}
  .cal-month-label{font-size:15px;font-weight:800;font-family:var(--font-mono);letter-spacing:-.3px}
  .cal-day-headers{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:4px}
  .cal-day-hdr{text-align:center;font-size:9px;font-family:var(--font-mono);color:var(--muted);padding:2px 0;font-weight:700;letter-spacing:.5px}
  .cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
  .cal-day{aspect-ratio:1;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;position:relative;min-height:34px;max-height:44px}
  .cal-day:active{transform:scale(.88)}
  .cal-day.empty{cursor:default;pointer-events:none;background:transparent!important}
  .cal-day-num{font-size:12px;font-weight:700;font-family:var(--font-mono);line-height:1;z-index:1;position:relative}
  .cal-day-dot{width:3px;height:3px;border-radius:50%;background:rgba(255,255,255,.7);margin-top:2px;z-index:1;position:relative;flex-shrink:0}
  .cal-day.today-ring{box-shadow:inset 0 0 0 2px var(--accent)}
  .cal-day.selected-day{box-shadow:inset 0 0 0 2.5px #fff,inset 0 0 0 4px rgba(255,255,255,.3)}
  /* Heat gradient: 0=free(transparent)‚Üí6=packed(red) */
  .cal-heat-0{background:transparent;color:var(--muted)}
  .cal-heat-1{background:rgba(0,255,136,.12);color:var(--text)}
  .cal-heat-2{background:rgba(0,220,120,.28);color:var(--text)}
  .cal-heat-3{background:rgba(60,200,80,.5);color:#fff}
  .cal-heat-4{background:rgba(200,200,0,.5);color:#1a1a00}
  .cal-heat-5{background:rgba(255,140,0,.55);color:#fff}
  .cal-heat-6{background:rgba(255,48,48,.6);color:#fff}
  /* Bottom half sub-tabs */
  .cal-bottom{display:flex;flex-direction:column;flex:1;min-height:180px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .cal-sub-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--bg)}
  .cal-sub-tab{flex:1;padding:9px 4px;font-size:10px;font-family:var(--font-mono);font-weight:700;letter-spacing:.4px;text-transform:uppercase;color:var(--muted);background:none;border:none;cursor:pointer;border-bottom:2px solid transparent;transition:all .18s}
  .cal-sub-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
  .cal-sub-tab:active{background:var(--bg3)}
  .cal-sub-content{flex:1;overflow-y:auto;overflow-x:hidden;padding:10px 12px 16px;-webkit-overflow-scrolling:touch}
  .cal-sub-item{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:10px;border:1px solid var(--border);background:var(--bg3);margin-bottom:5px;transition:background .12s;cursor:pointer}
  .cal-sub-item.now-item{border-color:rgba(0,255,136,.35);background:rgba(0,255,136,.07)}
  .cal-sub-item.past-item{opacity:.38}
  .cal-sub-item:active{background:var(--border)}
  .cal-sub-time{font-size:11px;font-family:var(--font-mono);font-weight:700;color:var(--accent);min-width:60px;flex-shrink:0}
  .cal-sub-act{font-size:13px;flex:1;font-weight:600;color:var(--text);line-height:1.3}
  .cal-sub-repeat{font-size:9px;font-family:var(--font-mono);color:var(--muted);flex-shrink:0;background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:2px 6px;white-space:nowrap}
  .cal-sub-empty{text-align:center;padding:28px 16px;color:var(--muted);font-size:12px;font-family:var(--font-mono);line-height:1.7}
  .cal-selected-bar{padding:7px 12px 5px;border-bottom:1px solid var(--border);font-size:11px;font-family:var(--font-mono);color:var(--accent);display:flex;align-items:center;gap:6px;flex-shrink:0;background:rgba(0,255,136,.04)}
  .cal-heat-legend{display:flex;gap:4px;align-items:center;font-size:9px;font-family:var(--font-mono);color:var(--muted);margin-top:8px;flex-wrap:wrap}
  .cal-heat-swatch{width:14px;height:14px;border-radius:4px;flex-shrink:0}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="header-left">
      <div class="header-title">Vault Dex</div>
      <div class="header-date" id="header-date"></div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="btn-reload" title="Reload">‚Ü∫</button>
      <button class="icon-btn" id="btn-settings" title="Settings">‚öô</button>
    </div>
  </header>
  <div id="reconnect-area"></div>
  <div id="update-banner-area"></div>
  <div class="tabs-container">
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="0">Dashboard</button>
      <button class="tab-btn" data-tab="1">Time Blocks</button>
    </div>
    <div class="tab-panels" id="tab-panels">
      <div class="tab-panel" id="main-content"></div>
      <div class="tab-panel" id="schedule-tab"></div>
    </div>
  </div>
</div>

<script>
'use strict';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  config: null,
  habitData: {},
  snooze: {},
  shownAlarms: {},
  evaluatedAlarms: {},
  countdownInterval: null,
  checkInterval: null,
  vaultDirHandle: null,
  _pendingHandle: null,
  // Derived sub-handles (populated by deriveSubHandles after vault connected)
  habitTrackerDirHandle: null,
  logDirHandle: null,
  logTemplateHandle: null,
  logOutputDirHandle: null,
  eventsDirHandle: null,
  // Session permission flag ‚Äî vault permission asked once per session
  _sessionPermissionGranted: false,
  scheduleOpen: false,
  notifPermission: Notification.permission,
};

const LS = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} },
  del: k => { try { localStorage.removeItem(k); } catch {} },
};

// ‚îÄ‚îÄ IndexedDB ‚Äî stores FileSystemDirectoryHandle (localStorage can't) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const IDB = (() => {
  let db = null;
  const open = () => new Promise((res,rej) => {
    if (db) { res(db); return; }
    const r = indexedDB.open('habit-tracker-v1', 2);
    r.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('kv'))   d.createObjectStore('kv');
      if (!d.objectStoreNames.contains('logs'))  d.createObjectStore('logs', { keyPath: 'id' });
    };
    r.onsuccess = e => { db = e.target.result; db.onclose = () => { db = null; }; res(db); };
    r.onerror = () => rej(r.error);
  });
  return {
    set: async (k,v) => {
      const d = await open();
      return new Promise((res,rej) => {
        const tx = d.transaction('kv','readwrite');
        tx.objectStore('kv').put(v, k);
        tx.oncomplete = () => res(true);
        tx.onerror = () => rej(tx.error);
      });
    },
    get: async (k) => {
      const d = await open();
      return new Promise((res,rej) => {
        const tx = d.transaction('kv','readonly');
        const r = tx.objectStore('kv').get(k);
        r.onsuccess = () => res(r.result);
        r.onerror = () => rej(r.error);
      });
    },
    del: async (k) => {
      const d = await open();
      return new Promise((res,rej) => {
        const tx = d.transaction('kv','readwrite');
        tx.objectStore('kv').delete(k);
        tx.oncomplete = () => res(true);
        tx.onerror = () => rej(tx.error);
      });
    },
    open,
  };
})();

// ‚îÄ‚îÄ IDB LOG STORE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Logs saved here on ALL platforms. On desktop also written to folder.
// On Android folder write silently fails ‚Äî IDB is the only storage.
const IDBLogs = {
  async save(log) {
    try {
      const d = await IDB.open();
      return new Promise((res,rej) => {
        const tx = d.transaction('logs','readwrite');
        tx.objectStore('logs').put(log);
        tx.oncomplete = () => res(true);
        tx.onerror = () => rej(tx.error);
      });
    } catch(e) { console.warn('IDBLogs.save failed:', e); return false; }
  },
  async getAll() {
    try {
      const d = await IDB.open();
      return new Promise((res,rej) => {
        const tx = d.transaction('logs','readonly');
        const r = tx.objectStore('logs').getAll();
        r.onsuccess = () => res(r.result || []);
        r.onerror = () => rej(r.error);
      });
    } catch(e) { console.warn('IDBLogs.getAll failed:', e); return []; }
  },
  async get(id) {
    try {
      const d = await IDB.open();
      return new Promise((res,rej) => {
        const tx = d.transaction('logs','readonly');
        const r = tx.objectStore('logs').get(id);
        r.onsuccess = () => res(r.result);
        r.onerror = () => rej(r.error);
      });
    } catch(e) { console.warn('IDBLogs.get failed:', e); return null; }
  },
  async delete(id) {
    try {
      const d = await IDB.open();
      return new Promise((res,rej) => {
        const tx = d.transaction('logs','readwrite');
        tx.objectStore('logs').delete(id);
        tx.oncomplete = () => res(true);
        tx.onerror = () => rej(tx.error);
      });
    } catch(e) { console.warn('IDBLogs.delete failed:', e); return false; }
  },
};



function todayStr() { return new Date().toISOString().slice(0,10).replace(/-/g,''); }
function todayFilename() { return `22101995${todayStr()}HT.md`; }

function parseTime(str) {
  const [t,p] = str.split(' ');
  let [h,m] = t.split(':').map(Number);
  if (p==='PM' && h!==12) h+=12;
  if (p==='AM' && h===12) h=0;
  return {h,m};
}
function schedDate(ts) {
  const {h,m} = parseTime(ts);
  const d = new Date(); d.setHours(h,m,0,0); return d;
}
function fmtMs(ms) {
  const s=Math.floor(ms/1000), hh=Math.floor(s/3600), mm=Math.floor((s%3600)/60), ss=s%60;
  if (hh>0) return `${hh}h ${mm}m ${ss}s`;
  if (mm>0) return `${mm}m ${ss}s`;
  return `${ss}s`;
}

// ‚îÄ‚îÄ VAULT PATHS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// All sub-folder paths are relative to the vault root
const VAULT_PATHS = {
  habitTracker: ['0 - Personal Space', 'Habit Tracker'],
  logOutput:    ['0 - Personal Space', 'Chrono Log', 'data'],
  events:       ['0 - Personal Space', 'Events'],
};

// Navigate (and optionally create) a chain of subdirectories from a root handle.
async function _navSubDir(root, pathParts, create = true) {
  try {
    let dir = root;
    for (const seg of pathParts) {
      dir = await dir.getDirectoryHandle(seg, { create });
    }
    return dir;
  } catch { return null; }
}

// Populate all sub-handles from the vault root. Called after permission granted.
async function deriveSubHandles() {
  if (!S.vaultDirHandle) return;
  try {
    S.habitTrackerDirHandle = await _navSubDir(S.vaultDirHandle, VAULT_PATHS.habitTracker, true);
    S.logOutputDirHandle    = await _navSubDir(S.vaultDirHandle, VAULT_PATHS.logOutput, true);
    S.eventsDirHandle       = await _navSubDir(S.vaultDirHandle, VAULT_PATHS.events, true);
    // Log template is a file inside logOutput dir
    if (S.logOutputDirHandle) {
      try {
        S.logTemplateHandle = await S.logOutputDirHandle.getFileHandle('_Daily_Log_Template.md', { create: false });
      } catch { S.logTemplateHandle = null; }
    }
  } catch(e) { console.warn('deriveSubHandles:', e.message); }
}

// ‚îÄ‚îÄ VAULT FOLDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pickVaultFolder() {
  try {
    const dh = await window.showDirectoryPicker({ mode:'readwrite', id:'vault' });
    S.vaultDirHandle = dh;
    S._pendingHandle = null;
    S._sessionPermissionGranted = true;
    await IDB.set('vaultHandle', dh);
    LS.set('vaultFolderName', dh.name);
    await deriveSubHandles();
    showToast(`üìÅ ${dh.name} connected`);
    return true;
  } catch(e) {
    if (e.name !== 'AbortError') showToast('Could not open folder');
    return false;
  }
}

async function restoreVaultHandle() {
  try {
    const dh = await IDB.get('vaultHandle');
    if (!dh) return 'none';
    // Validate the handle is usable ‚Äî bad handles from old deployments throw here
    let perm;
    try {
      perm = await dh.queryPermission({ mode: 'readwrite' });
    } catch {
      // Handle is corrupt/stale (e.g. from a different origin/deployment)
      // Clear it so user gets a clean first-run setup
      await IDB.del('vaultHandle');
      LS.del('vaultFolderName');
      return 'none';
    }
    if (perm === 'granted') {
      S.vaultDirHandle = dh;
      S._sessionPermissionGranted = true;
      return 'granted';
    }
    S._pendingHandle = dh;
    return 'needs-grant';
  } catch { return 'none'; }
}

async function reconnectVault() {
  const dh = S._pendingHandle || await IDB.get('vaultHandle').catch(()=>null);
  if (!dh) { await pickVaultFolder(); return !!S.vaultDirHandle; }
  try {
    const perm = await dh.requestPermission({ mode: 'readwrite' });
    if (perm === 'granted') {
      S.vaultDirHandle = dh;
      S._pendingHandle = null;
      S._sessionPermissionGranted = true;
      document.getElementById('reconnect-area').innerHTML = '';
      await deriveSubHandles();
      return true;
    }
  } catch {}
  return false;
}

// ‚îÄ‚îÄ GET DATA SUBFOLDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Returns the vault/data/ DirectoryHandle, creating it if needed
async function getDataDir() {
  if (S.habitTrackerDirHandle) return S.habitTrackerDirHandle;
  if (!S.vaultDirHandle) return null;
  // Fallback: derive on-demand
  S.habitTrackerDirHandle = await _navSubDir(S.vaultDirHandle, VAULT_PATHS.habitTracker, true);
  return S.habitTrackerDirHandle;
}

// ‚îÄ‚îÄ LOAD FROM VAULT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFromVault() {
  if (!S.vaultDirHandle) return;
  LS.del('lastConfig');
  LS.del('lastScheduleEdit');
  await loadTemplate();
  await loadHabitDataFromFile();
}

async function loadTemplate() {
  if (!S.vaultDirHandle) return false;
  try {
    // Search in Habit Tracker subfolder, fall back to vault root for backward compat
    const searchDir = (await getDataDir()) || S.vaultDirHandle;
    for await (const entry of searchDir.values()) {
      if (entry.kind==='file' && entry.name.endsWith('.md') && !entry.name.match(/^\d{16}HT\.md$/)) {
        const file = await entry.getFile();
        const text = await file.text();
        const cfg = parseMd(text);
        if (cfg && cfg.schedule?.length) {
          // Check if user has locally-edited the schedule more recently than the vault file
          const lastEdit = LS.get('lastScheduleEdit') || 0;
          const fileModified = file.lastModified || 0;
          const cached = LS.get('lastConfig');

          if (lastEdit > fileModified && cached?.schedule?.length) {
            // Local edits are newer ‚Äî preserve the local schedule but take habit definitions from vault
            S.config = {
              ...cfg,
              schedule: cached.schedule,
            };
          } else {
            S.config = cfg;
            // Vault is the source of truth ‚Äî clear local-edit timestamp
            LS.del('lastScheduleEdit');
          }
          LS.set('lastConfig', S.config);
          return true;
        }
      }
    }
    return false;
  } catch(e) { console.error('loadTemplate:', e); return false; }
}

async function loadHabitDataFromFile() {
  if (S.vaultDirHandle) {
    try {
      const dataDir = await getDataDir();
      if (dataDir) {
        const fh = await dataDir.getFileHandle(todayFilename(), { create:false });
        const text = await (await fh.getFile()).text();
        const m = text.match(/^---\n([\s\S]+?)\n---/);
        if (m) {
          S.habitData = {};
          m[1].split('\n').forEach(line => {
            const lm = line.match(/^(\w+):\s*(.+)/);
            if (lm) S.habitData[lm[1]] = parseInt(lm[2]) || 0;
          });
          return;
        }
      }
    } catch { /* file doesn't exist yet ‚Äî created on first write */ }
  }
  S.habitData = LS.get('habitData_' + todayStr()) || {};
}

async function writeHabitData() {
  // Always save to localStorage immediately as backup
  LS.set('habitData_' + todayStr(), S.habitData);
  if (!S.vaultDirHandle || !S.config) return;
  try {
    const dataDir = await getDataDir();
    if (!dataDir) return;
    const fn = todayFilename();
    let existingBody = '';
    try {
      const ef = await dataDir.getFileHandle(fn, { create:false });
      const txt = await (await ef.getFile()).text();
      const bm = txt.match(/^---\n[\s\S]+?\n---\n?([\s\S]*)/);
      if (bm) existingBody = bm[1].trimStart();
    } catch {}
    const keys = Object.keys(S.config.habitDefinitions || {});
    const yaml = keys.map(k=>`${k}: ${S.habitData[k]??0}`).join('\n');
    const fh = await dataDir.getFileHandle(fn, { create:true });
    const w = await fh.createWritable();
    await w.write(`---\n${yaml}\n---\n${existingBody ? '\n'+existingBody : ''}`);
    await w.close();
  } catch(e) {
    console.warn('Vault write silently failed (localStorage used):', e.message);
  }
}

// ‚îÄ‚îÄ PARSE .MD FRONTMATTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseMd(text) {
  const fm = text.match(/^---\n([\s\S]+?)\n---/);
  if (!fm) return null;
  try {
    const yaml = fm[1];
    const schedule = [];
    const sm = yaml.match(/^schedule:\s*\n([\s\S]*?)(?=^[a-zA-Z]\w*:)/m);
    if (sm) {
      let cur = null;
      for (const line of sm[1].split('\n')) {
        const tM = line.match(/^\s*-?\s*time:\s*["']?(.+?)["']?\s*$/);
        const aM = line.match(/^\s+activity:\s*["']?(.+?)["']?\s*$/);
        const rM = line.match(/^\s+repeat:\s*(\w+)/);
        const cM = line.match(/^\s+createdOn:\s*["']?(.+?)["']?\s*$/);
        const dM = line.match(/^\s+customDates:\s*["']?(.+?)["']?\s*$/);
        const lmM = line.match(/^\s+limitFrom:\s*["']?(.+?)["']?\s*$/);
        const ltM = line.match(/^\s+limitTo:\s*["']?(.+?)["']?\s*$/);
        const ptM = line.match(/^\s+perDateTimes:\s*["']?(.+?)["']?\s*$/);
        if (tM) {
          if (cur && cur.activity) schedule.push(cur);
          cur = { time: tM[1].trim() };
        } else if (aM && cur) { cur.activity = aM[1].trim(); }
        else if (rM && cur) { cur.repeat = rM[1].trim(); }
        else if (cM && cur) { cur.createdOn = cM[1].trim(); }
        else if (dM && cur) { try { cur.customDates = JSON.parse(dM[1].trim()); } catch { cur.customDates = dM[1].split(',').map(d=>d.trim()); } }
        else if (lmM && cur) { cur.limitFrom = lmM[1].trim(); }
        else if (ltM && cur) { cur.limitTo = ltM[1].trim(); }
        else if (ptM && cur) { try { cur.perDateTimes = JSON.parse(ptM[1].trim()); } catch {} }
      }
      if (cur && cur.activity) schedule.push(cur);
    }
    const habitDefinitions = {};
    const hm = yaml.match(/^habitDefinitions:\s*\n([\s\S]*?)(?=^[a-zA-Z]\w*:)/m);
    if (hm) {
      for (const block of hm[1].split(/\n(?=  \w)/)) {
        const km = block.match(/^\s{2}(\w+):/);
        if (!km) continue;
        const def = {
          type: (block.match(/type:\s*(\w+)/)||[])[1]||'incremental',
          icon: ((block.match(/icon:\s*(.+?)(\s*#.*)?$/m)||[])[1]||'‚≠ê').trim(),
          messages:{}, choices:[],
        };
        const maxM=block.match(/maxValue:\s*(\d+)/), incrM=block.match(/increment:\s*(\d+)/);
        if (maxM) def.maxValue=parseInt(maxM[1]);
        if (incrM) def.increment=parseInt(incrM[1]);
        const msgM=block.match(/messages:\s*\n([\s\S]*?)(?=\n    \w|\n  \w|$)/);
        if (msgM) msgM[1].split('\n').forEach(ml=>{
          const mm=ml.match(/\s+(\w+):\s*["']?(.+?)["']?\s*$/);
          if (mm) def.messages[isNaN(mm[1])?mm[1]:parseInt(mm[1])]=mm[2].trim();
        });
        const chM=block.match(/choices:\s*\n([\s\S]*?)(?=\n  \w|$)/);
        if (chM) {
          let ch=null;
          for (const cl of chM[1].split('\n')) {
            if (cl.match(/^\s*-\s/)) { if(ch) def.choices.push(ch); ch={}; }
            const vM=cl.match(/value:\s*(\d+)/), lM=cl.match(/label:\s*["']?(.+?)["']?\s*$/), mM=cl.match(/message:\s*["']?(.+?)["']?\s*$/);
            if (vM&&ch) ch.value=parseInt(vM[1]);
            if (lM&&ch) ch.label=lM[1].trim();
            if (mM&&ch) ch.message=mM[1].trim();
          }
          if (ch&&Object.keys(ch).length) def.choices.push(ch);
        }
        habitDefinitions[km[1]]=def;
      }
    }
    const snM=yaml.match(/snoozeOptions:\s*\[([^\]]+)\]/);
    const snoozeOptions=snM?snM[1].split(',').map(s=>parseInt(s.trim())).filter(Boolean):[5,10];
    return { schedule, habitDefinitions, habitTracker:{ enabled:true, snoozeOptions } };
  } catch(e) { console.error('Parse error',e); return null; }
}

// ‚îÄ‚îÄ HABIT UPDATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateHabit(key, value) {
  const cfg=S.config?.habitDefinitions?.[key]; if (!cfg) return;
  if (cfg.type==='incremental') {
    const cur=S.habitData[key]||0;
    S.habitData[key]=Math.min(cfg.maxValue, cur+value);
    showToast(cfg.messages?.[S.habitData[key]]||'Logged!');
  } else {
    S.habitData[key]=value;
    showToast(cfg.choices?.find(c=>c.value===value)?.message||'Logged!');
  }
  writeHabitData();
  renderHabitBars();
}
function decrementHabit(key) {
  const cfg=S.config?.habitDefinitions?.[key];
  if (!cfg||cfg.type!=='incremental') return;
  S.habitData[key]=Math.max(0,(S.habitData[key]||0)-cfg.increment);
  showToast(`${key} ‚Üí ${S.habitData[key]}`);
  writeHabitData();
  renderHabitBars();
}

// ‚îÄ‚îÄ SCHEDULE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Returns only schedule items that apply to today based on their repeat field
function getTodaySchedule() {
  const all = S.config?.schedule || [];
  const now = new Date();
  const todayISO = now.toISOString().slice(0,10); // YYYY-MM-DD
  const dow = now.getDay(); // 0=Sun
  const dom = now.getDate();

  return all.filter(item => {
    // Check limit range first
    if (item.limitFrom && todayISO < item.limitFrom) return false;
    if (item.limitTo && todayISO > item.limitTo) return false;

    const r = item.repeat || 'daily'; // default: daily (backward compat)
    if (r === 'daily') return true;
    if (r === 'off') return false;
    if (r === 'weekly') {
      // item must have a createdOn date ‚Äî match same weekday
      if (!item.createdOn) return true; // legacy: always show
      const created = new Date(item.createdOn + 'T00:00:00');
      return created.getDay() === dow;
    }
    if (r === 'monthly') {
      if (!item.createdOn) return true;
      const created = new Date(item.createdOn + 'T00:00:00');
      return created.getDate() === dom;
    }
    if (r === 'yearly') {
      if (!item.createdOn) return true;
      const created = new Date(item.createdOn + 'T00:00:00');
      return created.getMonth() === now.getMonth() && created.getDate() === dom;
    }
    if (r === 'once') {
      // One-time entry: only show on its createdOn date
      return item.createdOn === todayISO;
    }
    if (r === 'custom') {
      // Custom dates: show only if today is in the list
      const dates = item.customDates || [];
      return dates.includes(todayISO);
    }
    return true;
  });
}

function getCurNext() {
  const now=new Date(), sc=getTodaySchedule();
  let cur=-1, next=-1;
  for (let i=0;i<sc.length;i++) {
    if (schedDate(sc[i].time)<=now) cur=i;
    else if (next===-1) next=i;
  }
  return {cur,next};
}
function detectHabit(activity) {
  for (const [key,cfg] of Object.entries(S.config?.habitDefinitions||{}))
    if (activity.includes(cfg.icon)) return {key,config:cfg};
  return null;
}

// ‚îÄ‚îÄ ALARM CHECK + MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkAlarms() {
  if (!S.config) return;
  const now=Date.now(), sc=getTodaySchedule();
  for (const idx in S.snooze) {
    if (S.snooze[idx]<=now) {
      delete S.snooze[idx]; const i=parseInt(idx);
      if (!S.shownAlarms[i]||(now-S.shownAlarms[i])>30000) { showAlarmModal(i); return; }
    }
  }
  for (let i=0;i<sc.length;i++) {
    const diff=now-schedDate(sc[i].time).getTime();
    if (diff>=0&&diff<5000) {
      if (S.shownAlarms[i]&&(now-S.shownAlarms[i])<120000) continue;
      if (S.snooze[i]&&S.snooze[i]>now) continue;
      showAlarmModal(i); return;
    }
  }
}

// ‚îÄ‚îÄ SYNC ALL TODAY'S ALARMS TO SERVICE WORKER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Called whenever the schedule changes or the app loads.
// Sends every future alarm for today so the SW can fire them independently.
function syncAlarmsToSW() {
  if (!navigator.serviceWorker?.controller) return;
  if (S.notifPermission !== 'granted') return;
  if (!S.config?.schedule?.length) return;

  const snOpts = S.config.habitTracker?.snoozeOptions || [5, 10];
  const alarms = [];
  const now = Date.now();

  getTodaySchedule().forEach((item, idx) => {
    const fireAt = schedDate(item.time).getTime();
    if (fireAt <= now) return; // already past

    const hi = detectHabit(item.activity);
    const actions = [];
    if (hi) {
      const { key, config: cfg } = hi;
      if (cfg.type === 'incremental') actions.push({ action: `habit:${key}:${cfg.increment}`, title: `‚úì Done (+${cfg.increment})` });
      else cfg.choices.slice(0, 2).forEach(c => actions.push({ action: `habit:${key}:${c.value}`, title: c.label }));
    }
    actions.push({ action: 'dismiss', title: 'Dismiss' });
    snOpts.slice(0, 1).forEach(m => actions.push({ action: `snooze:${idx}:${m}`, title: `‚è∞ +${m}m` }));

    alarms.push({
      tag:     `alarm-${idx}`,
      title:   `‚è∞ ${item.time} ‚Äî ${item.activity}`,
      body:    hi ? `Time to log ${hi.key}` : 'Time for your next activity',
      fireAt,
      actions,
      data:    { idx, habitKey: hi?.key, habitVal: hi?.config?.type === 'incremental' ? hi?.config?.increment : null }
    });
  });

  navigator.serviceWorker.controller.postMessage({ type: 'SYNC_ALARMS', alarms });
}

// ‚îÄ‚îÄ FORCE SW UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// When the user saves schedule edits, tell any waiting SW to take over
// immediately so the new alarm times are registered right away.
async function forceSwUpdate() {
  try {
    const reg = await navigator.serviceWorker.getRegistration();
    if (!reg) return;

    // If there's a waiting SW (new version), tell it to skip waiting
    if (reg.waiting) {
      reg.waiting.postMessage({ type: 'SKIP_WAITING' });
      // Wait for the new SW to take control, then re-sync alarms
      await new Promise(resolve => {
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          syncAlarmsToSW();
          resolve();
        }, { once: true });
      });
    } else {
      // Same SW version ‚Äî just re-sync the alarms with updated schedule
      syncAlarmsToSW();
    }
  } catch (err) {
    console.warn('forceSwUpdate failed:', err);
    syncAlarmsToSW(); // fallback: at least re-sync
  }
}

function showAlarmModal(idx) {
  S.shownAlarms[idx]=Date.now();
  const item=S.config.schedule[idx], hi=detectHabit(item.activity);
  const snOpts=S.config.habitTracker?.snoozeOptions||[5,10];
  playBeep();

  // Push notification
  if (S.notifPermission==='granted') {
    const actions = [];
    if (hi) {
      const {key, config:cfg} = hi;
      if (cfg.type==='incremental') actions.push({ action:`habit:${key}:${cfg.increment}`, title:`‚úì Done (+${cfg.increment})` });
      else cfg.choices.slice(0,2).forEach(c=>actions.push({ action:`habit:${key}:${c.value}`, title:c.label }));
    }
    actions.push({ action:'dismiss', title:'Dismiss' });
    snOpts.slice(0,1).forEach(m=>actions.push({ action:`snooze:${idx}:${m}`, title:`‚è∞ +${m}m` }));
    if (navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({
        type:'SHOW_ALARM', title:`‚è∞ ${item.time} ‚Äî ${item.activity}`,
        body: hi ? `Tap to log ${hi.key}` : 'Time for your next activity',
        tag:`alarm-${idx}`, data:{idx, habitKey:hi?.key, habitVal:hi?.config?.type==='incremental'?hi?.config?.increment:null}, actions
      });
    } else {
      new Notification(`‚è∞ ${item.activity}`, { body:`${item.time}${hi?` ¬∑ Log ${hi.key}`:''}`, tag:`alarm-${idx}`, requireInteraction:true });
    }
  }

  // Prevent duplicate in-app modals
  document.querySelector('.alarm-modal-ov')?.remove();

  let habitBtns = '';
  if (hi) {
    const {key,config:cfg}=hi;
    if (cfg.type==='incremental') habitBtns=`<button class="btn btn-green aa" data-key="${key}" data-val="${cfg.increment}" style="flex:1">‚úì Done</button>`;
    else habitBtns=cfg.choices.map(c=>`<button class="btn btn-green aa" data-key="${key}" data-val="${c.value}" style="flex:1">${c.label}</button>`).join('');
  }
  const failOpt=hi?.config?.type==='choice'&&hi?.config?.messages?.failed;
  const dismissBtn=failOpt
    ?`<button class="btn btn-red ad" data-key="${hi.key}" data-fail="1" style="flex:1">‚úï Failed</button>`
    :`<button class="btn btn-ghost ad" style="flex:1">Dismiss</button>`;

  const ov=document.createElement('div'); ov.className='modal-overlay center alarm-modal-ov';
  ov.innerHTML=`<div class="modal cm-modal" style="max-width:340px;width:calc(100% - 32px)">
    <div style="text-align:center;font-size:11px;font-family:var(--font-mono);color:var(--accent);margin-bottom:10px;letter-spacing:1.5px;text-transform:uppercase">‚è∞ Time for Activity</div>
    <div class="alarm-activity">${item.activity}</div>
    <div class="alarm-time">${item.time}</div>
    <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">${habitBtns}${dismissBtn}</div>
    <div style="display:flex;gap:8px">
      ${snOpts.map(m=>`<button class="btn btn-ghost as" data-idx="${idx}" data-min="${m}" style="flex:1;font-size:12px;min-height:40px;padding:8px">‚è∞ +${m}m</button>`).join('')}
    </div>
  </div>`;
  document.body.appendChild(ov);
  const close=()=>{ ov.remove(); renderCountdown(); };
  ov.addEventListener('click',e=>{ if(e.target===ov) close(); });
  ov.querySelectorAll('.aa').forEach(b=>b.addEventListener('click',()=>{ updateHabit(b.dataset.key,parseInt(b.dataset.val)); S.evaluatedAlarms[idx]=true; close(); }));
  ov.querySelectorAll('.ad').forEach(b=>b.addEventListener('click',()=>{ if(b.dataset.fail&&b.dataset.key){ updateHabit(b.dataset.key,0); S.evaluatedAlarms[idx]=true; } close(); }));
  ov.querySelectorAll('.as').forEach(b=>b.addEventListener('click',()=>{ S.snooze[parseInt(b.dataset.idx)]=Date.now()+parseInt(b.dataset.min)*60000; showToast(`Snoozed ${b.dataset.min}m`); close(); }));
}

function playBeep() {
  try {
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator(), g=ctx.createGain();
    osc.connect(g); g.connect(ctx.destination);
    osc.frequency.setValueAtTime(880,ctx.currentTime);
    osc.frequency.setValueAtTime(660,ctx.currentTime+0.1);
    g.gain.setValueAtTime(0.3,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.4);
    osc.start(); osc.stop(ctx.currentTime+0.4);
  } catch{}
}


// ‚îÄ‚îÄ RENDER ‚Äî COUNTDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCountdown() {
  const left = document.getElementById('countdown-left'); if (!left) return;
  const todaySched = getTodaySchedule();
  if (!todaySched.length) {
    left.innerHTML = `<div class="cw"><div class="empty-state" style="padding:8px 0;font-size:13px">No schedule today</div></div>`;
    renderEventPanel(); return;
  }
  for (const idx in S.snooze) {
    const until = S.snooze[idx];
    if (until > Date.now()) {
      const item = todaySched[parseInt(idx)];
      left.innerHTML = `<div class="cw"><span class="snoozed-badge">üîï Snoozed</span>
        <div class="ca" style="margin-top:8px">${item?.activity||''}</div>
        <div class="cm"><span class="cl">Resumes ${new Date(until).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
        <span class="ct" id="snooze-timer">${fmtMs(until-Date.now())}</span></div></div>`;
      renderEventPanel(); return;
    }
  }
  const {cur,next} = getCurNext();
  if (cur===-1 && next===-1) {
    left.innerHTML = `<div class="cw"><div style="font-size:13px;color:var(--accent);font-family:var(--font-mono)">‚ú® All done!</div></div>`;
    renderEventPanel(); return;
  }
  if (cur === -1) {
    const ni = todaySched[next]; const rem = schedDate(ni.time) - Date.now();
    left.innerHTML = `<div class="cw"><div class="ca" style="font-size:14px">Up next: ${ni.activity}</div>
      <div class="cm"><span class="cl">Starts in</span><span class="ct${rem<60000?' urgent':''}" id="main-timer">${fmtMs(rem)}</span></div>
      <div class="pb-wrap"><div class="pb-fill" id="prog-bar" style="width:0%"></div></div></div>`;
    renderEventPanel(); return;
  }
  const ci = todaySched[cur];
  if (next === -1) {
    left.innerHTML = `<div class="cw"><div class="ca" style="font-size:14px">${ci.activity}</div>
      <div style="font-size:11px;font-family:var(--font-mono);color:var(--accent);margin-top:4px">‚ú® Final activity</div></div>`;
    renderEventPanel(); return;
  }
  const ni = todaySched[next], rem = schedDate(ni.time) - Date.now();
  const span = schedDate(ni.time) - schedDate(ci.time);
  const pct = Math.max(0, Math.min(100, 100 - (rem / span * 100)));
  left.innerHTML = `<div class="cw"><div class="ca" style="font-size:14px">${ci.activity}</div>
    <div class="cm"><span class="cl">Next: ${ni.time}</span><span class="ct${rem<60000?' urgent':''}" id="main-timer">${fmtMs(rem)}</span></div>
    <div class="pb-wrap"><div class="pb-fill" id="prog-bar" style="width:${pct}%"></div></div></div>`;
  renderEventPanel();
}

// ‚îÄ‚îÄ RENDER ‚Äî EVENT PANEL (right side of Now card) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _cachedTodayEvents = null;
let _eventPanelTick = null;

async function renderEventPanel() {
  const panel = document.getElementById('countdown-event'); if (!panel) return;
  const today = new Date().toISOString().slice(0,10);

  if (!S.eventsDirHandle) {
    panel.innerHTML = `<div style="font-size:9px;font-family:var(--font-mono);color:var(--muted);letter-spacing:.5px;text-align:center;line-height:1.6;opacity:.6">No events<br>folder set</div>`;
    return;
  }

  // Load (or use cache) - reload once per render cycle
  if (!_cachedTodayEvents) {
    const all = await loadEvents();
    _cachedTodayEvents = all.filter(e => e.date === today).sort((a,b) => (a.time||'99:99').localeCompare(b.time||'99:99'));
    // expire cache after 60s
    setTimeout(() => { _cachedTodayEvents = null; }, 60000);
  }

  const evs = _cachedTodayEvents;
  if (!evs.length) {
    panel.innerHTML = `<div style="font-size:9px;font-family:var(--font-mono);color:var(--muted);text-align:center;opacity:.5">No events<br>today</div>
      <button onclick="showAddEventSheet(null,()=>{_cachedTodayEvents=null;renderEventPanel();})" style="margin-top:6px;padding:3px 8px;background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.2);border-radius:8px;color:var(--accent);font-size:10px;font-family:var(--font-mono);cursor:pointer">Ôºã add</button>`;
    return;
  }

  // Show nearest upcoming event (or latest if all past)
  const now = new Date();
  let ev = evs.find(e => {
    if (!e.time) return false;
    const [h,m] = e.time.split(':').map(Number);
    const d = new Date(); d.setHours(h,m,0,0);
    return d > now;
  }) || evs[0];

  let countdown = '';
  let countdownMs = 0;
  if (ev.time) {
    const [h,m] = ev.time.split(':').map(Number);
    const d = new Date(); d.setHours(h,m,0,0);
    countdownMs = d - now;
    if (countdownMs > 0) countdown = fmtMs(countdownMs);
    else countdown = 'Now';
  }

  const upnext = evs.length > 1 ? evs.find(e => e !== ev) : null;
  panel.innerHTML = `
    <div style="font-size:9px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px">üìÖ Event</div>
    <div style="font-size:11px;font-weight:700;color:var(--text);line-height:1.3;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical">${ev.title}</div>
    ${ev.time ? `<div style="font-size:10px;font-family:var(--font-mono);color:var(--accent);margin-top:2px">${ev.time}</div>` : ''}
    ${countdown ? `<div id="ev-panel-timer" style="font-size:13px;font-family:var(--font-mono);font-weight:800;color:${countdownMs > 0 ? 'var(--warn)' : 'var(--accent)'};margin-top:4px;letter-spacing:-.5px">${countdown}</div>` : ''}
    ${upnext ? `<div style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border);font-size:9px;font-family:var(--font-mono);color:var(--muted);line-height:1.4;width:100%"><span style="opacity:.6">Up next:</span><br><span style="color:var(--text)">${upnext.title}</span></div>` : ''}
    <button onclick="showAddEventSheet(null,()=>{_cachedTodayEvents=null;renderEventPanel();})" style="margin-top:8px;padding:2px 8px;background:rgba(0,255,136,.06);border:1px solid rgba(0,255,136,.15);border-radius:6px;color:var(--accent);font-size:9px;font-family:var(--font-mono);cursor:pointer">Ôºã</button>`;

  // Tick the event countdown
  if (_eventPanelTick) clearInterval(_eventPanelTick);
  if (countdownMs > 0) {
    _eventPanelTick = setInterval(() => {
      const t = document.getElementById('ev-panel-timer'); if (!t) { clearInterval(_eventPanelTick); return; }
      const [h2,m2] = ev.time.split(':').map(Number);
      const d2 = new Date(); d2.setHours(h2,m2,0,0);
      const rem2 = d2 - new Date();
      if (rem2 <= 0) { t.textContent = 'Now'; clearInterval(_eventPanelTick); return; }
      t.textContent = fmtMs(rem2);
    }, 1000);
  }
}

function tickCountdown() {
  const snEl=document.getElementById('snooze-timer');
  const todaySched = getTodaySchedule();
  if (snEl) { for (const idx in S.snooze) { if(S.snooze[idx]>Date.now()){ snEl.textContent=fmtMs(S.snooze[idx]-Date.now()); return; }} renderCountdown(); return; }
  const tEl=document.getElementById('main-timer'); if (!tEl) return;
  const {next}=getCurNext(); if (next===-1) { renderCountdown(); return; }
  if (!todaySched[next]) { renderCountdown(); return; }
  const rem=schedDate(todaySched[next].time)-Date.now();
  if (rem<=0) { renderCountdown(); return; }
  tEl.textContent=fmtMs(rem);
  rem<60000?tEl.classList.add('urgent'):tEl.classList.remove('urgent');
  const prog=document.getElementById('prog-bar');
  if (prog) { const {cur}=getCurNext(); if(cur!==-1&&todaySched[cur]){ const sp=schedDate(todaySched[next].time)-schedDate(todaySched[cur].time); prog.style.width=Math.max(0,Math.min(100,100-(rem/sp*100)))+'%'; }}
}



// ‚îÄ‚îÄ POMODORO ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const POMO = {
  active: false,
  loop: false,
  phase: 'work',      // 'work' | 'break'
  workMins: 25,
  breakMins: 5,
  endTime: null,
  _interval: null,
};

function pomoGetSettings() {
  const s = LS.get('pomoSettings');
  return s || { workMins: 25, breakMins: 5, focusMaxMins: 60, breakMaxMins: 15 };
}

function pomoStart(phase) {
  const cfg = pomoGetSettings();
  POMO.workMins = cfg.workMins;
  POMO.breakMins = cfg.breakMins;
  POMO.phase = phase || 'work';
  POMO.active = true;
  const dur = (POMO.phase === 'work' ? POMO.workMins : POMO.breakMins) * 60000;
  POMO.endTime = Date.now() + dur;
  clearInterval(POMO._interval);
  POMO._interval = setInterval(pomoTick, 500);
  pomoUpdateBtn();

  // Schedule SW notification
  if (S.notifPermission === 'granted' && navigator.serviceWorker?.controller) {
    navigator.serviceWorker.controller.postMessage({
      type: 'SCHEDULE_ALARM',
      title: POMO.phase === 'work' ? 'üçÖ Pomodoro done! Time for a break.' : '‚è∞ Break over! Back to work.',
      body: POMO.loop ? 'Tap Stop to end, or Dismiss to continue' : 'Tap Loop to continue or Dismiss',
      tag: 'pomo-alarm',
      delay: dur,
      actions: POMO.loop
        ? [{ action: 'pomo-stop', title: 'Stop' }, { action: 'dismiss', title: 'Dismiss' }]
        : [{ action: 'pomo-loop', title: 'üîÅ Loop' }, { action: 'dismiss', title: 'Dismiss' }]
    });
  }
}

function pomoStop() {
  POMO.active = false;
  POMO.endTime = null;
  clearInterval(POMO._interval);
  POMO._interval = null;
  pomoUpdateBtn();
}

function pomoTick() {
  if (!POMO.active || !POMO.endTime) return;
  const rem = POMO.endTime - Date.now();
  if (rem <= 0) {
    // Phase ended
    if (POMO.loop) {
      // Auto-advance to next phase
      pomoStart(POMO.phase === 'work' ? 'break' : 'work');
    } else {
      pomoStop();
    }
    return;
  }
  // Update ring in dashboard if visible
  const ring = document.getElementById('pomo-ring-label');
  const arc  = document.getElementById('pomo-arc');
  if (ring) {
    ring.textContent = fmtMs(rem);
    const total = (POMO.phase === 'work' ? POMO.workMins : POMO.breakMins) * 60000;
    const pct = 1 - rem / total;
    if (arc) {
      const r = 26, circ = 2 * Math.PI * r;
      arc.setAttribute('stroke-dashoffset', circ * (1 - pct));
    }
  }
  pomoUpdateBtn();
}

function pomoUpdateBtn() {
  const btn = document.getElementById('pomo-btn');
  if (!btn) return;
  btn.classList.toggle('active', POMO.active);
  // If timer is running, show ring; else show dot
  if (POMO.active && POMO.endTime) {
    const rem = POMO.endTime - Date.now();
    const total = (POMO.phase === 'work' ? POMO.workMins : POMO.breakMins) * 60000;
    const pct = 1 - rem / total;
    const r = 8, circ = 2 * Math.PI * r;
    btn.innerHTML = `<svg width="22" height="22" viewBox="0 0 22 22">
      <circle cx="11" cy="11" r="${r}" fill="none" stroke="var(--border)" stroke-width="2.5"/>
      <circle cx="11" cy="11" r="${r}" fill="none" stroke="var(--accent)" stroke-width="2.5"
        stroke-dasharray="${circ}" stroke-dashoffset="${circ*(1-pct)}" transform="rotate(-90 11 11)"
        style="transition:stroke-dashoffset .5s linear"/>
    </svg>`;
  } else {
    btn.innerHTML = `<div class="pomo-dot"></div>`;
  }
}

function showPomoPopup() {
  const existing = document.getElementById('pomo-popup');
  if (existing) { existing.remove(); return; }

  const cfg = pomoGetSettings();
  const ov = document.createElement('div'); ov.className = 'modal-overlay'; ov.id = 'pomo-popup';

  const R = 54, circ = 2 * Math.PI * R;
  const focusMax = Math.max(1, cfg.focusMaxMins || 60);
  const breakMax = Math.max(1, cfg.breakMaxMins || 15);
  const focusMinsArr = Array.from({length: focusMax}, (_,i) => String(i+1).padStart(2,'0'));
  const breakMinsArr = Array.from({length: breakMax}, (_,i) => String(i+1).padStart(2,'0'));

  function fmtMmSs(ms) {
    const s = Math.max(0, Math.floor(ms / 1000));
    return String(Math.floor(s/60)).padStart(2,'0') + ':' + String(s%60).padStart(2,'0');
  }

  function currentPhaseColor() { return POMO.phase === 'work' ? 'var(--accent)' : 'var(--warn)'; }

  ov.innerHTML = `<div class="modal" style="max-width:300px">
    <div class="modal-handle"></div>
    <div style="text-align:center;font-size:16px;font-weight:800;margin-bottom:16px">‚ñ∂ Focus</div>

    <!-- Ring -->
    <div style="display:flex;justify-content:center;margin-bottom:20px">
      <div style="position:relative;width:140px;height:140px;flex-shrink:0">
        <svg width="140" height="140" viewBox="0 0 140 140" style="position:absolute;inset:0;transform:rotate(-90deg)">
          <circle cx="70" cy="70" r="${R}" fill="none" stroke="var(--border)" stroke-width="6"/>
          <circle id="pomo-popup-arc" cx="70" cy="70" r="${R}" fill="none"
            stroke="var(--accent)" stroke-width="6"
            stroke-dasharray="${circ}" stroke-dashoffset="${circ}"
            stroke-linecap="round" style="transition:stroke-dashoffset .5s linear"/>
        </svg>
        <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px">
          <span id="pomo-popup-time" style="font-size:28px;font-family:var(--font-mono);font-weight:800;color:var(--accent);line-height:1;letter-spacing:-1px">--:--</span>
          <span id="pomo-popup-phase" style="font-size:9px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1.5px">min : sec</span>
        </div>
      </div>
    </div>

    <!-- Drums ‚Äî always interactive -->
    <div id="pomo-drums-wrap" style="margin-bottom:16px;display:flex;flex-direction:column;gap:12px">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="font-size:11px;font-family:var(--font-mono);color:var(--muted);letter-spacing:1px;text-transform:uppercase;width:52px;flex-shrink:0">Focus</div>
        <div id="pomo-focus-drum" style="flex:1;min-width:0"></div>
        <div style="font-size:10px;font-family:var(--font-mono);color:var(--muted);flex-shrink:0">min</div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <div style="font-size:11px;font-family:var(--font-mono);color:var(--muted);letter-spacing:1px;text-transform:uppercase;width:52px;flex-shrink:0">Break</div>
        <div id="pomo-break-drum" style="flex:1;min-width:0"></div>
        <div style="font-size:10px;font-family:var(--font-mono);color:var(--muted);flex-shrink:0">min</div>
      </div>
    </div>

    <!-- Loop toggle -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:10px 14px;background:var(--bg3);border-radius:10px;border:1px solid var(--border)">
      <span style="font-size:13px">üîÅ</span>
      <span style="font-size:12px;font-family:var(--font-mono);color:var(--muted);flex:1">Loop</span>
      <div id="pomo-loop-track" style="width:44px;height:24px;border-radius:12px;cursor:pointer;transition:background .2s;position:relative;background:${POMO.loop?'var(--accent)':'rgba(255,255,255,.1)'}">
        <div id="pomo-loop-knob" style="width:20px;height:20px;border-radius:50%;background:white;position:absolute;top:2px;transition:left .2s;left:${POMO.loop?'22px':'2px'}"></div>
      </div>
    </div>

    <!-- Button ‚Äî toggles between Start and Stop in place -->
    <button id="pomo-main-btn" class="btn btn-green" style="width:100%">‚ñ∂ Start</button>
  </div>`;
  document.body.appendChild(ov);

  const arcEl    = ov.querySelector('#pomo-popup-arc');
  const timeEl   = ov.querySelector('#pomo-popup-time');
  const phaseEl  = ov.querySelector('#pomo-popup-phase');
  const mainBtn  = ov.querySelector('#pomo-main-btn');
  const drumsWrap = ov.querySelector('#pomo-drums-wrap');

  // ‚îÄ‚îÄ Build drums ‚îÄ‚îÄ
  const focusInitIdx = Math.min(cfg.workMins, focusMax) - 1;
  const breakInitIdx = Math.min(cfg.breakMins, breakMax) - 1;
  const focusDrum = buildTimeDrum_simple(ov.querySelector('#pomo-focus-drum'), focusMinsArr, focusInitIdx);
  const breakDrum = buildTimeDrum_simple(ov.querySelector('#pomo-break-drum'), breakMinsArr, breakInitIdx);

  // ‚îÄ‚îÄ Loop toggle ‚îÄ‚îÄ
  const track = ov.querySelector('#pomo-loop-track');
  const knob  = ov.querySelector('#pomo-loop-knob');
  track.addEventListener('click', () => {
    POMO.loop = !POMO.loop;
    track.style.background = POMO.loop ? 'var(--accent)' : 'rgba(255,255,255,.1)';
    knob.style.left = POMO.loop ? '22px' : '2px';
  });

  // ‚îÄ‚îÄ Update ring / time display ‚îÄ‚îÄ
  function updateDisplay() {
    if (!POMO.active || !POMO.endTime) {
      // Idle: show selected drum value as countdown preview
      const w = focusDrum ? parseInt(focusDrum.getSelected()) : cfg.workMins;
      timeEl.textContent = String(w).padStart(2,'0') + ':00';
      timeEl.style.color = 'var(--accent)';
      phaseEl.textContent = 'min : sec';
      arcEl.setAttribute('stroke-dashoffset', String(circ));
      arcEl.setAttribute('stroke', 'var(--accent)');
      drumsWrap.style.opacity = '';
      drumsWrap.style.pointerEvents = '';
      mainBtn.textContent = '‚ñ∂ Start';
      mainBtn.className = 'btn btn-green';
      mainBtn.style.width = '100%';
      mainBtn.style.color = '';
      return;
    }
    const rem = Math.max(0, POMO.endTime - Date.now());
    const total = (POMO.phase === 'work' ? POMO.workMins : POMO.breakMins) * 60000;
    const pct = 1 - rem / total;
    const col = POMO.phase === 'work' ? 'var(--accent)' : 'var(--warn)';
    arcEl.setAttribute('stroke-dashoffset', String(circ * (1 - pct)));
    arcEl.setAttribute('stroke', col);
    timeEl.textContent = fmtMmSs(rem);
    timeEl.style.color = col;
    phaseEl.textContent = POMO.phase === 'work' ? 'Focus' : 'Break';
    drumsWrap.style.opacity = '.38';
    drumsWrap.style.pointerEvents = 'none';
    mainBtn.textContent = '‚ñ† Stop';
    mainBtn.className = 'btn btn-ghost';
    mainBtn.style.width = '100%';
    mainBtn.style.color = 'var(--danger)';
  }

  // ‚îÄ‚îÄ Start/Stop toggle (in place, no close/reopen) ‚îÄ‚îÄ
  mainBtn.addEventListener('click', () => {
    if (POMO.active) {
      pomoStop();
      updateDisplay();
    } else {
      const w = focusDrum ? parseInt(focusDrum.getSelected()) : cfg.workMins;
      const b = breakDrum ? parseInt(breakDrum.getSelected()) : cfg.breakMins;
      const s = pomoGetSettings();
      LS.set('pomoSettings', { ...s, workMins: w, breakMins: b });
      pomoStart('work');
      updateDisplay();
    }
  });

  ov.addEventListener('click', e => { if (e.target === ov) ov.remove(); });

  // Initial render
  updateDisplay();

  // ‚îÄ‚îÄ Live tick while popup is open ‚îÄ‚îÄ
  const liveInterval = setInterval(() => {
    if (!document.body.contains(ov)) { clearInterval(liveInterval); return; }
    updateDisplay();
  }, 500);
}

// Minimal drum builder for pomodoro (no AM/PM, just a list of string values)
function buildTimeDrum_simple(container, items, initIdx) {
  if (!container) return null;
  const ITEM_H = 40, DRUM_H = 120, PAD = 1;
  const renderItems = [...items, ...items, ...items];
  const offset = items.length;

  // Build a drum div INSIDE the container rather than styling the container itself
  // This preserves any flex/width CSS already on the container element
  const drum = document.createElement('div');
  drum.style.cssText = 'position:relative;height:' + DRUM_H + 'px;overflow:hidden;border-radius:10px;background:var(--bg3);border:1px solid var(--border);cursor:grab;width:100%;touch-action:none';
  container.appendChild(drum);

  const highlight = document.createElement('div');
  highlight.style.cssText = `position:absolute;left:0;right:0;top:${(DRUM_H-ITEM_H)/2}px;height:${ITEM_H}px;background:rgba(0,255,136,.08);border-top:1px solid rgba(0,255,136,.2);border-bottom:1px solid rgba(0,255,136,.2);pointer-events:none;z-index:1`;
  drum.appendChild(highlight);

  const inner = document.createElement('div');
  inner.style.cssText = 'position:absolute;left:0;right:0;will-change:transform';

  for (let p = 0; p < PAD; p++) {
    const pad = document.createElement('div');
    pad.style.cssText = `height:${ITEM_H}px`;
    inner.appendChild(pad);
  }
  renderItems.forEach(val => {
    const el = document.createElement('div');
    el.style.cssText = `height:${ITEM_H}px;display:flex;align-items:center;justify-content:center;font-size:18px;font-family:var(--font-mono);font-weight:700;color:var(--muted);transition:color .1s,font-size .1s`;
    el.textContent = val;
    inner.appendChild(el);
  });
  for (let p = 0; p < PAD; p++) {
    const pad = document.createElement('div');
    pad.style.cssText = `height:${ITEM_H}px`;
    inner.appendChild(pad);
  }
  drum.appendChild(inner);

  let selected = Math.max(0, Math.min(items.length - 1, initIdx));
  let startY = 0, isDragging = false;

  function getRenderIdx() { return offset + selected; }
  function getY() { return (DRUM_H - ITEM_H) / 2 - (PAD + offset + selected) * ITEM_H; }

  function render(animate) {
    inner.style.transition = animate ? 'transform .18s cubic-bezier(.25,.8,.25,1)' : 'none';
    inner.style.transform = `translateY(${getY()}px)`;
    // Children: PAD pads + renderItems.length items + PAD pads
    // The selected item in the rendered list is at renderItems index (offset + selected)
    // which maps to child index PAD + (offset + selected)
    const selChildIdx = PAD + offset + selected;
    inner.querySelectorAll('div').forEach((el, i) => {
      const isSel = i === selChildIdx;
      el.style.color = isSel ? 'var(--accent)' : 'var(--muted)';
      el.style.fontSize = isSel ? '20px' : '16px';
    });
  }

  function moveTo(n) {
    selected = ((n % items.length) + items.length) % items.length;
    render(true);
  }

  drum.addEventListener('pointerdown', e => {
    isDragging = true; startY = e.clientY;
    inner.style.transition = 'none';
    drum.setPointerCapture(e.pointerId);
    e.stopPropagation(); // prevent overlay dismiss
  });
  drum.addEventListener('pointermove', e => {
    if (!isDragging) return;
    inner.style.transform = `translateY(${getY() + (e.clientY - startY)}px)`;
    e.stopPropagation();
  });
  drum.addEventListener('pointerup', e => {
    if (!isDragging) return;
    isDragging = false;
    moveTo(selected - Math.round((e.clientY - startY) / ITEM_H));
    e.stopPropagation();
  });
  drum.addEventListener('wheel', e => {
    e.preventDefault(); moveTo(selected + (e.deltaY > 0 ? 1 : -1));
  }, { passive: false });

  render(false);
  return { getSelected: () => items[selected] };
}
function renderHabitBars() {
  const el = document.getElementById('card-habits'); if (!el) return;
  const body = el.querySelector('.card-body');
  const defs = S.config?.habitDefinitions;
  const editMode = !!S._habitEditMode;

  // Toggle done ledge
  const ledge = document.getElementById('habit-done-ledge');
  if (ledge) ledge.style.display = editMode ? 'block' : 'none';
  const pill = document.getElementById('habit-done-pill');
  if (pill) pill.style.display = editMode ? 'flex' : 'none';
  const editBtn = document.getElementById('habit-edit-btn');
  if (editBtn) { editBtn.textContent = '‚úé edit'; editBtn.style.color = editMode ? 'var(--accent)' : 'var(--muted)'; }

  if (!defs || !Object.keys(defs).length) {
    if (editMode) {
      const g = document.createElement('div'); g.className = 'habits-grid';
      const ac = document.createElement('div'); ac.className = 'habit-add-col';
      ac.innerHTML = `<div class="habit-add-btn">Ôºã</div><div class="habit-add-label">add</div>`;
      ac.addEventListener('click', () => showAddHabitSheet());
      g.appendChild(ac); body.innerHTML = ''; body.appendChild(g);
    } else {
      body.innerHTML = `<div class="empty-state" style="padding:24px 16px;line-height:2">
        No habits configured<br>
        <span style="font-size:11px;font-family:var(--font-mono);color:var(--muted)">
          Tap <b style="color:var(--text)">‚úé edit</b> to add habits, or connect your<br>
          habit tracker folder via <b style="color:var(--text)">‚öô Settings ‚Üí Habit Tracker Folder</b>
        </span>
      </div>`;
    }
    return;
  }

  const grid = document.createElement('div'); grid.className = 'habits-grid';

  for (const [key, cfg] of Object.entries(defs)) {
    const raw = S.habitData[key] || 0;
    const dv = cfg.type === 'choice' ? (raw > 0 ? 1 : 0) : raw;
    const mv = cfg.type === 'choice' ? 1 : (cfg.maxValue || 1);
    const complete = dv >= mv, pct = Math.max(2, (dv / mv) * 100);
    const col = document.createElement('div');
    col.className = 'habit-col'; col.dataset.key = key;

    if (editMode) {
      col.style.cssText = 'position:relative;width:56px;display:flex;flex-direction:column;align-items:center;gap:0;padding-top:6px';
      col.innerHTML = `
        <div style="position:relative;display:inline-block">
          <div style="font-size:30px;line-height:1;user-select:none;padding-bottom:4px">${cfg.icon}</div>
          <button class="habit-remove-btn-inline" data-key="${key}" style="position:absolute;top:-6px;right:-8px;width:18px;height:18px;border-radius:50%;background:var(--danger);border:none;color:#fff;font-size:11px;font-weight:900;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1;z-index:2;padding:0">‚úï</button>
        </div>
        <button class="habit-edit-icon" data-key="${key}" style="width:56px;padding:3px 0;background:rgba(0,255,136,.13);border:1.5px solid rgba(0,255,136,.35);border-radius:8px;color:var(--accent);font-size:10px;font-family:var(--font-mono);font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:3px">‚úé edit</button>
        <div style="font-size:9px;font-family:var(--font-mono);color:var(--muted);text-align:center;max-width:56px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:4px">${key}</div>`;
    } else {
      const isBoolHabit = cfg.type === 'incremental' && mv === 1 && (cfg.increment||1) === 1;
      const barPct = dv === 0 ? 0 : Math.max(4, (dv / mv) * 100);
      col.innerHTML = `
        <div class="habit-bar-track"><div class="habit-bar-fill${complete ? ' complete' : ''}" style="height:${barPct}%"></div></div>
        <div class="habit-icon${complete ? ' complete' : ''}" data-key="${key}">${cfg.icon}${complete ? `<span style="position:absolute;bottom:-1px;right:-1px;width:14px;height:14px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;color:var(--bg);font-weight:900;border:1.5px solid var(--bg2)">‚úì</span>` : ''}</div>`;

      const iconEl = col.querySelector('.habit-icon');
      iconEl.addEventListener('click', () => {
        showManualModal(key);
      });

      // Double-tap ‚Üí jump to schedule
      let lastTap = 0;
      col.addEventListener('click', () => {
        const now = Date.now();
        if (now - lastTap < 350) {
          if (S._switchTab) S._switchTab(1);
          setTimeout(() => {
            document.getElementById('schedule-tab')?.querySelector('.sched-tab-item.current, .current')
              ?.scrollIntoView({ block: 'center', behavior: 'smooth' });
          }, 380);
        }
        lastTap = now;
      });
    }
    grid.appendChild(col);
  }

  // Add "+" in edit mode
  if (editMode) {
    const ac = document.createElement('div'); ac.className = 'habit-add-col';
    ac.innerHTML = `<div class="habit-add-btn" style="margin-top:6px;width:44px;height:44px">Ôºã</div><div class="habit-add-label">add</div>`;
    ac.addEventListener('click', () => showAddHabitSheet());
    grid.appendChild(ac);
  }

  body.innerHTML = ''; body.appendChild(grid);

  // Wire remove buttons
  grid.querySelectorAll('.habit-remove-btn-inline').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const k = btn.dataset.key;
      if (!S.config?.habitDefinitions || !confirm(`Remove habit "${k}"?`)) return;
      delete S.config.habitDefinitions[k];
      LS.set('lastConfig', S.config);
      saveHabitDefinitionsToVault();
      renderHabitBars();
      showToast(`Removed ${k}`);
    });
  });

  // Wire edit icon click in edit mode
  grid.querySelectorAll('.habit-edit-icon').forEach(iconEl => {
    iconEl.addEventListener('click', e => {
      e.stopPropagation();
      showEditHabitSheet(iconEl.dataset.key);
    });
  });
}

// ‚îÄ‚îÄ EMOJI POP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showEmojiPop(emoji, anchorEl) {
  const r = anchorEl.getBoundingClientRect();
  const p = document.createElement('div');
  p.textContent = emoji;
  p.style.cssText = `position:fixed;left:${r.left+r.width/2}px;top:${r.top}px;font-size:32px;pointer-events:none;z-index:9999;transform:translate(-50%,0);animation:emojiPop .65s cubic-bezier(.34,1.56,.64,1) forwards`;
  document.body.appendChild(p);
  setTimeout(() => p.remove(), 700);
}

// ‚îÄ‚îÄ SAVE HABIT DEFINITIONS TO VAULT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Writes the habitDefinitions block back into the .md frontmatter
async function saveHabitDefinitionsToVault() {
  LS.set('lastConfig', S.config);
  LS.set('lastScheduleEdit', Date.now());
  if (!S.vaultDirHandle || !S.config) return;
  try {
    const searchDir = (await getDataDir()) || S.vaultDirHandle;
    for await (const entry of searchDir.values()) {
      if (entry.kind === 'file' && entry.name.endsWith('.md') && !entry.name.match(/^\d{16}HT\.md$/)) {
        const file = await entry.getFile();
        const originalText = await file.text();
        const newText = rebuildHabitDefsInMd(originalText, S.config.habitDefinitions || {});
        if (newText === null) continue;
        const fh = await searchDir.getFileHandle(entry.name, { create: false });
        const w = await fh.createWritable();
        await w.write(newText);
        await w.close();
        return;
      }
    }
  } catch(e) { console.warn('Habit def vault write failed:', e.message); }
}

// Rebuild habitDefinitions block inside .md frontmatter
function rebuildHabitDefsInMd(text, defs) {
  const fmMatch = text.match(/^(---\n)([\s\S]+?)(\n---)([\s\S]*)$/);
  if (!fmMatch) return null;
  const [, open, yaml, close, body] = fmMatch;

  // Build YAML for each habit def
  const defLines = ['habitDefinitions:'];
  for (const [key, cfg] of Object.entries(defs)) {
    defLines.push(`  ${key}:`);
    defLines.push(`    type: ${cfg.type || 'incremental'}`);
    defLines.push(`    icon: ${cfg.icon || '‚≠ê'}`);
    if (cfg.type === 'incremental') {
      defLines.push(`    maxValue: ${cfg.maxValue || 1}`);
      defLines.push(`    increment: ${cfg.increment || 1}`);
      if (cfg.messages && Object.keys(cfg.messages).length) {
        defLines.push('    messages:');
        for (const [mk, mv] of Object.entries(cfg.messages)) defLines.push(`      ${mk}: '${mv}'`);
      }
    } else {
      if (cfg.messages?.failed) {
        defLines.push('    messages:');
        defLines.push(`      failed: '${cfg.messages.failed}'`);
      }
      if (cfg.choices?.length) {
        defLines.push('    choices:');
        cfg.choices.forEach(c => {
          defLines.push(`      - value: ${c.value}`);
          defLines.push(`        label: '${c.label}'`);
          if (c.message) defLines.push(`        message: '${c.message}'`);
        });
      }
    }
  }

  // Line-by-line replacement
  const lines = yaml.split('\n'); const out = []; let inBlock = false;
  for (const line of lines) {
    if (/^habitDefinitions:\s*$/.test(line)) { inBlock = true; out.push(...defLines); continue; }
    if (inBlock) { if (/^\s+/.test(line) || line.trim() === '') continue; inBlock = false; }
    out.push(line);
  }
  if (!out.some(l => l.startsWith('habitDefinitions:'))) out.push(...defLines);
  return open + out.join('\n') + close + body;
}

// ‚îÄ‚îÄ ADD HABIT SHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAddHabitSheet() {
  const existingKeys = Object.keys(S.config?.habitDefinitions || {}).map(k => k.toLowerCase());

  const ov = document.createElement('div'); ov.className = 'add-sched-modal';
  ov.innerHTML = `<div class="add-sched-sheet" style="max-height:88dvh;overflow-y:auto">
    <div class="modal-handle"></div>
    <div style="font-size:16px;font-weight:800;margin-bottom:16px">Add Habit</div>

    <div style="display:flex;gap:8px;margin-bottom:14px" id="ah-type-row">
      <button class="btn btn-green" id="ah-type-incr" style="flex:1;font-size:13px">‚¨Ü Incremental</button>
      <button class="btn btn-ghost" id="ah-type-choice" style="flex:1;font-size:13px">‚òë Choice</button>
    </div>

    <input type="text" id="ah-key" placeholder="Habit key ‚Äî e.g. water" autocomplete="off" spellcheck="false"/>
    <input type="text" id="ah-icon" placeholder="Emoji icon ‚Äî e.g. üíß" autocomplete="off"/>

    <div id="ah-incr-fields">
      <input type="number" id="ah-max" placeholder="Daily goal ‚Äî e.g. 8" min="1" max="200"/>
    </div>

    <div id="ah-choice-fields" style="display:none">
      <div style="font-size:11px;font-family:var(--font-mono);color:var(--muted);margin-bottom:8px">Add choices (at least 1):</div>
      <div id="ah-choices-list"></div>
      <button class="btn btn-ghost" id="ah-add-choice" style="width:100%;margin-bottom:10px;font-size:13px">Ôºã Add Choice</button>
    </div>

    <div style="display:flex;gap:10px;margin-top:6px">
      <button class="btn btn-ghost" id="ah-cancel" style="flex:1">Cancel</button>
      <button class="btn btn-green" id="ah-add" style="flex:2">Ôºã Add Habit</button>
    </div>
  </div>`;
  document.body.appendChild(ov);

  let habitType = 'incremental';
  const choicesList = ov.querySelector('#ah-choices-list');
  let choiceCount = 0;

  function addChoiceRow(label = '', value = '') {
    choiceCount++;
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;gap:6px;align-items:center;margin-bottom:6px';
    row.dataset.choiceIdx = choiceCount;
    row.innerHTML = `
      <input type="text" placeholder="Label ‚Äî e.g. Good" value="${label}" style="flex:2;margin-bottom:0" class="ah-ch-label"/>
      <input type="number" placeholder="Val" value="${value}" min="0" max="100" style="flex:1;margin-bottom:0;width:60px" class="ah-ch-val"/>
      <button style="width:28px;height:28px;border-radius:7px;border:1px solid rgba(255,68,102,.3);background:rgba(255,68,102,.08);color:var(--danger);font-size:13px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center" class="ah-ch-del">‚úï</button>`;
    row.querySelector('.ah-ch-del').addEventListener('click', () => row.remove());
    // style inputs to match sheet
    row.querySelectorAll('input').forEach(i => {
      i.style.cssText += ';width:auto;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 10px;color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none';
      i.addEventListener('focus', () => i.style.borderColor='var(--accent)');
      i.addEventListener('blur', () => i.style.borderColor='var(--border)');
    });
    choicesList.appendChild(row);
  }
  // Start with 2 default choices
  addChoiceRow('', 1);
  addChoiceRow('', 2);

  // Type switcher
  ov.querySelector('#ah-type-incr').addEventListener('click', () => {
    habitType = 'incremental';
    ov.querySelector('#ah-type-incr').className = 'btn btn-green'; ov.querySelector('#ah-type-incr').style.flex='1'; ov.querySelector('#ah-type-incr').style.fontSize='13px';
    ov.querySelector('#ah-type-choice').className = 'btn btn-ghost'; ov.querySelector('#ah-type-choice').style.flex='1'; ov.querySelector('#ah-type-choice').style.fontSize='13px';
    ov.querySelector('#ah-incr-fields').style.display = '';
    ov.querySelector('#ah-choice-fields').style.display = 'none';
  });
  ov.querySelector('#ah-type-choice').addEventListener('click', () => {
    habitType = 'choice';
    ov.querySelector('#ah-type-choice').className = 'btn btn-green'; ov.querySelector('#ah-type-choice').style.flex='1'; ov.querySelector('#ah-type-choice').style.fontSize='13px';
    ov.querySelector('#ah-type-incr').className = 'btn btn-ghost'; ov.querySelector('#ah-type-incr').style.flex='1'; ov.querySelector('#ah-type-incr').style.fontSize='13px';
    ov.querySelector('#ah-incr-fields').style.display = 'none';
    ov.querySelector('#ah-choice-fields').style.display = '';
  });

  ov.querySelector('#ah-add-choice').addEventListener('click', () => addChoiceRow());

  const close = () => document.body.removeChild(ov);
  ov.addEventListener('click', e => { if (e.target === ov) close(); });
  ov.querySelector('#ah-cancel').addEventListener('click', close);
  setTimeout(() => ov.querySelector('#ah-key').focus(), 100);

  ov.querySelector('#ah-add').addEventListener('click', () => {
    const rawKey = ov.querySelector('#ah-key').value.trim().replace(/\s+/g, '_');
    const icon = ov.querySelector('#ah-icon').value.trim() || '‚≠ê';
    if (!rawKey) { showToast('Enter a habit name'); return; }

    // Duplicate check
    if (existingKeys.includes(rawKey.toLowerCase())) {
      showToast(`"${rawKey}" already exists`); return;
    }

    if (!S.config) S.config = { schedule: [], habitDefinitions: {}, habitTracker: { enabled: true, snoozeOptions: [5, 10] } };
    if (!S.config.habitDefinitions) S.config.habitDefinitions = {};

    if (habitType === 'incremental') {
      const maxVal = parseInt(ov.querySelector('#ah-max').value) || 1;
      S.config.habitDefinitions[rawKey] = { type: 'incremental', icon, maxValue: maxVal, increment: 1, messages: {} };
    } else {
      const rows = choicesList.querySelectorAll('[data-choice-idx]');
      const choices = [];
      let v = 0;
      rows.forEach(row => {
        const label = row.querySelector('.ah-ch-label').value.trim();
        const val = parseInt(row.querySelector('.ah-ch-val').value);
        if (label) { v++; choices.push({ value: isNaN(val) ? v : val, label }); }
      });
      if (!choices.length) { showToast('Add at least one choice'); return; }
      S.config.habitDefinitions[rawKey] = { type: 'choice', icon, choices, messages: {} };
    }

    LS.set('lastConfig', S.config);
    saveHabitDefinitionsToVault();
    close();
    renderHabitBars();
    showToast(`‚úì ${rawKey} added`);
  });
}

// ‚îÄ‚îÄ EDIT HABIT SHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showEditHabitSheet(key) {
  const existingCfg = S.config?.habitDefinitions?.[key]; if (!existingCfg) return;

  const ov = document.createElement('div'); ov.className = 'add-sched-modal';
  ov.innerHTML = `<div class="add-sched-sheet" style="max-height:88dvh;overflow-y:auto">
    <div class="modal-handle"></div>
    <div style="font-size:16px;font-weight:800;margin-bottom:16px">Edit Habit</div>

    <div style="display:flex;gap:8px;margin-bottom:14px" id="ah-type-row">
      <button class="btn ${existingCfg.type==='incremental'?'btn-green':'btn-ghost'}" id="ah-type-incr" style="flex:1;font-size:13px">‚¨Ü Incremental</button>
      <button class="btn ${existingCfg.type==='choice'?'btn-green':'btn-ghost'}" id="ah-type-choice" style="flex:1;font-size:13px">‚òë Choice</button>
    </div>

    <input type="text" id="ah-key" placeholder="Habit key ‚Äî e.g. water" value="${key}" autocomplete="off" spellcheck="false"/>
    <input type="text" id="ah-icon" placeholder="Emoji icon ‚Äî e.g. üíß" value="${existingCfg.icon||'‚≠ê'}" autocomplete="off"/>

    <div id="ah-incr-fields" style="${existingCfg.type==='choice'?'display:none':''}">
      <input type="number" id="ah-max" placeholder="Daily goal ‚Äî e.g. 8" min="1" max="200" value="${existingCfg.maxValue||''}"/>
    </div>

    <div id="ah-choice-fields" style="${existingCfg.type==='incremental'?'display:none':''}">
      <div style="font-size:11px;font-family:var(--font-mono);color:var(--muted);margin-bottom:8px">Choices:</div>
      <div id="ah-choices-list"></div>
      <button class="btn btn-ghost" id="ah-add-choice" style="width:100%;margin-bottom:10px;font-size:13px">Ôºã Add Choice</button>
    </div>

    <div style="display:flex;gap:10px;margin-top:6px">
      <button class="btn btn-ghost" id="ah-cancel" style="flex:1">Cancel</button>
      <button class="btn btn-green" id="ah-save" style="flex:2">‚úì Save Changes</button>
    </div>
  </div>`;
  document.body.appendChild(ov);

  let habitType = existingCfg.type || 'incremental';
  const choicesList = ov.querySelector('#ah-choices-list');
  let choiceCount = 0;

  function addChoiceRow(label = '', value = '') {
    choiceCount++;
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;gap:6px;align-items:center;margin-bottom:6px';
    row.dataset.choiceIdx = choiceCount;
    row.innerHTML = `
      <input type="text" placeholder="Label ‚Äî e.g. Good" value="${label}" style="flex:2;margin-bottom:0" class="ah-ch-label"/>
      <input type="number" placeholder="Val" value="${value}" min="0" max="100" style="flex:1;margin-bottom:0;width:60px" class="ah-ch-val"/>
      <button style="width:28px;height:28px;border-radius:7px;border:1px solid rgba(255,68,102,.3);background:rgba(255,68,102,.08);color:var(--danger);font-size:13px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center" class="ah-ch-del">‚úï</button>`;
    row.querySelector('.ah-ch-del').addEventListener('click', () => row.remove());
    row.querySelectorAll('input').forEach(i => {
      i.style.cssText += ';width:auto;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 10px;color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none';
      i.addEventListener('focus', () => i.style.borderColor='var(--accent)');
      i.addEventListener('blur', () => i.style.borderColor='var(--border)');
    });
    choicesList.appendChild(row);
  }

  // Pre-populate choices if editing a choice habit
  if (existingCfg.type === 'choice' && existingCfg.choices?.length) {
    existingCfg.choices.forEach(c => addChoiceRow(c.label || '', c.value || ''));
  } else if (existingCfg.type !== 'choice') {
    addChoiceRow('', 1); addChoiceRow('', 2);
  }

  ov.querySelector('#ah-type-incr').addEventListener('click', () => {
    habitType = 'incremental';
    ov.querySelector('#ah-type-incr').className = 'btn btn-green'; ov.querySelector('#ah-type-incr').style.flex='1'; ov.querySelector('#ah-type-incr').style.fontSize='13px';
    ov.querySelector('#ah-type-choice').className = 'btn btn-ghost'; ov.querySelector('#ah-type-choice').style.flex='1'; ov.querySelector('#ah-type-choice').style.fontSize='13px';
    ov.querySelector('#ah-incr-fields').style.display = '';
    ov.querySelector('#ah-choice-fields').style.display = 'none';
  });
  ov.querySelector('#ah-type-choice').addEventListener('click', () => {
    habitType = 'choice';
    ov.querySelector('#ah-type-choice').className = 'btn btn-green'; ov.querySelector('#ah-type-choice').style.flex='1'; ov.querySelector('#ah-type-choice').style.fontSize='13px';
    ov.querySelector('#ah-type-incr').className = 'btn btn-ghost'; ov.querySelector('#ah-type-incr').style.flex='1'; ov.querySelector('#ah-type-incr').style.fontSize='13px';
    ov.querySelector('#ah-incr-fields').style.display = 'none';
    ov.querySelector('#ah-choice-fields').style.display = '';
  });

  ov.querySelector('#ah-add-choice').addEventListener('click', () => addChoiceRow());

  const close = () => document.body.removeChild(ov);
  ov.addEventListener('click', e => { if (e.target === ov) close(); });
  ov.querySelector('#ah-cancel').addEventListener('click', close);

  ov.querySelector('#ah-save').addEventListener('click', () => {
    const newKey = ov.querySelector('#ah-key').value.trim().replace(/\s+/g, '_');
    const icon = ov.querySelector('#ah-icon').value.trim() || '‚≠ê';
    if (!newKey) { showToast('Enter a habit name'); return; }

    if (!S.config) S.config = { schedule: [], habitDefinitions: {}, habitTracker: { enabled: true, snoozeOptions: [5, 10] } };
    if (!S.config.habitDefinitions) S.config.habitDefinitions = {};

    // If key changed, remove old entry
    if (newKey !== key) {
      delete S.config.habitDefinitions[key];
      if (S.habitData[key] !== undefined) { S.habitData[newKey] = S.habitData[key]; delete S.habitData[key]; }
    }

    if (habitType === 'incremental') {
      const maxVal = parseInt(ov.querySelector('#ah-max').value) || 1;
      S.config.habitDefinitions[newKey] = { type: 'incremental', icon, maxValue: maxVal, increment: 1, messages: existingCfg.messages||{} };
    } else {
      const rows = choicesList.querySelectorAll('[data-choice-idx]');
      const choices = [];
      let v = 0;
      rows.forEach(row => {
        const label = row.querySelector('.ah-ch-label').value.trim();
        const val = parseInt(row.querySelector('.ah-ch-val').value);
        if (label) { v++; choices.push({ value: isNaN(val) ? v : val, label }); }
      });
      if (!choices.length) { showToast('Add at least one choice'); return; }
      S.config.habitDefinitions[newKey] = { type: 'choice', icon, choices, messages: existingCfg.messages||{} };
    }

    LS.set('lastConfig', S.config);
    saveHabitDefinitionsToVault();
    close();
    renderHabitBars();
    showToast(`‚úì ${newKey} updated`);
  });
}


function showManualModal(key) {
  const cfg=S.config?.habitDefinitions?.[key]; if (!cfg) return;
  const raw=S.habitData[key]||0;
  const mv=cfg.type==='choice'?1:(cfg.maxValue||1);
  const dv=cfg.type==='choice'?(raw>0?1:0):raw;
  const isComplete = dv >= mv;
  const isBoolHabit = cfg.type==='incremental' && mv===1 && (cfg.increment||1)===1;
  const ov=document.createElement('div'); ov.className='modal-overlay';
  let actions='';
  if (isBoolHabit) {
    // Binary habit ‚Äî show ‚úì / ‚úï buttons only
    const done = raw >= 1;
    actions=`
      <div class="btn-row" style="justify-content:center;gap:16px">
        <button class="btn btn-green btn-icon" id="mh-check" style="font-size:22px;width:64px;height:64px;${done?'outline:2px solid var(--accent)':''}">‚úì</button>
        <button class="btn btn-red btn-icon" id="mh-cross" style="font-size:22px;width:64px;height:64px;${!done&&raw===0?'':''}">‚úï</button>
      </div>
      ${done?`<div style="font-size:11px;font-family:var(--font-mono);color:var(--accent);text-align:center;margin-top:12px">‚úì Done today!</div>`:''}`;
  } else if (cfg.type==='incremental') {
    actions=`
      <div style="font-size:12px;font-family:var(--font-mono);color:var(--muted);text-align:center;margin-bottom:${isComplete?'8px':'16px'}">
        <strong style="color:var(--text)">${dv}</strong> / ${mv}</div>
      ${isComplete?`<div style="font-size:11px;font-family:var(--font-mono);color:var(--accent);text-align:center;margin-bottom:14px;padding:6px 12px;background:rgba(0,255,136,.08);border-radius:8px">‚úì Goal reached!</div>`:''}
      <div class="btn-row">
        <button class="btn btn-green btn-icon" id="mh-inc" ${isComplete?'disabled style="opacity:.45;cursor:not-allowed"':''}>Ôºã</button>
        <button class="btn btn-red btn-icon" id="mh-dec">‚àí</button>
      </div>`;
  } else {
    actions=`${isComplete?`<div style="font-size:11px;font-family:var(--font-mono);color:var(--accent);text-align:center;margin-bottom:14px;padding:6px 12px;background:rgba(0,255,136,.08);border-radius:8px">‚úì Already completed ‚Äî tap to change</div>`:''}
      <div class="btn-row">
        ${cfg.choices.map(c=>`<button class="btn btn-green mh-ch" data-val="${c.value}" style="${raw===c.value?'outline:2px solid var(--accent)':''}">${c.label}</button>`).join('')}
        ${cfg.messages?.failed?`<button class="btn btn-red mh-fail">‚úï Fail</button>`:''}
      </div>`;
  }
  ov.innerHTML=`<div class="modal">
    <div class="modal-handle"></div>
    <div style="font-size:48px;text-align:center;margin-bottom:8px">${cfg.icon}</div>
    <div style="font-size:16px;font-weight:700;text-align:center;margin-bottom:16px">${key}</div>
    ${actions}
  </div>`;
  document.body.appendChild(ov);
  ov.addEventListener('click',e=>{ if(e.target===ov) document.body.removeChild(ov); });
  if (isBoolHabit) {
    ov.querySelector('#mh-check').addEventListener('click',()=>{
      S.habitData[key]=1; writeHabitData(); renderHabitBars(); showToast('‚úì Done!'); document.body.removeChild(ov);
    });
    ov.querySelector('#mh-cross').addEventListener('click',()=>{
      S.habitData[key]=0; writeHabitData(); renderHabitBars(); showToast('Cleared'); document.body.removeChild(ov);
    });
  } else if (cfg.type==='incremental') {
    ov.querySelector('#mh-inc').addEventListener('click',()=>{ 
      const cur2 = S.habitData[key]||0;
      if (cur2 >= cfg.maxValue) { showToast(cfg.messages?.maxReached||'Already at max!'); return; }
      S.habitData[key]=Math.min(cfg.maxValue, cur2+(cfg.increment||1));
      showToast(cfg.messages?.[S.habitData[key]]||'Logged!');
      writeHabitData(); renderHabitBars();
      document.body.removeChild(ov); 
    });
    ov.querySelector('#mh-dec').addEventListener('click',()=>{ decrementHabit(key); document.body.removeChild(ov); });
  } else {
    ov.querySelectorAll('.mh-ch').forEach(b=>b.addEventListener('click',()=>{ updateHabit(key,parseInt(b.dataset.val)); document.body.removeChild(ov); }));
    ov.querySelector('.mh-fail')?.addEventListener('click',()=>{ updateHabit(key,0); document.body.removeChild(ov); });
  }
}

// ‚îÄ‚îÄ RENDER ‚Äî SCHEDULE TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _scheduleSnapshot = null;
let _schedView = 'list'; // 'list' | 'calendar'
let _calViewYear = new Date().getFullYear();
let _calViewMonth = new Date().getMonth();
let _calSelectedISO = new Date().toISOString().slice(0,10);
let _calSubTab = 'daily'; // 'daily'|'weekly'|'monthly'|'custom'

function renderScheduleTab(editMode) {
  const el = document.getElementById('schedule-tab');
  if (!el) return;
  const sc = S.config?.schedule;

  if (!sc?.length && !editMode) {
    const hasVault = !!S.vaultDirHandle;
    const btns = hasVault
      ? '<div style="display:flex;gap:10px;padding:0 4px"><button class="btn btn-green" id="sched-empty-add" style="flex:1">Ôºã Add Entry</button><button class="btn btn-ghost" id="sched-empty-settings" style="flex:1">‚öô Settings</button></div>'
      : '<button class="btn btn-ghost" id="sched-empty-settings" style="width:100%;margin-top:8px">‚öô Open Settings</button>';
    const subtitle = hasVault
      ? 'No schedule found in vault ‚Äî add entries below or check your .md config file.'
      : 'Tap <b>‚öô Settings ‚Üí Habit Tracker Folder</b> to connect your vault,<br>or add entries manually below';
    el.innerHTML = '<div class="schedule-empty">üì≠ No schedule loaded<br><small style="font-size:11px;font-family:var(--font-mono);opacity:.7">' + subtitle + '</small></div>' + btns;
    el.querySelector('#sched-empty-add')?.addEventListener('click', () => {
      if (S._enterSchedEdit) S._enterSchedEdit();
      setTimeout(() => {
        showAddScheduleSheet(() => { renderScheduleTab(true); });
      }, 50);
    });
    el.querySelector('#sched-empty-settings')?.addEventListener('click', () => showSettings());
    let lp;
    el.addEventListener('pointerdown', () => { lp = setTimeout(() => { if (S._enterSchedEdit) S._enterSchedEdit(); }, 600); });
    el.addEventListener('pointerup', () => clearTimeout(lp));
    el.addEventListener('pointercancel', () => clearTimeout(lp));
    return;
  }

  // ‚îÄ‚îÄ Build view toggle + content wrapper ‚îÄ‚îÄ
  el.innerHTML = '';

  // Toggle (hidden in edit mode)
  if (!editMode) {
    const toggle = document.createElement('div');
    toggle.className = 'sched-view-toggle';
    toggle.innerHTML = `
      <button class="sched-view-btn${_schedView==='list'?' active':''}" data-view="list">‚ò∞ Today</button>
      <button class="sched-view-btn${_schedView==='calendar'?' active':''}" data-view="calendar">üìÖ Calendar</button>`;
    toggle.querySelectorAll('.sched-view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        _schedView = btn.dataset.view;
        renderScheduleTab(false);
      });
    });
    el.appendChild(toggle);
  }

  if (!editMode && _schedView === 'calendar') {
    renderCalendarView(el);
    return;
  }

  // ‚îÄ‚îÄ LIST VIEW (existing logic) ‚îÄ‚îÄ
  const { cur } = getCurNext(), now = new Date();
  const todaySc = getTodaySchedule();
  const allSc = S.config?.schedule || [];
  const contentWrap = document.createElement('div');
  contentWrap.style.cssText = 'display:flex;flex-direction:column;gap:6px;';

  if (!todaySc.length && !editMode) {
    contentWrap.innerHTML = `<div class="schedule-empty" style="padding:40px 0">No activities scheduled for today</div>`;
  } else {
    const listDiv = document.createElement('div');
    listDiv.className = 'sched-tab-list';

    if (editMode) {
      allSc.forEach((item, i) => {
        const repeatLabel = { daily:'Daily', weekly:'Weekly', monthly:'Monthly', yearly:'Yearly', once:'One-time', off:'Off', custom:'Custom Dates' }[item.repeat||'daily'] || 'Daily';
        const repeatColor = item.repeat === 'off' ? 'var(--danger)' : item.repeat === 'once' ? 'var(--warn)' : 'var(--muted)';
        const blockBadge = item.blockType === 'routine' ? 'üîÑ' : item.blockType === 'open' ? 'üåÄ' : item.blockType === 'scheduled' ? 'üìå' : '';
        const row = document.createElement('div');
        row.className = 'sched-edit-row';
        row.dataset.idx = i;
        row.innerHTML = `<button class="sched-tab-del" data-idx="${i}" title="Delete">‚úï</button>
          <div class="sched-item-text" data-edit-idx="${i}">
            <span class="sched-item-time">${item.blockType === 'open' ? `üåÄ ~${item.duration||30}min` : item.time}</span>
            <span class="sched-item-act">${blockBadge ? blockBadge + ' ' : ''}${item.activity.replace(/</g,'&lt;')}</span>
            <span class="sched-item-edit-hint" style="color:${repeatColor}">${repeatLabel} ¬∑ tap to edit</span>
          </div>`;
        listDiv.appendChild(row);
      });
    } else {
      todaySc.forEach((item, ti) => {
        const t = schedDate(item.time);
        const isCur = ti === cur, isPast = t < now && !isCur;
        const hi = detectHabit(item.activity);
        const habitDot = hi ? `<span style="width:7px;height:7px;border-radius:50%;background:var(--accent);flex-shrink:0;margin-left:auto;opacity:.7"></span>` : '';
        const origIdx = allSc.indexOf(item);
        const blockEmoji = item.blockType === 'routine' ? 'üîÑ' : item.blockType === 'open' ? 'üåÄ' : item.blockType === 'scheduled' ? 'üìå' : '';
        const timeDisplay = item.blockType === 'open' ? `~${item.duration||30}m` : item.time;
        const row = document.createElement('div');
        row.className = `sched-tab-item ${isCur?'current':''} ${isPast?'past':''}`;
        row.dataset.schedIdx = origIdx;
        row.innerHTML = `<div class="sched-tab-time-block">
            <span class="sched-tab-time">${timeDisplay}</span>
            ${isCur ? `<span class="sched-current-label">Now</span>` : ''}
          </div>
          <div class="sched-tab-divider"></div>
          <span class="sched-tab-act">${blockEmoji ? blockEmoji + ' ' : ''}${item.activity}</span>
          ${habitDot}`;
        listDiv.appendChild(row);
      });
    }
    contentWrap.appendChild(listDiv);
  }

  el.appendChild(contentWrap);

  if (!editMode) {
    setTimeout(() => el.querySelector('.current')?.scrollIntoView({ block: 'center', behavior: 'smooth' }), 150);
    el.querySelectorAll('.sched-tab-item').forEach((row, i) => {
      let lp;
      row.addEventListener('pointerdown', () => { lp = setTimeout(() => { if (S._enterSchedEdit) S._enterSchedEdit(); }, 500); });
      row.addEventListener('pointerup',   () => clearTimeout(lp));
      row.addEventListener('pointercancel', () => clearTimeout(lp));
      row.addEventListener('pointermove', () => clearTimeout(lp));
      row.addEventListener('click', () => {
        const item = S.config.schedule[i];
        if (!item) return;
        const hi = detectHabit(item.activity);
        if (!hi) return;
        showManualModal(hi.key);
      });
    });
    return;
  }

  // Edit mode wiring
  el.querySelectorAll('.sched-tab-del').forEach(b => {
    b.addEventListener('click', () => {
      const idx = parseInt(b.dataset.idx);
      S.config.schedule.splice(idx, 1);
      LS.set('lastConfig', S.config);
      saveScheduleToVault();
      forceSwUpdate();
      renderScheduleTab(true);
    });
  });

  el.querySelectorAll('.sched-item-text').forEach(row => {
    row.addEventListener('click', () => {
      const idx = parseInt(row.dataset.editIdx);
      const item = S.config.schedule[idx];
      if (!item) return;
      showEditSchedulePopup(item.time, item.activity, item.repeat, (newTime, newAct, newRepeat) => {
        S.config.schedule[idx] = { time: newTime, activity: newAct, repeat: newRepeat || 'daily', createdOn: item.createdOn || new Date().toISOString().slice(0,10) };
        try { S.config.schedule.sort((a, b) => schedDate(a.time) - schedDate(b.time)); } catch {}
        LS.set('lastConfig', S.config);
        saveScheduleToVault();
        forceSwUpdate();
        renderScheduleTab(true);
      });
    });
  });
}

// ‚îÄ‚îÄ CALENDAR HEAT MAP + SUB-TABS VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getScheduleForDate(isoDate) {
  // Returns items for a date (YYYY-MM-DD).
  // Daily + unlimited items are excluded from the calendar heat map ‚Äî
  // they are background routines, not discrete blocks worth highlighting.
  const all = S.config?.schedule || [];
  const d = new Date(isoDate + 'T00:00:00');
  const dow = d.getDay();
  const dom = d.getDate();

  return all.filter(item => {
    if (item.limitFrom && isoDate < item.limitFrom) return false;
    if (item.limitTo && isoDate > item.limitTo) return false;
    const r = item.repeat || 'daily';
    // Daily with no date limits = unlimited routine ‚Üí skip in calendar
    if (r === 'daily' && !item.limitFrom && !item.limitTo) return false;
    if (r === 'daily') return true; // daily but bounded by date range ‚Üí show
    if (r === 'off') return false;
    if (r === 'weekly') {
      if (!item.createdOn) return true;
      return new Date(item.createdOn + 'T00:00:00').getDay() === dow;
    }
    if (r === 'monthly') {
      if (!item.createdOn) return true;
      return new Date(item.createdOn + 'T00:00:00').getDate() === dom;
    }
    if (r === 'yearly') {
      if (!item.createdOn) return true;
      const cd = new Date(item.createdOn + 'T00:00:00');
      return cd.getMonth() === d.getMonth() && cd.getDate() === dom;
    }
    if (r === 'once') return item.createdOn === isoDate;
    if (r === 'custom') return (item.customDates || []).includes(isoDate);
    return true;
  });
}

function getHeatLevel(taskCount) {
  // 0 tasks = 0, 1-2 = 1, 3-4 = 2, 5-6 = 3, 7-8 = 4, 9-10 = 5, 11+ = 6
  if (taskCount === 0) return 0;
  return Math.min(6, Math.ceil(taskCount / 2));
}

function renderCalendarView(container) {
  const now = new Date();
  const todayISO = now.toISOString().slice(0,10);

  const wrap = document.createElement('div');
  wrap.className = 'cal-view-wrap';

  // ‚îÄ‚îÄ TOP: Calendar Grid ‚îÄ‚îÄ
  const gridWrap = document.createElement('div');
  gridWrap.className = 'cal-grid-wrap';
  wrap.appendChild(gridWrap);

  function buildGrid() {
    gridWrap.innerHTML = '';

    // Nav row
    const nav = document.createElement('div');
    nav.className = 'cal-grid-nav';
    const prevBtn = document.createElement('button');
    prevBtn.className = 'cal-nav-btn';
    prevBtn.innerHTML = '‚Äπ';
    const nextBtn = document.createElement('button');
    nextBtn.className = 'cal-nav-btn';
    nextBtn.innerHTML = '‚Ä∫';
    const mLabel = document.createElement('div');
    mLabel.className = 'cal-month-label';
    const mNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    mLabel.textContent = `${mNames[_calViewMonth]} ${_calViewYear}`;

    // Heat legend (compact, inline)
    const legend = document.createElement('div');
    legend.className = 'cal-heat-legend';
    legend.innerHTML = `<span>Free</span>
      <div class="cal-heat-swatch cal-heat-1"></div>
      <div class="cal-heat-swatch cal-heat-2"></div>
      <div class="cal-heat-swatch cal-heat-3"></div>
      <div class="cal-heat-swatch cal-heat-4"></div>
      <div class="cal-heat-swatch cal-heat-5"></div>
      <div class="cal-heat-swatch cal-heat-6"></div>
      <span>Packed</span>`;

    nav.appendChild(prevBtn);
    nav.appendChild(mLabel);
    nav.appendChild(nextBtn);
    gridWrap.appendChild(nav);

    prevBtn.addEventListener('click', () => {
      _calViewMonth--;
      if (_calViewMonth < 0) { _calViewMonth = 11; _calViewYear--; }
      buildGrid();
    });
    nextBtn.addEventListener('click', () => {
      _calViewMonth++;
      if (_calViewMonth > 11) { _calViewMonth = 0; _calViewYear++; }
      buildGrid();
    });

    // Day headers
    const dayHdrs = document.createElement('div');
    dayHdrs.className = 'cal-day-headers';
    ['SUN','MON','TUE','WED','THU','FRI','SAT'].forEach(d => {
      const h = document.createElement('div');
      h.className = 'cal-day-hdr';
      h.textContent = d;
      dayHdrs.appendChild(h);
    });
    gridWrap.appendChild(dayHdrs);

    // Days grid
    const daysGrid = document.createElement('div');
    daysGrid.className = 'cal-days';

    const firstDay = new Date(_calViewYear, _calViewMonth, 1).getDay();
    const daysInMonth = new Date(_calViewYear, _calViewMonth + 1, 0).getDate();

    for (let i = 0; i < firstDay; i++) {
      const empty = document.createElement('div');
      empty.className = 'cal-day empty';
      daysGrid.appendChild(empty);
    }

    for (let d = 1; d <= daysInMonth; d++) {
      const iso = `${_calViewYear}-${String(_calViewMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const tasks = getScheduleForDate(iso);
      const heat = getHeatLevel(tasks.length);
      const isToday = iso === todayISO;
      const isSel = iso === _calSelectedISO;

      const cell = document.createElement('div');
      cell.className = `cal-day cal-heat-${heat}${isToday?' today-ring':''}${isSel?' selected-day':''}`;

      const numEl = document.createElement('div');
      numEl.className = 'cal-day-num';
      numEl.textContent = d;
      cell.appendChild(numEl);

      if (tasks.length > 0) {
        const dot = document.createElement('div');
        dot.className = 'cal-day-dot';
        cell.appendChild(dot);
      }

      cell.title = `${tasks.length} task${tasks.length !== 1 ? 's' : ''}`;
      cell.addEventListener('click', () => {
        _calSelectedISO = iso;
        buildGrid();
        buildSubContent();
      });
      daysGrid.appendChild(cell);
    }
    gridWrap.appendChild(daysGrid);
    gridWrap.appendChild(legend);
  }

  // ‚îÄ‚îÄ BOTTOM: Day blocks panel ‚îÄ‚îÄ
  const bottom = document.createElement('div');
  bottom.className = 'cal-bottom';

  // Selected day header bar (date label + Ôºã Add Block button)
  const selBar = document.createElement('div');
  selBar.className = 'cal-selected-bar';
  selBar.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:8px 12px;flex-shrink:0;border-bottom:1px solid var(--border);background:rgba(0,255,136,.03)';
  bottom.appendChild(selBar);

  // Sub tab bar ‚Äî Blocks (once/custom) | Recurring (weekly/monthly/yearly)
  const subTabBar = document.createElement('div');
  subTabBar.className = 'cal-sub-tabs';
  // Ensure _calSubTab is never 'daily' (old value) ‚Äî reset to 'blocks'
  if (_calSubTab === 'daily') _calSubTab = 'blocks';
  const subTabs = [
    { id: 'blocks',    label: 'üìå Blocks' },
    { id: 'recurring', label: 'üîÅ Recurring' },
  ];
  subTabs.forEach(t => {
    const btn = document.createElement('button');
    btn.className = `cal-sub-tab${_calSubTab === t.id ? ' active' : ''}`;
    btn.textContent = t.label;
    btn.addEventListener('click', () => {
      _calSubTab = t.id;
      subTabBar.querySelectorAll('.cal-sub-tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      buildSubContent();
    });
    subTabBar.appendChild(btn);
  });
  bottom.appendChild(subTabBar);

  const subContent = document.createElement('div');
  subContent.className = 'cal-sub-content';
  bottom.appendChild(subContent);

  function openAddBlockForDate(isoDate) {
    // Open add-schedule sheet pre-seeded for a specific date as a one-time block
    showAddScheduleSheetForDate(isoDate, () => {
      buildGrid();       // refresh heat map
      buildSubContent(); // refresh day panel
    });
  }

  function buildSubContent() {
    const d = new Date(_calSelectedISO + 'T00:00:00');
    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const mNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const isSelToday = _calSelectedISO === todayISO;

    // ‚îÄ‚îÄ Header bar: date label + add button ‚îÄ‚îÄ
    selBar.innerHTML = '';
    const dateLbl = document.createElement('div');
    dateLbl.style.cssText = 'display:flex;align-items:center;gap:8px';
    dateLbl.innerHTML = `<span style="font-weight:800;font-size:13px;font-family:var(--font-mono)">${dayNames[d.getDay()]}, ${mNames[d.getMonth()]} ${d.getDate()}</span>
      ${isSelToday ? '<span style="background:rgba(0,255,136,.15);border:1px solid rgba(0,255,136,.3);border-radius:10px;padding:1px 8px;font-size:10px;color:var(--accent)">Today</span>' : ''}`;
    const addBtn = document.createElement('button');
    addBtn.innerHTML = 'Ôºã Add Time Block';
    addBtn.style.cssText = 'padding:5px 12px;border-radius:8px;border:1px solid rgba(0,255,136,.35);background:rgba(0,255,136,.08);color:var(--accent);font-size:11px;font-family:var(--font-mono);font-weight:700;cursor:pointer;transition:all .12s;flex-shrink:0';
    addBtn.addEventListener('click', () => openAddBlockForDate(_calSelectedISO));
    selBar.appendChild(dateLbl);
    selBar.appendChild(addBtn);

    subContent.innerHTML = '';
    const allSc = S.config?.schedule || [];
    const nowTime = new Date();

    if (_calSubTab === 'blocks') {
      // Blocks: one-time (once) + bounded-daily + custom-date entries active on this day
      const blocks = allSc.filter(item => {
        const r = item.repeat || 'daily';
        if (item.limitFrom && _calSelectedISO < item.limitFrom) return false;
        if (item.limitTo && _calSelectedISO > item.limitTo) return false;
        if (r === 'once') return item.createdOn === _calSelectedISO;
        if (r === 'custom') return (item.customDates || []).includes(_calSelectedISO);
        // Daily but bounded by dates = a block sprint
        if (r === 'daily' && (item.limitFrom || item.limitTo)) return true;
        return false;
      });

      if (blocks.length === 0) {
        // Empty state with a prominent add CTA
        const empty = document.createElement('div');
        empty.className = 'cal-sub-empty';
        empty.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:12px;padding:28px 16px';
        empty.innerHTML = `<div style="font-size:28px;opacity:.4">üì≠</div>
          <div style="color:var(--muted);font-size:12px;font-family:var(--font-mono);text-align:center;line-height:1.7">No blocks scheduled for this day.<br>Tap to add a one-time task block.</div>`;
        const ctaBtn = document.createElement('button');
        ctaBtn.textContent = 'Ôºã Schedule a Time Block';
        ctaBtn.style.cssText = 'padding:10px 20px;border-radius:10px;border:1.5px solid rgba(0,255,136,.4);background:rgba(0,255,136,.08);color:var(--accent);font-size:13px;font-family:var(--font-mono);font-weight:700;cursor:pointer';
        ctaBtn.addEventListener('click', () => openAddBlockForDate(_calSelectedISO));
        empty.appendChild(ctaBtn);
        subContent.appendChild(empty);
        return;
      }

      blocks.sort((a,b) => schedDate(a.time) - schedDate(b.time));
      blocks.forEach(item => {
        const r = item.repeat || 'daily';
        const repeatLabel = { once:'One-time', custom:'Custom', daily:'Bounded daily' }[r] || r;
        let nowClass = '';
        if (isSelToday) {
          const itemTime = schedDate(item.time);
          const diffMs = nowTime - itemTime;
          const todayItems = getScheduleForDate(todayISO).sort((a,b) => schedDate(a.time) - schedDate(b.time));
          const curIdx = (() => { let c=-1; todayItems.forEach((it,ii) => { if (schedDate(it.time) <= nowTime) c=ii; }); return c; })();
          if (todayItems.indexOf(item) === curIdx) nowClass = 'now-item';
          else if (diffMs > 5000) nowClass = 'past-item';
        }
        const itemEl = document.createElement('div');
        itemEl.className = `cal-sub-item ${nowClass}`;
        itemEl.innerHTML = `
          <span class="cal-sub-time">${item.time}</span>
          <span class="cal-sub-act">${item.activity.replace(/</g,'&lt;')}</span>
          <span class="cal-sub-repeat">${repeatLabel}</span>`;
        itemEl.addEventListener('click', () => {
          const hi = detectHabit(item.activity);
          if (hi) showManualModal(hi.key);
        });
        subContent.appendChild(itemEl);
      });

    } else {
      // Recurring: weekly / monthly / yearly tasks applicable to this day
      const recurring = allSc.filter(item => {
        const r = item.repeat || 'daily';
        if (item.limitFrom && _calSelectedISO < item.limitFrom) return false;
        if (item.limitTo && _calSelectedISO > item.limitTo) return false;
        if (r === 'weekly') {
          if (!item.createdOn) return true;
          return new Date(item.createdOn + 'T00:00:00').getDay() === d.getDay();
        }
        if (r === 'monthly') {
          if (!item.createdOn) return true;
          return new Date(item.createdOn + 'T00:00:00').getDate() === d.getDate();
        }
        if (r === 'yearly') {
          if (!item.createdOn) return true;
          const cd = new Date(item.createdOn + 'T00:00:00');
          return cd.getMonth() === d.getMonth() && cd.getDate() === d.getDate();
        }
        return false;
      });

      if (recurring.length === 0) {
        subContent.innerHTML = `<div class="cal-sub-empty" style="padding:28px 16px;text-align:center;color:var(--muted);font-size:12px;font-family:var(--font-mono);line-height:1.7">No weekly / monthly / yearly<br>tasks fall on this day.</div>`;
        return;
      }

      recurring.sort((a,b) => schedDate(a.time) - schedDate(b.time));
      recurring.forEach(item => {
        const r = item.repeat;
        const repeatLabel = { weekly:'Weekly', monthly:'Monthly', yearly:'Yearly' }[r] || r;
        let nowClass = '';
        if (isSelToday) {
          const itemTime = schedDate(item.time);
          const diffMs = nowTime - itemTime;
          const todayItems = getScheduleForDate(todayISO).sort((a,b) => schedDate(a.time) - schedDate(b.time));
          const curIdx = (() => { let c=-1; todayItems.forEach((it,ii) => { if (schedDate(it.time) <= nowTime) c=ii; }); return c; })();
          if (todayItems.indexOf(item) === curIdx) nowClass = 'now-item';
          else if (diffMs > 5000) nowClass = 'past-item';
        }
        const itemEl = document.createElement('div');
        itemEl.className = `cal-sub-item ${nowClass}`;
        itemEl.innerHTML = `
          <span class="cal-sub-time">${item.time}</span>
          <span class="cal-sub-act">${item.activity.replace(/</g,'&lt;')}</span>
          <span class="cal-sub-repeat">${repeatLabel}</span>`;
        itemEl.addEventListener('click', () => {
          const hi = detectHabit(item.activity);
          if (hi) showManualModal(hi.key);
        });
        subContent.appendChild(itemEl);
      });
    }
  }

  buildGrid();
  buildSubContent();
  wrap.appendChild(bottom);
  container.appendChild(wrap);
}

// ‚îÄ‚îÄ TIME DRUM PICKER HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildTimeDrum(containerId, initialTime) {
  const hours   = ['12','1','2','3','4','5','6','7','8','9','10','11'];
  const minutes = Array.from({length:60}, (_,i) => String(i).padStart(2,'0'));
  const ampm    = ['AM','PM'];

  // Parse initial time
  let initH = 6, initM = 0, initAP = 0;
  if (initialTime) {
    const m = initialTime.match(/(\d+):(\d+)\s*(AM|PM)/i);
    if (m) {
      initH  = parseInt(m[1]) % 12;
      initM  = Math.round(parseInt(m[2]) / 5);
      initAP = m[3].toUpperCase() === 'PM' ? 1 : 0;
    }
  }

  const container = document.getElementById(containerId);
  if (!container) return null;

  function makeDrum(items, initIdx, extraClass, loop) {
    const col = document.createElement('div');
    col.className = 'time-drum-col';
    const drum = document.createElement('div');
    drum.className = 'time-drum' + (extraClass ? ' ' + extraClass : '');
    const inner = document.createElement('div');
    inner.className = 'time-drum-inner';
    const highlight = document.createElement('div');
    highlight.className = 'time-drum-highlight';
    drum.appendChild(highlight);
    drum.appendChild(inner);
    col.appendChild(drum);

    const ITEM_H = 44;
    const DRUM_H = 140;
    const VISIBLE = Math.floor(DRUM_H / ITEM_H);
    const PAD = Math.floor(VISIBLE / 2);

    // For looping drums, render 3x the items so drag feels infinite
    const renderItems = loop ? [...items, ...items, ...items] : items;
    const offset = loop ? items.length : 0; // center copy starts here

    for (let p = 0; p < PAD; p++) {
      const pad = document.createElement('div'); pad.className = 'time-drum-item'; inner.appendChild(pad);
    }
    renderItems.forEach(val => {
      const item = document.createElement('div');
      item.className = 'time-drum-item';
      item.textContent = val;
      inner.appendChild(item);
    });
    for (let p = 0; p < PAD; p++) {
      const pad = document.createElement('div'); pad.className = 'time-drum-item'; inner.appendChild(pad);
    }

    let selected = Math.max(0, Math.min(items.length - 1, initIdx));
    let startY = 0, isDragging = false;

    function getRenderIdx() { return loop ? offset + selected : selected; }
    function getTranslateY() { return -getRenderIdx() * ITEM_H; }

    function render(animate) {
      inner.style.transition = animate ? 'transform .2s cubic-bezier(.25,.8,.25,1)' : 'none';
      inner.style.transform = `translateY(${getTranslateY()}px)`;
      inner.querySelectorAll('.time-drum-item').forEach((el, i) => {
        el.classList.toggle('selected', i === PAD + getRenderIdx());
      });
    }

    function moveTo(n) {
      if (loop) {
        selected = ((n % items.length) + items.length) % items.length;
      } else {
        selected = Math.max(0, Math.min(items.length - 1, n));
      }
      render(true);
    }

    drum.addEventListener('pointerdown', e => {
      isDragging = true; startY = e.clientY;
      inner.style.transition = 'none';
      drum.setPointerCapture(e.pointerId);
    });
    drum.addEventListener('pointermove', e => {
      if (!isDragging) return;
      inner.style.transform = `translateY(${getTranslateY() + (e.clientY - startY)}px)`;
    });
    drum.addEventListener('pointerup', e => {
      if (!isDragging) return;
      isDragging = false;
      moveTo(selected - Math.round((e.clientY - startY) / ITEM_H));
    });
    drum.addEventListener('wheel', e => {
      e.preventDefault();
      moveTo(selected + (e.deltaY > 0 ? 1 : -1));
    }, { passive: false });

    render(false);
    return { drum: col, getSelected: () => items[selected] };
  }

  const hDrum  = makeDrum(hours,   initH,  '', true);
  const mDrum  = makeDrum(minutes, initM,  '', true);
  const apDrum = makeDrum(ampm,    initAP, 'ampm-drum', false);

  const colon = document.createElement('div');
  colon.className = 'time-colon';
  colon.textContent = ':';

  container.innerHTML = '';
  container.className = 'time-picker-wrap';
  container.appendChild(hDrum.drum);
  container.appendChild(colon);
  container.appendChild(mDrum.drum);
  container.appendChild(apDrum.drum);

  return {
    getTime: () => `${hDrum.getSelected()}:${mDrum.getSelected()} ${apDrum.getSelected()}`
  };
}

// ‚îÄ‚îÄ SHARED SCHEDULE POPUP (Edit only ‚Äî Add has its own flow) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showSchedulePopup(title, initialTime, initialActivity, saveLabel, onSave, initialRepeat) {
  const repeatOpts = [
    { val: 'daily',   label: 'üîÅ Daily' },
    { val: 'weekly',  label: 'üìÖ Weekly' },
    { val: 'monthly', label: 'üóì Monthly' },
    { val: 'yearly',  label: 'üìÜ Yearly' },
    { val: 'off',     label: '‚è∏ One-time' },
  ];
  const curRepeat = (initialRepeat === 'once') ? 'off' : (initialRepeat || 'daily');
  const ov = document.createElement('div');
  ov.className = 'sched-edit-popup';
  ov.innerHTML = `<div class="sched-edit-sheet">
    <div class="modal-handle"></div>
    <div style="font-size:16px;font-weight:800;margin-bottom:12px">${title}</div>
    <div style="font-size:11px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Time</div>
    <div id="time-drum-root"></div>
    <div style="font-size:11px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;margin-top:16px">Activity</div>
    <input type="text" id="sp-act" placeholder="Activity description" autocomplete="off" style="margin-bottom:12px"/>
    <div style="font-size:11px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Repeat</div>
    <select id="sp-repeat-sel" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-family:var(--font-mono);font-size:14px;outline:none;margin-bottom:16px;cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url('data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'12\\' height=\\'12\\' viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'%23555570\\' stroke-width=\\'2\\'%3E%3Cpolyline points=\\'6 9 12 15 18 9\\'%3E%3C/polyline%3E%3C/svg%3E');background-repeat:no-repeat;background-position:right 14px center;box-sizing:border-box">
      ${repeatOpts.map(o => `<option value="${o.val}"${curRepeat===o.val?' selected':''}>${o.label}</option>`).join('')}
    </select>
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost" id="sp-cancel" style="flex:1">Cancel</button>
      <button class="btn btn-green" id="sp-save" style="flex:2">${saveLabel}</button>
    </div>
  </div>`;
  document.body.appendChild(ov);

  const drum = buildTimeDrum('time-drum-root', initialTime);
  const actIn = ov.querySelector('#sp-act');
  // Set value after DOM is ready (not via html attribute to avoid encoding issues)
  actIn.value = initialActivity || '';
  setTimeout(() => actIn.focus(), 150);

  let selectedRepeat = curRepeat;
  const repSel = ov.querySelector('#sp-repeat-sel');
  repSel.addEventListener('change', () => { selectedRepeat = repSel.value; });

  const close = () => document.body.removeChild(ov);
  ov.addEventListener('click', e => { if (e.target === ov) close(); });
  ov.querySelector('#sp-cancel').addEventListener('click', close);
  ov.querySelector('#sp-save').addEventListener('click', () => {
    const t = drum ? drum.getTime() : actIn.value.trim();
    const a = actIn.value.trim();
    if (!a) { showToast('Enter an activity'); return; }
    close();
    onSave(t, a, selectedRepeat);
  });
  actIn.addEventListener('keydown', e => { if (e.key === 'Enter') ov.querySelector('#sp-save').click(); });
}

// ‚îÄ‚îÄ MINI CALENDAR UI HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Returns an object { el, getSelected, setRange }
function buildMiniCalendar(opts = {}) {
  const { rangeFrom = null, rangeTo = null, selected = [] } = opts;
  const wrap = document.createElement('div');
  wrap.style.cssText = 'background:var(--bg3);border:1px solid var(--border);border-radius:14px;padding:14px;user-select:none';

  let viewYear, viewMonth;
  const selSet = new Set(selected);

  const todayISO = new Date().toISOString().slice(0,10);
  const now = new Date();
  viewYear = now.getFullYear();
  viewMonth = now.getMonth();

  function isoDate(y, m, d) {
    return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  }

  function isInRange(iso) {
    if (rangeFrom && iso < rangeFrom) return false;
    if (rangeTo && iso > rangeTo) return false;
    return true;
  }

  function render() {
    wrap.innerHTML = '';

    // Header: prev / month+year / next
    const hdr = document.createElement('div');
    hdr.style.cssText = 'display:flex;align-items:center;justify-content:space-between;margin-bottom:12px';
    const prevBtn = document.createElement('button');
    prevBtn.textContent = '‚Äπ';
    prevBtn.style.cssText = 'background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);width:32px;height:32px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0';
    const nextBtn = document.createElement('button');
    nextBtn.textContent = '‚Ä∫';
    nextBtn.style.cssText = prevBtn.style.cssText;
    const monthLabel = document.createElement('div');
    monthLabel.style.cssText = 'font-size:14px;font-weight:700;font-family:var(--font-mono)';
    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    monthLabel.textContent = `${monthNames[viewMonth]} ${viewYear}`;
    hdr.appendChild(prevBtn);
    hdr.appendChild(monthLabel);
    hdr.appendChild(nextBtn);
    wrap.appendChild(hdr);

    prevBtn.addEventListener('click', () => {
      viewMonth--; if (viewMonth < 0) { viewMonth = 11; viewYear--; }
      render();
    });
    nextBtn.addEventListener('click', () => {
      viewMonth++; if (viewMonth > 11) { viewMonth = 0; viewYear++; }
      render();
    });

    // Day headers
    const dayHdr = document.createElement('div');
    dayHdr.style.cssText = 'display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:4px';
    ['S','M','T','W','T','F','S'].forEach(d => {
      const cell = document.createElement('div');
      cell.textContent = d;
      cell.style.cssText = 'text-align:center;font-size:10px;font-family:var(--font-mono);color:var(--muted);padding:2px 0';
      dayHdr.appendChild(cell);
    });
    wrap.appendChild(dayHdr);

    // Days grid
    const grid = document.createElement('div');
    grid.style.cssText = 'display:grid;grid-template-columns:repeat(7,1fr);gap:3px';

    const firstDay = new Date(viewYear, viewMonth, 1).getDay();
    const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();

    // Empty slots
    for (let i = 0; i < firstDay; i++) {
      const empty = document.createElement('div');
      grid.appendChild(empty);
    }

    for (let d = 1; d <= daysInMonth; d++) {
      const iso = isoDate(viewYear, viewMonth, d);
      const inRange = isInRange(iso);
      const isSel = selSet.has(iso);
      const isToday = iso === todayISO;

      const cell = document.createElement('div');
      cell.style.cssText = `
        text-align:center;padding:6px 2px;border-radius:8px;font-size:13px;font-family:var(--font-mono);font-weight:600;
        cursor:${inRange ? 'pointer' : 'default'};
        opacity:${inRange ? 1 : 0.25};
        background:${isSel ? 'rgba(0,120,255,0.35)' : (isToday ? 'rgba(0,255,136,0.08)' : 'transparent')};
        color:${isSel ? '#60aaff' : (isToday ? 'var(--accent)' : 'var(--text)')};
        border:${isSel ? '1.5px solid rgba(0,120,255,0.6)' : (isToday ? '1px solid rgba(0,255,136,0.3)' : '1px solid transparent')};
        transition:all .12s;
      `;
      cell.textContent = d;

      if (inRange) {
        cell.addEventListener('click', () => {
          if (selSet.has(iso)) selSet.delete(iso);
          else selSet.add(iso);
          render();
        });
      }
      grid.appendChild(cell);
    }
    wrap.appendChild(grid);

    // Selected count
    const cnt = document.createElement('div');
    cnt.style.cssText = 'margin-top:10px;font-size:11px;font-family:var(--font-mono);color:var(--muted);text-align:center';
    cnt.textContent = selSet.size > 0 ? `${selSet.size} date${selSet.size>1?'s':''} selected` : 'Tap dates to select';
    wrap.appendChild(cnt);
  }

  render();

  return {
    el: wrap,
    getSelected: () => Array.from(selSet).sort(),
  };
}

// ‚îÄ‚îÄ MINI DATE PICKER (single date, inline) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildSingleDatePicker(initialISO) {
  const wrap = document.createElement('div');
  wrap.style.cssText = 'background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:12px;user-select:none;';

  let viewYear, viewMonth, selected;
  const todayISO = new Date().toISOString().slice(0,10);
  const init = initialISO || todayISO;
  selected = init;
  viewYear = parseInt(init.slice(0,4));
  viewMonth = parseInt(init.slice(5,7)) - 1;

  function isoDate(y, m, d) {
    return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  }

  function render() {
    wrap.innerHTML = '';
    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    const hdr = document.createElement('div');
    hdr.style.cssText = 'display:flex;align-items:center;justify-content:space-between;margin-bottom:10px';
    const prevBtn = document.createElement('button');
    prevBtn.innerHTML = '‚Äπ';
    prevBtn.style.cssText = 'background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text);width:28px;height:28px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;flex-shrink:0';
    const nextBtn = document.createElement('button');
    nextBtn.innerHTML = '‚Ä∫';
    nextBtn.style.cssText = prevBtn.style.cssText;
    const lbl = document.createElement('div');
    lbl.style.cssText = 'font-size:13px;font-weight:700;font-family:var(--font-mono)';
    lbl.textContent = `${monthNames[viewMonth]} ${viewYear}`;
    hdr.appendChild(prevBtn);
    hdr.appendChild(lbl);
    hdr.appendChild(nextBtn);
    wrap.appendChild(hdr);

    prevBtn.addEventListener('click', () => { viewMonth--; if (viewMonth<0){viewMonth=11;viewYear--;} render(); });
    nextBtn.addEventListener('click', () => { viewMonth++; if (viewMonth>11){viewMonth=0;viewYear++;} render(); });

    const dayHdr = document.createElement('div');
    dayHdr.style.cssText = 'display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:2px';
    ['S','M','T','W','T','F','S'].forEach(d => {
      const c = document.createElement('div');
      c.textContent = d;
      c.style.cssText = 'text-align:center;font-size:9px;font-family:var(--font-mono);color:var(--muted)';
      dayHdr.appendChild(c);
    });
    wrap.appendChild(dayHdr);

    const grid = document.createElement('div');
    grid.style.cssText = 'display:grid;grid-template-columns:repeat(7,1fr);gap:2px';
    const firstDay = new Date(viewYear, viewMonth, 1).getDay();
    const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();
    for (let i=0;i<firstDay;i++) grid.appendChild(document.createElement('div'));
    for (let d=1;d<=daysInMonth;d++) {
      const iso = isoDate(viewYear, viewMonth, d);
      const isSel = iso === selected;
      const cell = document.createElement('div');
      cell.textContent = d;
      cell.style.cssText = `text-align:center;padding:5px 1px;border-radius:6px;font-size:12px;font-family:var(--font-mono);font-weight:600;cursor:pointer;background:${isSel?'var(--accent)':'transparent'};color:${isSel?'var(--bg)':'var(--text)'};transition:all .1s`;
      cell.addEventListener('click', () => { selected = iso; render(); });
      grid.appendChild(cell);
    }
    wrap.appendChild(grid);
  }

  render();
  return { el: wrap, getSelected: () => selected };
}

// ‚îÄ‚îÄ ADD BLOCK FOR A SPECIFIC CALENDAR DATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Simplified sheet: pre-seeds the given date as a one-time block.
// User picks time + activity only. Repeat can be changed if desired.
function showAddScheduleSheetForDate(isoDate, onDone) {
  const ov = document.createElement('div');
  ov.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(6px);animation:fadeIn .2s ease';

  const sheet = document.createElement('div');
  sheet.style.cssText = 'background:var(--bg2);border-radius:20px 20px 0 0;padding:20px 20px calc(24px + env(safe-area-inset-bottom,0px));width:100%;max-width:480px;max-height:88dvh;overflow-y:auto;animation:slideUp .3s cubic-bezier(.34,1.56,.64,1)';
  ov.appendChild(sheet);

  // Format display date
  const d = new Date(isoDate + 'T00:00:00');
  const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const mNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const todayISO = new Date().toISOString().slice(0,10);
  const isToday = isoDate === todayISO;
  const dateLabel = isToday ? 'Today' : `${dayNames[d.getDay()]}, ${mNames[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;

  // Repeat options (once pre-selected)
  let selectedRepeat = 'once';

  sheet.innerHTML = `
    <div style="width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 18px"></div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:18px">
      <div style="flex:1">
        <div style="font-size:18px;font-weight:800;letter-spacing:-.3px">Add Time Block</div>
        <div style="font-size:11px;font-family:var(--font-mono);color:var(--accent);margin-top:2px">üìÖ ${dateLabel}</div>
      </div>
    </div>
    <div style="font-size:10px;font-family:var(--font-mono);color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">Activity</div>
    <input id="asfd-act" type="text" placeholder="What's this block?" autocomplete="off"
      style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:13px 14px;color:var(--text);font-size:14px;font-family:var(--font-display);outline:none;margin-bottom:16px;transition:border-color .15s;box-sizing:border-box"/>
    <div style="font-size:10px;font-family:var(--font-mono);color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">Time</div>
    <div id="asfd-drum-root" style="margin-bottom:16px"></div>
    <div style="font-size:10px;font-family:var(--font-mono);color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">Repeat</div>
    <select id="asfd-repeat-sel" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-family:var(--font-mono);font-size:14px;outline:none;margin-bottom:20px;cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'12\' height=\'12\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%23555570\' stroke-width=\'2\'%3E%3Cpolyline points=\'6 9 12 15 18 9\'%3E%3C/polyline%3E%3C/svg%3E');background-repeat:no-repeat;background-position:right 14px center;box-sizing:border-box">
      <option value="once" selected>1Ô∏è‚É£ One-time</option>
      <option value="weekly">üìÖ Weekly</option>
      <option value="monthly">üóì Monthly</option>
      <option value="daily">üîÅ Daily</option>
      <option value="custom">üìÜ Custom Dates</option>
    </select>
    <div style="display:flex;gap:10px">
      <button id="asfd-cancel" class="btn btn-ghost" style="flex:1">Cancel</button>
      <button id="asfd-add" class="btn btn-green" style="flex:2">Ôºã Add Time Block</button>
    </div>`;

  document.body.appendChild(ov);

  // Wire activity input styling
  const actIn = sheet.querySelector('#asfd-act');
  actIn.addEventListener('focus', () => actIn.style.borderColor = 'var(--accent)');
  actIn.addEventListener('blur',  () => actIn.style.borderColor = 'var(--border)');
  setTimeout(() => actIn.focus(), 200);

  // Build time drum
  const drumInst = buildTimeDrumEl(sheet.querySelector('#asfd-drum-root'), '9:00 AM');

  // Wire repeat dropdown
  sheet.querySelector('#asfd-repeat-sel').addEventListener('change', e => { selectedRepeat = e.target.value; });

  const close = () => document.body.removeChild(ov);
  ov.addEventListener('click', e => { if (e.target === ov) close(); });
  sheet.querySelector('#asfd-cancel').addEventListener('click', close);

  sheet.querySelector('#asfd-add').addEventListener('click', () => {
    const activity = actIn.value.trim();
    if (!activity) { showToast('Enter an activity'); actIn.focus(); return; }

    if (!S.config) S.config = { schedule: [], habitDefinitions: {}, habitTracker: { enabled: true, snoozeOptions: [5, 10] } };
    if (!S.config.schedule) S.config.schedule = [];

    const time = drumInst ? drumInst.getTime() : '9:00 AM';
    const newItem = {
      activity,
      time,
      repeat: selectedRepeat,
      createdOn: isoDate,
    };
    // For 'once', createdOn is the target date (already set above)
    // For custom, fall back to the add-schedule sheet for multi-date selection
    if (selectedRepeat === 'custom') {
      close();
      showAddScheduleSheet(() => { if (onDone) onDone(); });
      return;
    }
    S.config.schedule.push(newItem);
    try { S.config.schedule.sort((a, b) => schedDate(a.time) - schedDate(b.time)); } catch {}
    LS.set('lastConfig', S.config);
    saveScheduleToVault();
    forceSwUpdate();
    close();
    showToast('‚úì Time Block added');
    if (onDone) onDone();
  });

  actIn.addEventListener('keydown', e => { if (e.key === 'Enter') sheet.querySelector('#asfd-add').click(); });
}

// ‚îÄ‚îÄ ADD SCHEDULE ENTRY ‚Äî NEW COMPREHENSIVE FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAddScheduleSheet(onDone) {
  const today = new Date().toISOString().slice(0,10);
  const ov = document.createElement('div');
  ov.className = 'sched-edit-popup';
  ov.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(6px);animation:fadeIn .2s ease';

  // State
  let blockType = 'routine'; // 'routine' | 'scheduled' | 'open'
  let schedType = 'unlimited'; // 'unlimited' | 'limited'
  let repeatMode = 'daily'; // 'off','daily','weekly','monthly','custom'
  let limitFromISO = today;
  let limitToISO = '';
  let customDates = [];
  let perDateMode = 'same'; // 'same' | 'different'
  let savedActivity = ''; // preserve activity across rebuilds

  // Calendar pickers (built lazily)
  let fromPicker = null, toPicker = null, customCal = null;
  let sharedDrumInst = null;
  let perDateTimes = {}; // date -> time string

  function build() {
    const currentActVal = savedActivity;
    ov.innerHTML = '';
    const sheet = document.createElement('div');
    sheet.className = 'sched-edit-sheet';
    sheet.style.cssText = 'background:var(--bg2);border-radius:20px 20px 0 0;padding:20px 20px calc(20px + env(safe-area-inset-bottom,0px));width:100%;max-width:480px;max-height:92dvh;overflow-y:auto;';
    ov.appendChild(sheet);

    // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
    sheet.innerHTML = `<div class="modal-handle"></div>
      <div style="font-size:18px;font-weight:800;margin-bottom:18px">Add Time Block</div>`;

    // ‚îÄ‚îÄ Block Type ‚îÄ‚îÄ
    const blockTypeLabel = document.createElement('div');
    blockTypeLabel.style.cssText = 'font-size:11px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px';
    blockTypeLabel.textContent = 'Block Type';
    sheet.appendChild(blockTypeLabel);

    const blockTypeDefs = [
      { val: 'routine',   emoji: 'üîÑ', label: 'Routine',   desc: 'Daily habits & chores. Cannot carry over.' },
      { val: 'scheduled', emoji: 'üìå', label: 'Scheduled',  desc: 'Fixed-time events & appointments.' },
      { val: 'open',      emoji: 'üåÄ', label: 'Open',        desc: 'Hobbies & projects. Specify duration, not time.' },
    ];
    const blockTypeRow = document.createElement('div');
    blockTypeRow.style.cssText = 'display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px';
    blockTypeDefs.forEach(bt => {
      const btn = document.createElement('button');
      const active = blockType === bt.val;
      btn.style.cssText = `padding:10px 6px;border-radius:12px;border:1.5px solid ${active?'var(--accent)':'var(--border)'};background:${active?'rgba(0,255,136,.1)':'var(--bg3)'};color:${active?'var(--accent)':'var(--muted)'};font-size:11px;font-weight:700;cursor:pointer;font-family:var(--font-display);transition:all .15s;display:flex;flex-direction:column;align-items:center;gap:3px;`;
      btn.innerHTML = `<span style="font-size:20px">${bt.emoji}</span><span>${bt.label}</span>`;
      btn.title = bt.desc;
      btn.addEventListener('click', () => { blockType = bt.val; savedActivity = sheet.querySelector('#add-act-input')?.value || currentActVal; build(); });
      blockTypeRow.appendChild(btn);
    });
    sheet.appendChild(blockTypeRow);

    // Block type description
    const btDesc = blockTypeDefs.find(b=>b.val===blockType);
    const descEl = document.createElement('div');
    descEl.style.cssText = 'font-size:11px;font-family:var(--font-mono);color:var(--muted);background:var(--bg3);border-radius:8px;padding:8px 12px;margin-bottom:16px;line-height:1.5';
    descEl.textContent = btDesc?.desc || '';
    sheet.appendChild(descEl);

    // ‚îÄ‚îÄ Activity ‚îÄ‚îÄ
    const actLabel = document.createElement('div');
    actLabel.style.cssText = 'font-size:11px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px';
    actLabel.textContent = 'Activity';
    sheet.appendChild(actLabel);

    const actInput = document.createElement('input');
    actInput.id = 'add-act-input';
    actInput.type = 'text';
    actInput.placeholder = blockType === 'open' ? 'What hobby or project?' : blockType === 'routine' ? 'e.g. Drink water, Morning stretch‚Ä¶' : 'e.g. Doctor appointment‚Ä¶';
    actInput.autocomplete = 'off';
    actInput.value = currentActVal;
    actInput.style.cssText = 'width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:13px 14px;color:var(--text);font-family:var(--font-display);font-size:14px;outline:none;margin-bottom:16px;transition:border-color .15s;box-sizing:border-box';
    actInput.addEventListener('focus', () => actInput.style.borderColor = 'var(--accent)');
    actInput.addEventListener('blur', () => actInput.style.borderColor = 'var(--border)');
    actInput.addEventListener('input', () => { savedActivity = actInput.value; });
    sheet.appendChild(actInput);
    // Focus only on first build
    if (!currentActVal) setTimeout(() => actInput.focus(), 150);

    // ‚îÄ‚îÄ Duration (Open blocks only) ‚îÄ‚îÄ
    if (blockType === 'open') {
      const durLabel = document.createElement('div');
      durLabel.style.cssText = 'font-size:11px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px';
      durLabel.textContent = 'Estimated Duration';
      sheet.appendChild(durLabel);
      const durRow = document.createElement('div');
      durRow.style.cssText = 'display:flex;gap:8px;margin-bottom:16px;align-items:center';
      const durInput = document.createElement('input');
      durInput.id = 'add-dur-input';
      durInput.type = 'number';
      durInput.min = '5'; durInput.max = '480'; durInput.step = '5';
      durInput.placeholder = '30';
      durInput.value = '30';
      durInput.style.cssText = 'flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-family:var(--font-mono);font-size:16px;outline:none;transition:border-color .15s;box-sizing:border-box';
      const durUnit = document.createElement('div');
      durUnit.style.cssText = 'font-size:13px;color:var(--muted);font-family:var(--font-mono);flex-shrink:0';
      durUnit.textContent = 'minutes';
      durRow.appendChild(durInput);
      durRow.appendChild(durUnit);
      sheet.appendChild(durRow);
      // Carryover note
      const carryNote = document.createElement('div');
      carryNote.style.cssText = 'font-size:11px;font-family:var(--font-mono);color:rgba(0,255,136,.6);background:rgba(0,255,136,.06);border:1px solid rgba(0,255,136,.15);border-radius:8px;padding:8px 12px;margin-bottom:16px';
      carryNote.textContent = 'üåÄ Open blocks can carry over to the next day if not completed.';
      sheet.appendChild(carryNote);
    }

    // ‚îÄ‚îÄ Schedule Type (only for Routine and Scheduled) ‚îÄ‚îÄ
    if (blockType !== 'open') {
      const typeLabel = document.createElement('div');
      typeLabel.style.cssText = 'font-size:11px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px';
      typeLabel.textContent = 'Date Range';
      sheet.appendChild(typeLabel);

      const typeRow = document.createElement('div');
      typeRow.style.cssText = 'display:flex;gap:8px;margin-bottom:16px';
      ['unlimited','limited'].forEach(t => {
        const btn = document.createElement('button');
        btn.textContent = t === 'unlimited' ? '‚àû Unlimited' : 'üìÖ Limited';
        btn.style.cssText = `flex:1;padding:10px;border-radius:10px;border:1.5px solid ${schedType===t?'var(--accent)':'var(--border)'};background:${schedType===t?'rgba(0,255,136,.1)':'var(--bg3)'};color:${schedType===t?'var(--accent)':'var(--muted)'};font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font-display);transition:all .15s`;
        btn.addEventListener('click', () => { savedActivity = actInput.value; schedType = t; build(); });
        typeRow.appendChild(btn);
      });
      sheet.appendChild(typeRow);

      // ‚îÄ‚îÄ Date Range (if Limited) ‚îÄ‚îÄ
      if (schedType === 'limited') {
        const drRow = document.createElement('div');
        drRow.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px';

        const fromWrap = document.createElement('div');
        const fromLbl2 = document.createElement('div');
        fromLbl2.style.cssText = 'font-size:10px;font-family:var(--font-mono);color:var(--muted);margin-bottom:4px';
        fromLbl2.textContent = 'From';
        const fromBtn = document.createElement('button');
        fromBtn.textContent = limitFromISO || 'Set Date';
        fromBtn.style.cssText = 'width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-family:var(--font-mono);font-size:12px;cursor:pointer;text-align:left;font-weight:600';
        fromWrap.appendChild(fromLbl2); fromWrap.appendChild(fromBtn);

        const toWrap = document.createElement('div');
        const toLbl2 = document.createElement('div');
        toLbl2.style.cssText = fromLbl2.style.cssText; toLbl2.textContent = 'To';
        const toBtn = document.createElement('button');
        toBtn.textContent = limitToISO || 'Set Date';
        toBtn.style.cssText = fromBtn.style.cssText;
        toWrap.appendChild(toLbl2); toWrap.appendChild(toBtn);

        drRow.appendChild(fromWrap); drRow.appendChild(toWrap);
        sheet.appendChild(drRow);

        const fromCalWrap = document.createElement('div');
        fromCalWrap.style.cssText = 'margin-bottom:10px;display:none';
        sheet.appendChild(fromCalWrap);
        const toCalWrap = document.createElement('div');
        toCalWrap.style.cssText = 'margin-bottom:10px;display:none';
        sheet.appendChild(toCalWrap);

        fromBtn.addEventListener('click', () => {
          if (fromCalWrap.style.display !== 'none') { fromCalWrap.style.display = 'none'; return; }
          toCalWrap.style.display = 'none';
          fromCalWrap.innerHTML = '';
          fromPicker = buildSingleDatePicker(limitFromISO);
          fromCalWrap.appendChild(fromPicker.el);
          const okBtn = document.createElement('button');
          okBtn.textContent = 'OK';
          okBtn.style.cssText = 'margin-top:8px;width:100%;padding:10px;border-radius:10px;background:var(--accent);color:var(--bg);font-weight:700;border:none;cursor:pointer;font-family:var(--font-display);font-size:14px';
          okBtn.addEventListener('click', () => { limitFromISO = fromPicker.getSelected(); fromBtn.textContent = limitFromISO; fromCalWrap.style.display = 'none'; });
          fromCalWrap.appendChild(okBtn);
          fromCalWrap.style.display = 'block';
          fromCalWrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
        toBtn.addEventListener('click', () => {
          if (toCalWrap.style.display !== 'none') { toCalWrap.style.display = 'none'; return; }
          fromCalWrap.style.display = 'none';
          toCalWrap.innerHTML = '';
          toPicker = buildSingleDatePicker(limitToISO || limitFromISO);
          toCalWrap.appendChild(toPicker.el);
          const okBtn = document.createElement('button');
          okBtn.textContent = 'OK';
          okBtn.style.cssText = 'margin-top:8px;width:100%;padding:10px;border-radius:10px;background:var(--accent);color:var(--bg);font-weight:700;border:none;cursor:pointer;font-family:var(--font-display);font-size:14px';
          okBtn.addEventListener('click', () => { limitToISO = toPicker.getSelected(); toBtn.textContent = limitToISO; toCalWrap.style.display = 'none'; });
          toCalWrap.appendChild(okBtn);
          toCalWrap.style.display = 'block';
          toCalWrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
      }
    }

    // ‚îÄ‚îÄ Repeat (dropdown) ‚îÄ‚îÄ
    const repLabel = document.createElement('div');
    repLabel.style.cssText = 'font-size:11px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px';
    repLabel.textContent = 'Repeat';
    sheet.appendChild(repLabel);

    // For routine blocks, no "off" option; for open blocks limited options
    let repeatOpts;
    if (blockType === 'routine') {
      repeatOpts = [
        { val:'daily',   label:'üîÅ Daily' },
        { val:'weekly',  label:'üìÖ Weekly' },
        { val:'monthly', label:'üóì Monthly' },
      ];
      if (!['daily','weekly','monthly'].includes(repeatMode)) repeatMode = 'daily';
    } else if (blockType === 'open') {
      repeatOpts = [
        { val:'off',     label:'‚è∏ One-time' },
        { val:'daily',   label:'üîÅ Daily' },
        { val:'weekly',  label:'üìÖ Weekly' },
        { val:'custom',  label:'üóÇ Custom Dates' },
      ];
    } else {
      repeatOpts = [
        { val:'off',     label:'‚è∏ One-time' },
        { val:'daily',   label:'üîÅ Daily' },
        { val:'weekly',  label:'üìÖ Weekly' },
        { val:'monthly', label:'üóì Monthly' },
        { val:'custom',  label:'üóÇ Custom Dates' },
      ];
    }

    const repSelect = document.createElement('select');
    repSelect.style.cssText = 'width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-family:var(--font-mono);font-size:14px;outline:none;margin-bottom:12px;cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'12\' height=\'12\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%23555570\' stroke-width=\'2\'%3E%3Cpolyline points=\'6 9 12 15 18 9\'%3E%3C/polyline%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;box-sizing:border-box';
    repeatOpts.forEach(o => {
      const opt = document.createElement('option');
      opt.value = o.val; opt.textContent = o.label;
      if (repeatMode === o.val) opt.selected = true;
      repSelect.appendChild(opt);
    });
    repSelect.addEventListener('change', () => { savedActivity = actInput.value; repeatMode = repSelect.value; build(); });
    sheet.appendChild(repSelect);

    // ‚îÄ‚îÄ Custom Date Picker ‚îÄ‚îÄ
    const customCalWrap = document.createElement('div');
    customCalWrap.style.cssText = 'margin-bottom:14px;' + (repeatMode === 'custom' ? '' : 'display:none');
    sheet.appendChild(customCalWrap);

    if (repeatMode === 'custom') {
      const setDatesBtn = document.createElement('button');
      setDatesBtn.textContent = customDates.length ? `üìÖ ${customDates.length} date${customDates.length>1?'s':''} selected ‚Äî tap to change` : 'üìÖ Set Dates';
      setDatesBtn.style.cssText = 'width:100%;padding:11px 14px;border-radius:10px;border:1px solid rgba(0,120,255,0.4);background:rgba(0,120,255,0.08);color:#60aaff;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font-display);margin-bottom:8px;transition:all .15s';
      customCalWrap.appendChild(setDatesBtn);

      const datesPreview = document.createElement('div');
      datesPreview.style.cssText = 'font-size:11px;font-family:var(--font-mono);color:var(--muted);line-height:1.6;min-height:16px;margin-bottom:8px;word-break:break-all';
      datesPreview.textContent = customDates.length ? customDates.join(', ') : '';
      customCalWrap.appendChild(datesPreview);

      const calContainer = document.createElement('div');
      calContainer.style.display = 'none';
      customCalWrap.appendChild(calContainer);

      setDatesBtn.addEventListener('click', () => {
        if (calContainer.style.display !== 'none') { calContainer.style.display = 'none'; return; }
        calContainer.innerHTML = '';
        const rangeFrom = schedType === 'limited' ? limitFromISO : null;
        const rangeTo = schedType === 'limited' ? limitToISO : null;
        customCal = buildMiniCalendar({ rangeFrom, rangeTo, selected: customDates });
        calContainer.appendChild(customCal.el);
        const okBtn = document.createElement('button');
        okBtn.textContent = '‚úì OK';
        okBtn.style.cssText = 'margin-top:10px;width:100%;padding:11px;border-radius:10px;background:var(--accent);color:var(--bg);font-weight:800;border:none;cursor:pointer;font-family:var(--font-display);font-size:14px';
        okBtn.addEventListener('click', () => {
          customDates = customCal.getSelected();
          datesPreview.textContent = customDates.length ? customDates.join(', ') : '';
          setDatesBtn.textContent = customDates.length ? `üìÖ ${customDates.length} date${customDates.length>1?'s':''} selected ‚Äî tap to change` : 'üìÖ Set Dates';
          calContainer.style.display = 'none';
          buildTimeSection();
        });
        calContainer.appendChild(okBtn);
        calContainer.style.display = 'block';
        calContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
    }

    // ‚îÄ‚îÄ Time Section (skip for Open blocks) ‚îÄ‚îÄ
    const timeSectionWrap = document.createElement('div');
    sheet.appendChild(timeSectionWrap);

    function buildTimeSection() {
      timeSectionWrap.innerHTML = '';

      // Open blocks don't have a specific time
      if (blockType === 'open') return;

      const timeLabel = document.createElement('div');
      timeLabel.style.cssText = 'font-size:11px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;margin-top:4px';
      timeLabel.textContent = 'Time';
      timeSectionWrap.appendChild(timeLabel);

      if (repeatMode === 'custom' && customDates.length > 1) {
        // Mode selector: same vs different
        const modeRow = document.createElement('div');
        modeRow.style.cssText = 'display:flex;gap:8px;margin-bottom:12px';
        ['same','different'].forEach(m => {
          const btn = document.createElement('button');
          btn.textContent = m === 'same' ? '‚è± Same time' : '‚è± Different times';
          btn.style.cssText = `flex:1;padding:9px;border-radius:10px;border:1.5px solid ${perDateMode===m?'var(--accent)':'var(--border)'};background:${perDateMode===m?'rgba(0,255,136,.1)':'var(--bg3)'};color:${perDateMode===m?'var(--accent)':'var(--muted)'};font-size:12px;font-weight:700;cursor:pointer;font-family:var(--font-display);transition:all .15s`;
          btn.addEventListener('click', () => { perDateMode = m; buildTimeSection(); });
          modeRow.appendChild(btn);
        });
        timeSectionWrap.appendChild(modeRow);

        if (perDateMode === 'same') {
          const drumWrap = document.createElement('div');
          drumWrap.id = 'time-drum-root-shared';
          timeSectionWrap.appendChild(drumWrap);
          requestAnimationFrame(() => { sharedDrumInst = buildTimeDrumEl(drumWrap, '6:00 AM'); });
        } else {
          // Per-date: show "Set Time" button for each date ‚Äî opens a popup drum
          customDates.forEach(dateISO => {
            const row = document.createElement('div');
            row.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);gap:10px';
            const dateLbl = document.createElement('div');
            dateLbl.style.cssText = 'font-size:12px;font-family:var(--font-mono);color:var(--text);font-weight:600;flex:1';
            dateLbl.textContent = dateISO;
            const timeDisplay = document.createElement('div');
            timeDisplay.style.cssText = 'font-size:12px;font-family:var(--font-mono);color:var(--accent);min-width:70px;text-align:right';
            timeDisplay.textContent = perDateTimes[dateISO] || '‚Äî';
            const setTimeBtn = document.createElement('button');
            setTimeBtn.textContent = 'Set Time';
            setTimeBtn.style.cssText = 'padding:7px 14px;border-radius:8px;border:1px solid rgba(0,255,136,.35);background:rgba(0,255,136,.08);color:var(--accent);font-size:12px;font-family:var(--font-mono);font-weight:700;cursor:pointer;flex-shrink:0';
            setTimeBtn.addEventListener('click', () => {
              // Show time picker popup
              const popOv = document.createElement('div');
              popOv.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1100;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(6px)';
              const popSheet = document.createElement('div');
              popSheet.style.cssText = 'background:var(--bg2);border-radius:20px 20px 0 0;padding:20px 20px 32px;width:100%;max-width:480px;animation:slideUp .3s cubic-bezier(.34,1.56,.64,1)';
              const popHdr = document.createElement('div');
              popHdr.style.cssText = 'font-size:14px;font-weight:800;margin-bottom:4px;text-align:center';
              popHdr.textContent = `Set Time for ${dateISO}`;
              const drumRoot = document.createElement('div');
              drumRoot.style.cssText = 'margin:10px 0 16px';
              const popOk = document.createElement('button');
              popOk.className = 'btn btn-green';
              popOk.style.cssText = 'width:100%';
              popOk.textContent = '‚úì Confirm';
              popSheet.appendChild(popHdr);
              popSheet.appendChild(drumRoot);
              popSheet.appendChild(popOk);
              popOv.appendChild(popSheet);
              document.body.appendChild(popOv);
              let drumInst;
              requestAnimationFrame(() => { drumInst = buildTimeDrumEl(drumRoot, perDateTimes[dateISO] || '9:00 AM'); });
              popOv.addEventListener('click', e => { if(e.target===popOv) document.body.removeChild(popOv); });
              popOk.addEventListener('click', () => {
                const t = drumInst ? drumInst.getTime() : '9:00 AM';
                perDateTimes[dateISO] = t;
                timeDisplay.textContent = t;
                document.body.removeChild(popOv);
              });
            });
            row.appendChild(dateLbl);
            row.appendChild(timeDisplay);
            row.appendChild(setTimeBtn);
            timeSectionWrap.appendChild(row);
          });
          const helpTxt = document.createElement('div');
          helpTxt.style.cssText = 'font-size:11px;font-family:var(--font-mono);color:var(--muted);margin-top:8px';
          helpTxt.textContent = 'Tap Set Time for each date to assign a time.';
          timeSectionWrap.appendChild(helpTxt);
        }
      } else {
        const drumWrap = document.createElement('div');
        drumWrap.id = 'time-drum-root-single';
        timeSectionWrap.appendChild(drumWrap);
        requestAnimationFrame(() => { sharedDrumInst = buildTimeDrumEl(drumWrap, '6:00 AM'); });
      }
    }

    buildTimeSection();

    // ‚îÄ‚îÄ Footer Buttons ‚îÄ‚îÄ
    const footer = document.createElement('div');
    footer.style.cssText = 'display:flex;gap:10px;margin-top:20px;padding-top:12px;border-top:1px solid var(--border)';
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn btn-ghost';
    cancelBtn.style.cssText = 'flex:1';
    cancelBtn.textContent = 'Cancel';
    const addBtn = document.createElement('button');
    addBtn.className = 'btn btn-green';
    addBtn.style.cssText = 'flex:2';
    addBtn.textContent = 'Ôºã Add Time Block';
    footer.appendChild(cancelBtn);
    footer.appendChild(addBtn);
    sheet.appendChild(footer);

    const close = () => document.body.removeChild(ov);
    cancelBtn.addEventListener('click', close);
    ov.addEventListener('click', e => { if (e.target === ov) close(); });

    addBtn.addEventListener('click', () => {
      const activity = actInput.value.trim();
      if (!activity) { showToast('Enter an activity'); actInput.focus(); return; }

      if (!S.config) S.config = { schedule: [], habitDefinitions: {}, habitTracker: { enabled: true, snoozeOptions: [5, 10] } };

      const baseItem = {
        activity,
        repeat: repeatMode,
        createdOn: today,
        blockType: blockType, // store block type metadata
      };

      // Duration for open blocks (store in activity or as separate field)
      if (blockType === 'open') {
        const durVal = parseInt(sheet.querySelector('#add-dur-input')?.value) || 30;
        baseItem.duration = durVal;
        baseItem.time = '8:00 AM'; // default time for open blocks
        baseItem.canCarryOver = true;
        // No specific time enforcement for open blocks
        baseItem.time = '8:00 AM';
      }

      if (blockType !== 'open' && schedType === 'limited') {
        if (limitFromISO) baseItem.limitFrom = limitFromISO;
        if (limitToISO) baseItem.limitTo = limitToISO;
      }

      if (repeatMode === 'custom') {
        if (!customDates.length) { showToast('Select at least one date'); return; }
        baseItem.customDates = customDates;

        if (blockType !== 'open' && customDates.length > 1 && perDateMode === 'different') {
          customDates.forEach(dateISO => {
            const time = perDateTimes[dateISO] || '9:00 AM';
            S.config.schedule.push({ ...baseItem, time, createdOn: dateISO, customDates: [dateISO] });
          });
        } else {
          const time = blockType === 'open' ? '8:00 AM' : (sharedDrumInst ? sharedDrumInst.getTime() : '6:00 AM');
          baseItem.time = time;
          S.config.schedule.push(baseItem);
        }
      } else {
        const time = blockType === 'open' ? '8:00 AM' : (sharedDrumInst ? sharedDrumInst.getTime() : '6:00 AM');
        baseItem.time = time;
        S.config.schedule.push(baseItem);
      }

      try { S.config.schedule.sort((x, y) => schedDate(x.time) - schedDate(y.time)); } catch {}
      LS.set('lastConfig', S.config);
      saveScheduleToVault();
      forceSwUpdate();
      close();
      onDone();
      showToast('‚úì Time Block added');
    });
  }

  document.body.appendChild(ov);
  build();
}

// ‚îÄ‚îÄ DRUM BUILDER (by element reference, not ID) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildTimeDrumEl(container, initialTime) {
  const hours   = ['12','1','2','3','4','5','6','7','8','9','10','11'];
  const minutes = Array.from({length:60}, (_,i) => String(i).padStart(2,'0'));
  const ampm    = ['AM','PM'];

  let initH = 6, initM = 0, initAP = 0;
  if (initialTime) {
    const m = initialTime.match(/(\d+):(\d+)\s*(AM|PM)/i);
    if (m) {
      initH  = parseInt(m[1]) % 12;
      initM  = Math.round(parseInt(m[2]) / 5);
      initAP = m[3].toUpperCase() === 'PM' ? 1 : 0;
    }
  }

  function makeDrum(items, initIdx, extraClass, loop) {
    const col = document.createElement('div');
    col.className = 'time-drum-col';
    const drum = document.createElement('div');
    drum.className = 'time-drum' + (extraClass ? ' ' + extraClass : '');
    const inner = document.createElement('div');
    inner.className = 'time-drum-inner';
    const highlight = document.createElement('div');
    highlight.className = 'time-drum-highlight';
    drum.appendChild(highlight);
    drum.appendChild(inner);
    col.appendChild(drum);

    const ITEM_H = 44, DRUM_H = 140;
    const VISIBLE = Math.floor(DRUM_H / ITEM_H);
    const PAD = Math.floor(VISIBLE / 2);
    const renderItems = loop ? [...items,...items,...items] : items;
    const offset = loop ? items.length : 0;

    for (let p=0;p<PAD;p++) { const pd=document.createElement('div'); pd.className='time-drum-item'; inner.appendChild(pd); }
    renderItems.forEach(val => {
      const it=document.createElement('div'); it.className='time-drum-item'; it.textContent=val; inner.appendChild(it);
    });
    for (let p=0;p<PAD;p++) { const pd=document.createElement('div'); pd.className='time-drum-item'; inner.appendChild(pd); }

    let selected=Math.max(0,Math.min(items.length-1,initIdx));
    let startY=0,isDragging=false;
    function getRenderIdx(){ return loop?offset+selected:selected; }
    function getTranslateY(){ return -getRenderIdx()*ITEM_H; }
    function render(animate){
      inner.style.transition=animate?'transform .2s cubic-bezier(.25,.8,.25,1)':'none';
      inner.style.transform=`translateY(${getTranslateY()}px)`;
      inner.querySelectorAll('.time-drum-item').forEach((el,i)=>el.classList.toggle('selected',i===PAD+getRenderIdx()));
    }
    function moveTo(n){
      selected=loop?(((n%items.length)+items.length)%items.length):Math.max(0,Math.min(items.length-1,n));
      render(true);
    }
    drum.addEventListener('pointerdown',e=>{ isDragging=true;startY=e.clientY;inner.style.transition='none';drum.setPointerCapture(e.pointerId); });
    drum.addEventListener('pointermove',e=>{ if(!isDragging)return; inner.style.transform=`translateY(${getTranslateY()+(e.clientY-startY)}px)`; });
    drum.addEventListener('pointerup',e=>{ if(!isDragging)return;isDragging=false;moveTo(selected-Math.round((e.clientY-startY)/ITEM_H)); });
    drum.addEventListener('wheel',e=>{ e.preventDefault();moveTo(selected+(e.deltaY>0?1:-1)); },{passive:false});
    render(false);
    return { col, getSelected: ()=>items[selected] };
  }

  const hDrum=makeDrum(hours,initH,'',true);
  const mDrum=makeDrum(minutes,initM,'',true);
  const apDrum=makeDrum(ampm,initAP,'ampm-drum',false);
  const colon=document.createElement('div');
  colon.className='time-colon'; colon.textContent=':';
  container.innerHTML='';
  container.className='time-picker-wrap';
  container.appendChild(hDrum.col);
  container.appendChild(colon);
  container.appendChild(mDrum.col);
  container.appendChild(apDrum.col);
  return { getTime: ()=>`${hDrum.getSelected()}:${mDrum.getSelected()} ${apDrum.getSelected()}` };
}

// ‚îÄ‚îÄ EDIT SINGLE SCHEDULE ENTRY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showEditSchedulePopup(currentTime, currentActivity, currentRepeat, onSave) {
  showSchedulePopup('Edit Entry', currentTime, currentActivity, '‚úì Save', onSave, currentRepeat || 'daily');
}

async function saveScheduleToVault() {
  // Always persist to localStorage with a timestamp so loadTemplate knows not to overwrite
  LS.set('lastConfig', S.config);
  LS.set('lastScheduleEdit', Date.now());

  if (!S.vaultDirHandle || !S.config) return;
  try {
    // Find the config .md file
    const searchDir = (await getDataDir()) || S.vaultDirHandle;
    for await (const entry of searchDir.values()) {
      if (entry.kind === 'file' && entry.name.endsWith('.md') && !entry.name.match(/^\d{16}HT\.md$/)) {
        const file = await entry.getFile();
        const originalText = await file.text();

        // Rebuild the frontmatter schedule block while preserving everything else
        const newText = rebuildScheduleInMd(originalText, S.config.schedule);
        if (newText === null) continue;

        // Write backup BEFORE overwriting the main file
        await writeScheduleBackup(originalText, entry.name);

        // Write the updated config back to the main .md file
        const fh = await searchDir.getFileHandle(entry.name, { create: false });
        const w = await fh.createWritable();
        await w.write(newText);
        await w.close();
        return;
      }
    }
  } catch(e) {
    console.warn('Schedule vault write failed (localStorage used):', e.message);
  }
}

// Write a rotating backup (max 3) into vault/backup/ folder
async function writeScheduleBackup(originalText, sourceFilename) {
  try {
    // Get or create vault/backup/ directory
    const backupDir = await S.vaultDirHandle.getDirectoryHandle('_backup', { create: true });

    // Collect existing schedule backup files, sorted oldest-first
    const existing = [];
    for await (const entry of backupDir.values()) {
      if (entry.kind === 'file' && entry.name.startsWith('schedule-backup-') && entry.name.endsWith('.md')) {
        existing.push(entry.name);
      }
    }
    existing.sort(); // ISO timestamp prefix = chronological sort

    // Delete oldest backups if we already have 3 or more
    while (existing.length >= 3) {
      const oldest = existing.shift();
      try { await backupDir.removeEntry(oldest); } catch {}
    }

    // Write new backup file named with current timestamp
    const ts = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    const backupName = `schedule-backup-${ts}.md`;
    const bfh = await backupDir.getFileHandle(backupName, { create: true });
    const bw = await bfh.createWritable();
    await bw.write(`# Schedule Backup ‚Äî ${new Date().toLocaleString()}\n# Source: ${sourceFilename}\n\n${originalText}`);
    await bw.close();
  } catch(e) {
    console.warn('Backup write failed:', e.message);
  }
}

// Rebuild the schedule block inside .md frontmatter (line-by-line, no regex gotchas)
function rebuildScheduleInMd(text, schedule) {
  const fmMatch = text.match(/^(---\n)([\s\S]+?)(\n---)([\s\S]*)$/);
  if (!fmMatch) return null;
  const [, open, yaml, close, body] = fmMatch;
  const schedLines = ['schedule:'];
  schedule.forEach(item => {
    schedLines.push(`- time: '${item.time}'`);
    schedLines.push(`  activity: '${item.activity}'`);
    if (item.repeat && item.repeat !== 'daily') schedLines.push(`  repeat: ${item.repeat}`);
    if (item.createdOn) schedLines.push(`  createdOn: '${item.createdOn}'`);
    if (item.customDates && item.customDates.length) schedLines.push(`  customDates: '${JSON.stringify(item.customDates)}'`);
    if (item.limitFrom) schedLines.push(`  limitFrom: '${item.limitFrom}'`);
    if (item.limitTo) schedLines.push(`  limitTo: '${item.limitTo}'`);
    if (item.perDateTimes) schedLines.push(`  perDateTimes: '${JSON.stringify(item.perDateTimes)}'`);
  });
  const lines = yaml.split('\n'); const out = []; let inBlock = false;
  for (const line of lines) {
    if (/^schedule:\s*$/.test(line)) { inBlock = true; out.push(...schedLines); continue; }
    if (inBlock) {
      // Skip ALL schedule item lines: indented, list items starting with -, or blank
      if (/^[\s-]/.test(line) || line.trim() === '') continue;
      inBlock = false;
    }
    out.push(line);
  }
  if (!out.some(l => l.startsWith('schedule:'))) out.push(...schedLines);
  return open + out.join('\n') + close + body;
}

// ‚îÄ‚îÄ VAULT BACKUP VIEWER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function showVaultBackups() {
  const ov = document.createElement('div'); ov.className = 'modal-overlay';
  ov.innerHTML = `<div class="modal"><div class="modal-handle"></div>
    <div class="modal-title">Schedule Backups</div>
    <div id="backup-list-body"><div class="empty-state" style="padding:24px 0">Loading‚Ä¶</div></div>
    <button class="btn btn-ghost" style="width:100%;margin-top:16px" id="bv-close">Close</button>
  </div>`;
  document.body.appendChild(ov);
  const close = () => document.body.removeChild(ov);
  ov.addEventListener('click', e => { if (e.target === ov) close(); });
  ov.querySelector('#bv-close').addEventListener('click', close);

  const body = ov.querySelector('#backup-list-body');

  try {
    const backupDir = await S.vaultDirHandle.getDirectoryHandle('_backup', { create: false });
    const files = [];
    for await (const entry of backupDir.values()) {
      if (entry.kind === 'file' && entry.name.startsWith('schedule-backup-') && entry.name.endsWith('.md')) {
        files.push(entry);
      }
    }
    files.sort((a, b) => b.name.localeCompare(a.name)); // newest first

    if (!files.length) {
      body.innerHTML = `<div class="empty-state" style="padding:24px 0">No backups yet.<br><small style="font-size:11px">Backups are created automatically when you save schedule changes.</small></div>`;
      return;
    }

    body.innerHTML = files.map((f, i) => {
      // Parse timestamp from filename: schedule-backup-2024-01-15T10-30-00.md
      const tsPart = f.name.replace('schedule-backup-', '').replace('.md', '').replace(/T/, ' ').replace(/-/g, (m, o) => o > 10 ? ':' : '-');
      return `<div class="s-row" style="flex-direction:column;align-items:stretch;gap:8px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div><div class="s-label" style="font-size:13px">Backup ${files.length - i}</div>
          <div class="s-sub">${f.name}</div></div>
          <button class="btn btn-ghost" style="min-height:36px;padding:6px 14px;font-size:13px" data-backup-idx="${i}">Restore</button>
        </div>
      </div>`;
    }).join('');

    // Wire restore buttons
    body.querySelectorAll('[data-backup-idx]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Restore this backup? Your current schedule will be replaced.')) return;
        try {
          const f = files[parseInt(btn.dataset.backupIdx)];
          const text = await (await f.getFile()).text();
          // The backup file starts with comment lines then the original .md content
          // Strip the comment header lines we added
          const mdStart = text.indexOf('---\n');
          if (mdStart === -1) { showToast('Could not parse backup file'); return; }
          const mdText = text.slice(mdStart);
          const cfg = parseMd(mdText);
          if (!cfg?.schedule?.length) { showToast('No schedule found in backup'); return; }
          if (!S.config) S.config = { schedule: [], habitDefinitions: {}, habitTracker: { enabled: true, snoozeOptions: [5, 10] } };
          S.config.schedule = cfg.schedule;
          LS.set('lastConfig', S.config);
          LS.set('lastScheduleEdit', Date.now());
          renderAll();
          showToast('‚Ü© Schedule restored from backup');
          close();
        } catch(e) {
          showToast('Restore failed: ' + e.message);
        }
      });
    });

  } catch(e) {
    body.innerHTML = `<div class="empty-state" style="padding:24px 0">No backup folder found yet.<br><small style="font-size:11px;font-family:var(--font-mono)">_backup/ is created automatically on first save.</small></div>`;
  }
}


// ‚îÄ‚îÄ OUTPUT FORMAT HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Replaces Obsidian-style {{date:FORMAT}} tokens in a path template.
// Supports: YYYY MM DD HH mm ss (and any combo e.g. YYYYMMDDHHmmss)
function applyDateFormat(template, d) {
  return template.replace(/\{\{date:([^}]+)\}\}/g, (_, fmt) => {
    return fmt
      .replace('YYYY', String(d.getFullYear()))
      .replace('MM',   String(d.getMonth()+1).padStart(2,'0'))
      .replace('DD',   String(d.getDate()).padStart(2,'0'))
      .replace('HH',   String(d.getHours()).padStart(2,'0'))
      .replace('mm',   String(d.getMinutes()).padStart(2,'0'))
      .replace('ss',   String(d.getSeconds()).padStart(2,'0'));
  });
}


async function pickLogTemplateFile() {
  try {
    // showOpenFilePicker lets user select a single .md file
    const [fh] = await window.showOpenFilePicker({
      id: 'logTemplate',
      types: [{ description: 'Markdown', accept: { 'text/markdown': ['.md'] } }],
      excludeAcceptAllOption: true,
    });
    S.logTemplateHandle = fh;
    LS.set('logTemplateName', fh.name);
    showToast(`üìÑ ${fh.name} set as log template`);
    return true;
  } catch(e) {
    if (e.name !== 'AbortError') showToast('Could not open file');
    return false;
  }
}

async function restoreLogTemplateHandle() {
  // Derived from vault via deriveSubHandles() ‚Äî nothing to restore from IDB separately
  if (!S.logTemplateHandle && S.vaultDirHandle && S.logOutputDirHandle) {
    try {
      S.logTemplateHandle = await S.logOutputDirHandle.getFileHandle('_Daily_Log_Template.md', { create: false });
    } catch {}
  }
}

async function restoreLogOutputHandle() {
  // Derived from vault via deriveSubHandles() ‚Äî nothing to restore from IDB separately
}

// Called to ensure log output handle is ready before writing
async function _activateLogOutputHandle() {
  if (S.logOutputDirHandle) return true;
  if (!S.vaultDirHandle) return false;
  // Derive on demand if not yet set
  S.logOutputDirHandle = await _navSubDir(S.vaultDirHandle, VAULT_PATHS.logOutput, true);
  return !!S.logOutputDirHandle;
}

async function pickLogOutputFolder() {
  if (!S.vaultDirHandle) { showToast('Connect a vault first in Settings'); return false; }
  S.logOutputDirHandle = await _navSubDir(S.vaultDirHandle, VAULT_PATHS.logOutput, true);
  if (S.logOutputDirHandle) {
    LS.set('logOutputFolderName', VAULT_PATHS.logOutput.join('/'));
    showToast(`üìÅ Log output: ${VAULT_PATHS.logOutput.join('/')}`);
    return true;
  }
  return false;
}

// ‚îÄ‚îÄ EVENTS SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Events are stored as individual .md files in the events folder.
// Each file has YAML frontmatter: title, date (YYYY-MM-DD), time (HH:MM optional), note

async function pickEventsFolder() {
  if (!S.vaultDirHandle) { showToast('Connect a vault first in Settings'); return false; }
  S.eventsDirHandle = await _navSubDir(S.vaultDirHandle, VAULT_PATHS.events, true);
  if (S.eventsDirHandle) {
    LS.set('eventsFolderName', VAULT_PATHS.events.join('/'));
    showToast(`‚úì Events folder: ${VAULT_PATHS.events.join('/')}`);
    return true;
  }
  return false;
}

async function restoreEventsHandle() {
  // Derived from vault via deriveSubHandles() ‚Äî nothing to restore from IDB separately
}

async function loadEvents() {
  if (!S.eventsDirHandle) return [];
  try {
    const p = await S.eventsDirHandle.requestPermission({ mode: 'readwrite' });
    if (p !== 'granted') return [];
    const events = [];
    for await (const entry of S.eventsDirHandle.values()) {
      if (entry.kind !== 'file' || !entry.name.endsWith('.md')) continue;
      try {
        const file = await entry.getFile();
        const text = await file.text();
        const titleM  = text.match(/^title:\s*(.+)/m);
        const dateM   = text.match(/^date:\s*(\d{4}-\d{2}-\d{2})/m);
        const timeM   = text.match(/^time:\s*(.+)/m);
        const noteM   = text.match(/^note:\s*(.+)/m);
        if (!titleM || !dateM) continue;
        const body = text.replace(/^---[\s\S]*?---\s*/m, '').trim();
        events.push({
          filename: entry.name,
          handle: entry,
          title: titleM[1].trim().replace(/^["']|["']$/g, ''),
          date: dateM[1].trim(),
          time: timeM ? timeM[1].trim() : '',
          note: noteM ? noteM[1].trim().replace(/^["']|["']$/g, '') : body.slice(0, 80),
        });
      } catch {}
    }
    events.sort((a, b) => a.date.localeCompare(b.date));
    return events;
  } catch { return []; }
}

async function saveEvent(ev, oldFilename) {
  if (!S.eventsDirHandle) { showToast('No events folder set'); return false; }
  const p = await S.eventsDirHandle.requestPermission({ mode: 'readwrite' });
  if (p !== 'granted') { showToast('Permission denied'); return false; }
  const slug = ev.title.replace(/[^a-z0-9]/gi, '_').toLowerCase().slice(0, 30);
  const filename = oldFilename || `${ev.date.replace(/-/g,'')}_${slug}.md`;
  const content = `---\ntitle: ${JSON.stringify(ev.title)}\ndate: ${ev.date}\n${ev.time ? 'time: ' + ev.time + '\n' : ''}${ev.note ? 'note: ' + JSON.stringify(ev.note) + '\n' : ''}---\n${ev.note || ''}`;
  try {
    if (oldFilename && oldFilename !== filename) {
      try { await S.eventsDirHandle.removeEntry(oldFilename); } catch {}
    }
    const fh = await S.eventsDirHandle.getFileHandle(filename, { create: true });
    const w = await fh.createWritable(); await w.write(content); await w.close();
    return true;
  } catch (e) { showToast('\u26a0 Save failed'); return false; }
}

async function deleteEvent(filename) {
  if (!S.eventsDirHandle) return;
  try { await S.eventsDirHandle.removeEntry(filename); } catch {}
}

function showAddEventSheet(existingEvent, onSaved) {
  const isEdit = !!existingEvent;
  const todayISO = new Date().toISOString().slice(0, 10);
  const ov = document.createElement('div'); ov.className = 'modal-overlay';
  ov.innerHTML = `<div class="modal" style="max-width:340px">
    <div class="modal-handle"></div>
    <div style="font-size:16px;font-weight:800;margin-bottom:16px">${isEdit ? '‚úé Edit Event' : 'Ôºã New Event'}</div>
    <div style="display:flex;flex-direction:column;gap:10px">
      <input id="ev-title" type="text" placeholder="Event title" value="${isEdit ? existingEvent.title.replace(/"/g,'&quot;') : ''}"
        style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-family:var(--font-mono);font-size:14px;outline:none"/>
      <div style="display:flex;gap:8px">
        <div style="flex:1">
          <div style="font-size:10px;font-family:var(--font-mono);color:var(--muted);margin-bottom:4px;letter-spacing:.5px">DATE</div>
          <input id="ev-date" type="date" value="${isEdit ? existingEvent.date : todayISO}"
            style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 10px;color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none;color-scheme:dark"/>
        </div>
        <div style="flex:1">
          <div style="font-size:10px;font-family:var(--font-mono);color:var(--muted);margin-bottom:4px;letter-spacing:.5px">TIME (optional)</div>
          <input id="ev-time" type="time" value="${isEdit ? existingEvent.time : ''}"
            style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 10px;color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none;color-scheme:dark"/>
        </div>
      </div>
      <textarea id="ev-note" placeholder="Notes (optional)" rows="3"
        style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none;resize:vertical">${isEdit ? (existingEvent.note||'').replace(/</g,'&lt;') : ''}</textarea>
    </div>
    <div style="display:flex;gap:8px;margin-top:14px">
      <button class="btn btn-green" id="ev-save" style="flex:2">${isEdit ? '‚úì Save' : 'Ôºã Add'}</button>
    </div>
  </div>`;
  document.body.appendChild(ov);
  ov.addEventListener('click', e => { if (e.target === ov) ov.remove(); });
  setTimeout(() => ov.querySelector('#ev-title').focus(), 80);

  ov.querySelector('#ev-save').addEventListener('click', async () => {
    const title = ov.querySelector('#ev-title').value.trim();
    const date  = ov.querySelector('#ev-date').value;
    const time  = ov.querySelector('#ev-time').value;
    const note  = ov.querySelector('#ev-note').value.trim();
    if (!title) { showToast('Enter a title'); return; }
    if (!date)  { showToast('Pick a date'); return; }
    const btn = ov.querySelector('#ev-save');
    btn.disabled = true; btn.textContent = 'Saving‚Ä¶';
    const ok = await saveEvent({ title, date, time, note }, isEdit ? existingEvent.filename : null);
    if (ok) { ov.remove(); if (onSaved) onSaved(); showToast(isEdit ? '‚úì Event updated' : '‚úì Event added'); }
    else { btn.disabled = false; btn.textContent = isEdit ? '‚úì Save' : 'Ôºã Add'; }
  });
}

async function renderEventsCard() {
  const card = document.getElementById('card-events');
  if (!card) return;
  const body = card.querySelector('.card-body');
  if (!body) return;

  if (!S.eventsDirHandle) {
    body.innerHTML = `<div class="empty-state" style="padding:16px 0;line-height:1.8;font-size:12px;font-family:var(--font-mono);color:var(--muted);text-align:center">
      No events folder set<br>
      <button onclick="showSettings()" style="margin-top:8px;padding:6px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:11px;font-family:var(--font-mono);cursor:pointer">‚öô Open Settings</button>
    </div>`;
    return;
  }

  const events = await loadEvents();
  const now = new Date(); now.setHours(0,0,0,0);
  const upcoming = events.filter(e => new Date(e.date + 'T00:00:00') >= now);
  const past = events.filter(e => new Date(e.date + 'T00:00:00') < now).slice(-2).reverse();

  function daysUntil(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    const diff = Math.round((d - now) / 86400000);
    if (diff === 0) return 'Today';
    if (diff === 1) return 'Tomorrow';
    if (diff < 7) return `In ${diff} days`;
    if (diff < 30) return `In ${Math.round(diff/7)}w`;
    if (diff < 365) return `In ${Math.round(diff/30)}mo`;
    return `${d.toLocaleDateString(undefined,{month:'short',day:'numeric'})}`;
  }

  function eventHTML(ev, isPast) {
    const ds = daysUntil(ev.date);
    return `<div class="event-row${isPast?' event-past':''}" data-filename="${ev.filename}" style="display:flex;align-items:flex-start;gap:10px;padding:8px 10px;margin-bottom:4px;background:var(--bg3);border-radius:10px;border:1px solid var(--border);cursor:pointer;transition:background .1s">
      <div style="flex-shrink:0;text-align:center;min-width:36px">
        <div style="font-size:10px;font-family:var(--font-mono);color:${isPast?'var(--muted)':'var(--accent)'};font-weight:700">${isPast ? new Date(ev.date+'T00:00:00').toLocaleDateString(undefined,{month:'short',day:'numeric'}) : ds}</div>
        ${ev.time ? `<div style="font-size:9px;font-family:var(--font-mono);color:var(--muted)">${ev.time}</div>` : ''}
      </div>
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:700;color:${isPast?'var(--muted)':'var(--text)'};white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${ev.title}</div>
        ${ev.note ? `<div style="font-size:11px;font-family:var(--font-mono);color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${ev.note}</div>` : ''}
      </div>
    </div>`;
  }

  let html = '';
  if (upcoming.length === 0 && past.length === 0) {
    html = `<div style="text-align:center;font-size:12px;font-family:var(--font-mono);color:var(--muted);padding:12px 0">No upcoming events</div>`;
  } else {
    if (upcoming.length) html += upcoming.map(e => eventHTML(e, false)).join('');
    if (past.length) {
      html += `<div style="font-size:9px;font-family:var(--font-mono);color:var(--muted);letter-spacing:1px;text-transform:uppercase;padding:6px 2px 2px">Past</div>`;
      html += past.map(e => eventHTML(e, true)).join('');
    }
  }
  html += `<button id="ev-add-btn" class="btn btn-ghost" style="width:100%;margin-top:6px;font-size:12px">Ôºã Add Event</button>`;
  body.innerHTML = html;

  body.querySelectorAll('.event-row').forEach(row => {
    row.addEventListener('click', async () => {
      const filename = row.dataset.filename;
      const ev = events.find(e => e.filename === filename);
      if (!ev) return;
      // Show detail/edit popup
      const dov = document.createElement('div'); dov.className = 'modal-overlay';
      const ds2 = daysUntil(ev.date);
      dov.innerHTML = `<div class="modal" style="max-width:340px">
        <div class="modal-handle"></div>
        <div style="font-size:18px;font-weight:800;margin-bottom:6px">${ev.title}</div>
        <div style="font-size:12px;font-family:var(--font-mono);color:var(--accent);margin-bottom:4px">${ev.date}${ev.time?' ¬∑ '+ev.time:''} ¬∑ <span style="color:var(--muted)">${ds2}</span></div>
        ${ev.note ? `<div style="font-size:13px;color:var(--muted);font-family:var(--font-mono);margin:10px 0;line-height:1.6">${ev.note.replace(/</g,'&lt;')}</div>` : ''}
        <div style="display:flex;gap:8px;margin-top:14px">
          <button class="btn btn-ghost" style="flex:1" id="dev-edit">‚úé Edit</button>
          <button class="btn btn-ghost" style="flex:1;color:var(--danger);border-color:rgba(255,68,102,.3)" id="dev-del">‚úï Delete</button>
          <button class="btn btn-ghost" style="flex:1" id="dev-close">Close</button>
        </div>
      </div>`;
      document.body.appendChild(dov);
      const dclose = () => dov.remove();
      dov.addEventListener('click', e => { if (e.target === dov) dclose(); });
      dov.querySelector('#dev-close').addEventListener('click', dclose);
      dov.querySelector('#dev-edit').addEventListener('click', () => { dclose(); showAddEventSheet(ev, () => renderEventsCard()); });
      dov.querySelector('#dev-del').addEventListener('click', async () => {
        if (!confirm(`Delete "${ev.title}"?`)) return;
        await deleteEvent(ev.filename);
        dclose();
        renderEventsCard();
        showToast('Event deleted');
      });
    });
  });

  body.querySelector('#ev-add-btn')?.addEventListener('click', () => {
    showAddEventSheet(null, () => renderEventsCard());
  });
}

// ‚îÄ‚îÄ END EVENTS SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


// ‚îÄ‚îÄ LOG WRITING HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sanitizeForYAML(input) {
  if (typeof input !== 'string') return input;
  const needsQuoting = /[:"'#\[\]{}&*!|>%@`]/.test(input) ||
    input.trim() !== input ||
    /^[0-9]/.test(input) ||
    /^(true|false|null|yes|no)$/i.test(input);
  if (!needsQuoting) return input;
  return '"' + input.replace(/"/g, '\\"') + '"';
}

function extractTagsFromText(text) {
  const tags = (text.match(/#[\w]+/g) || []).map(t => t.slice(1));
  const cleaned = text.replace(/#[\w]+/g, '').replace(/\s{2,}/g, ' ').trim();
  return { tags, cleaned };
}

function fmtDateYMD(d) {
  return d.getFullYear() + '-' +
    String(d.getMonth()+1).padStart(2,'0') + '-' +
    String(d.getDate()).padStart(2,'0');
}
function fmtTimeHMA(d) {
  let h = d.getHours(), m = d.getMinutes();
  const ap = h >= 12 ? 'pm' : 'am';
  h = h % 12 || 12;
  return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ' ' + ap;
}

// ‚îÄ‚îÄ FILE WRITE HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Chrome Android PWA bug: createWritable() throws InvalidStateError on some handles.
// Fix: call getFile() first to "activate" the handle, then createWritable().
// If that also fails, fall back to truncate+write via seek.
async function _writeFileHandle(fh, content) {
  // Warm up the handle (fixes Chrome Android InvalidStateError)
  try { await fh.getFile(); } catch {}

  let w;
  try {
    w = await fh.createWritable({ keepExistingData: false });
  } catch(e) {
    // Last resort: createWritable with no options
    w = await fh.createWritable();
  }

  try {
    await w.write(content);
    await w.close();
  } catch(e) {
    try { await w.abort(); } catch {}
    throw e;
  }
}

async function writeLogEntry(logText) {
  const now = new Date();
  const dateStr = fmtDateYMD(now);
  const timeStr = fmtTimeHMA(now);

  const { tags, cleaned } = extractTagsFromText(logText);
  const sanitizedLog = sanitizeForYAML(cleaned);
  const finalTags = tags.length ? tags : ['explore'];

  // ‚îÄ‚îÄ Build content ‚îÄ‚îÄ
  let newContent;
  if (S.logTemplateHandle) {
    try {
      const perm = await S.logTemplateHandle.requestPermission({ mode: 'read' });
      if (perm === 'granted') {
        const file = await S.logTemplateHandle.getFile();
        let templateText = await file.text();
        templateText = templateText
          .replace(/\{\{date:YYYY-MM-DD\}\}/g, dateStr)
          .replace(/\{\{DATE:hh:mm a\}\}/g, timeStr);
        const fmMatch = templateText.match(/^(---\n)([\s\S]+?)(\n---)([ \S]*)/);
        if (fmMatch) {
          const [, open, yaml, close, body] = fmMatch;
          let yamlLines = yaml.split('\n');
          const logIdx = yamlLines.findIndex(l => l.startsWith('log:'));
          if (logIdx !== -1) yamlLines[logIdx] = `log: ${sanitizedLog}`;
          else yamlLines.push(`log: ${sanitizedLog}`);
          const tagsIdx = yamlLines.findIndex(l => l.trim() === 'tags:');
          if (tagsIdx !== -1) {
            let ei = tagsIdx + 1;
            while (ei < yamlLines.length && /^\s+-/.test(yamlLines[ei])) ei++;
            yamlLines.splice(tagsIdx, ei - tagsIdx);
          }
          yamlLines.push('tags:', ...finalTags.map(t => `  - ${t}`));
          newContent = open + yamlLines.join('\n') + close + body;
        }
      }
    } catch(e) { console.warn('Template read failed:', e); }
  }
  if (!newContent) {
    newContent = `---\ndate: ${dateStr}\ntime: ${timeStr}\nlog: ${sanitizedLog}\ntags:\n${finalTags.map(t => `  - ${t}`).join('\n')}\n---\n`;
  }

  // ‚îÄ‚îÄ Generate filename ‚îÄ‚îÄ
  const ts = now.toISOString().replace(/[-:.TZ]/g, '').slice(0, 14);
  const fmt = LS.get('logOutputFormat') || '{{date:YYYY}}/{{date:YYYYMMDDHHmmss}}';
  const basePath = applyDateFormat(fmt, now);
  const pathParts = basePath.split('/');
  const baseFilename = (pathParts.pop() || ts) + '.md';
  const subDirs = pathParts.filter(Boolean);
  const id = ts + '_' + Math.random().toString(36).slice(2, 6);

  // ‚îÄ‚îÄ Save to IDB (always) ‚îÄ‚îÄ
  const idbEntry = {
    id,
    filename: baseFilename,
    path: [...subDirs, baseFilename].join('/'),
    content: newContent,
    preview: sanitizedLog.slice(0, 120),
    tags: finalTags,
    dateLabel: _filenameToLabel(baseFilename),
    ts: now.getTime(),
  };
  try { await IDBLogs.save(idbEntry); } catch(e) { console.warn('IDB save failed:', e); }

  // ‚îÄ‚îÄ Write to folder (auto, no picker every time) ‚îÄ‚îÄ
  await _writeLogToFolder(idbEntry, newContent, subDirs, baseFilename);
  return true;
}

// Tries to write using the stored dir handle.
// If it fails or doesn't exist, prompts once to pick the folder, then retries.
async function _writeLogToFolder(idbEntry, content, subDirs, baseFilename) {
  // Activate pending handle if available (requires user gesture ‚Äî we're in save click chain)
  if (!S.logOutputDirHandle) await _activateLogOutputHandle();

  // Try with existing handle first
  if (S.logOutputDirHandle) {
    const ok = await _tryWriteLog(S.logOutputDirHandle, idbEntry, content, subDirs, baseFilename);
    if (ok) return;
    // Handle went stale ‚Äî clear and re-derive from vault
    S.logOutputDirHandle = null;
  }

  // Re-derive from vault
  if (S.vaultDirHandle) {
    S.logOutputDirHandle = await _navSubDir(S.vaultDirHandle, VAULT_PATHS.logOutput, true);
    if (S.logOutputDirHandle) {
      const ok = await _tryWriteLog(S.logOutputDirHandle, idbEntry, content, subDirs, baseFilename);
      if (ok) return;
    }
  }

  showToast('‚ö† Log folder unavailable ‚Äî connect vault in Settings');
}

// Attempts a write with a given dir handle. Returns true on success, false on any error.
async function _tryWriteLog(rootHandle, idbEntry, content, subDirs, baseFilename) {
  try {
    let dir = rootHandle;
    for (const seg of subDirs) {
      dir = await dir.getDirectoryHandle(seg, { create: true });
    }

    // Unique filename
    let filename = baseFilename;
    let suffix = 0;
    for (;;) {
      let exists = false;
      try { await dir.getFileHandle(filename, { create: false }); exists = true; } catch {}
      if (!exists) break;
      suffix++;
      const dot = baseFilename.lastIndexOf('.');
      filename = baseFilename.slice(0, dot) + '_' + suffix + baseFilename.slice(dot);
    }

    const fh = await dir.getFileHandle(filename, { create: true });
    const w = await fh.createWritable();
    await w.write(content);
    await w.close();

    idbEntry.filename = filename;
    idbEntry.path = [...subDirs, filename].join('/') || filename;
    await IDBLogs.save(idbEntry);

    showToast('\u2713 Log saved');
    return true;
  } catch(e) {
    console.error('_tryWriteLog failed:', e);
    return false;
  }
}


// ‚îÄ‚îÄ LOG TEXT POPUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLogTextPopup() {
  _openLogTextEditor();
}

function _openLogTextEditor() {

  const ov = document.createElement('div');
  ov.className = 'sched-edit-popup';
  ov.innerHTML = `<div class="sched-edit-sheet" style="max-height:90dvh">
    <div class="modal-handle"></div>
    <div style="font-size:16px;font-weight:800;margin-bottom:4px">üìù Text Log</div>
    <div style="font-size:11px;font-family:var(--font-mono);color:var(--muted);margin-bottom:12px">
      Use #hashtags to auto-tag your entry
    </div>
    <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px">What's on your mind?</div>
    <textarea id="log-text-input" placeholder="Type your thoughts‚Ä¶ #idea #work"
      style="width:100%;min-height:140px;resize:vertical;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:13px 14px;color:var(--text);font-family:var(--font-mono);font-size:14px;outline:none;line-height:1.6;margin-bottom:14px;transition:border-color .15s"></textarea>
    <div id="log-tag-preview" style="min-height:22px;margin-bottom:12px;display:flex;flex-wrap:wrap;gap:6px"></div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost" id="log-cancel" style="flex:1">Cancel</button>
      <button class="btn btn-green" id="log-ok" style="flex:2">‚úì Save Log</button>
    </div>
  </div>`;
  document.body.appendChild(ov);

  const textarea = ov.querySelector('#log-text-input');
  const tagPreview = ov.querySelector('#log-tag-preview');
  const close = () => document.body.removeChild(ov);

  // Live tag preview as user types
  textarea.addEventListener('input', () => {
    const tags = (textarea.value.match(/#[\w]+/g) || []);
    tagPreview.innerHTML = tags.map(t =>
      `<span style="background:rgba(0,255,136,.12);border:1px solid rgba(0,255,136,.3);border-radius:20px;padding:2px 10px;font-size:11px;font-family:var(--font-mono);color:var(--accent)">${t}</span>`
    ).join('');
    textarea.style.borderColor = 'var(--accent)';
  });
  textarea.addEventListener('blur', () => { textarea.style.borderColor = 'var(--border)'; });
  textarea.addEventListener('focus', () => { textarea.style.borderColor = 'var(--accent)'; });

  ov.addEventListener('click', e => { if (e.target === ov) close(); });
  ov.querySelector('#log-cancel').addEventListener('click', close);

  ov.querySelector('#log-ok').addEventListener('click', async () => {
    const text = textarea.value.trim();
    if (!text) { showToast('Write something first'); return; }
    const btn = ov.querySelector('#log-ok');
    btn.disabled = true; btn.textContent = 'Saving‚Ä¶';
    try {
      await writeLogEntry(text);
    } catch(e) {
      showToast('‚ö† Save error: ' + (e.name || 'error'));
      btn.disabled = false; btn.textContent = '‚úì Save Log';
      return;
    }
    close();
  });

  setTimeout(() => textarea.focus(), 100);
}

// ‚îÄ‚îÄ LOGS TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Virtualized log viewer ‚Äî handles thousands of files without DOM bloat.
// Row height is fixed at 72px for predictable math.
const LOG_ROW_H = 72;
let _logsTabMounted = false;
let _allLogs = [];      // [{filename, path, date, preview, tags, content}]
let _filteredLogs = []; // subset after search
let _logsLoading = false;
let _logsSearchQ = '';
let _logsViewport = null;
let _logsSpacerEl = null;
let _logsRenderedRange = { start: 0, end: 0 };
let _logsNodes = {};    // index ‚Üí DOM node (pooled)

let _logsDateFilter = 'today'; // 'today' | 'week' | 'month' | 'year' | 'all'

// ‚îÄ‚îÄ LOGS POPUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLogsPopup() {
  const existing = document.getElementById('logs-popup-ov');
  if (existing) { existing.remove(); return; }
  const ov = document.createElement('div');
  ov.id = 'logs-popup-ov';
  ov.className = 'modal-overlay';
  ov.style.cssText = 'align-items:flex-end;z-index:200';
  ov.innerHTML = `<div style="background:var(--bg2);border:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-width:480px;height:88dvh;display:flex;flex-direction:column;animation:slideUp .3s cubic-bezier(.34,1.56,.64,1);overflow:hidden">
    <div style="padding:14px 20px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0">
      <span style="font-size:14px;font-weight:800;letter-spacing:-.3px">Archive</span>
      <button id="lp-close" style="width:28px;height:28px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1">‚úï</button>
    </div>
    <div id="lp-body" style="flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden;padding:10px 16px 16px">
      <div class="logs-toolbar" style="margin-bottom:10px">
        <input class="logs-search" id="lp-search" type="search" placeholder="Search logs‚Ä¶" autocomplete="off"/>
        <select id="lp-date-filter" style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:6px 8px;color:var(--text);font-family:var(--font-mono);font-size:11px;outline:none;cursor:pointer;flex-shrink:0">
          <option value="today">Today</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
          <option value="year">This Year</option>
          <option value="all">All Time</option>
        </select>
      </div>
      <div style="flex:1;min-height:0;position:relative">
        <div class="logs-viewport" id="lp-viewport" style="position:absolute;inset:0;overflow-y:auto;-webkit-overflow-scrolling:touch">
          <div class="logs-spacer" id="lp-spacer"></div>
        </div>
      </div>
      <div class="logs-status" id="lp-status" style="margin-top:6px"></div>
    </div>
  </div>`;
  document.body.appendChild(ov);
  ov.addEventListener('click', e => { if (e.target === ov) ov.remove(); });
  ov.querySelector('#lp-close').addEventListener('click', () => ov.remove());

  // Reset log state for fresh popup render
  _logsTabMounted = false;
  _allLogs = [];
  _filteredLogs = [];
  _logsNodes = {};
  _logsRenderedRange = { start: 0, end: 0 };
  _logsViewport = ov.querySelector('#lp-viewport');
  _logsSpacerEl = ov.querySelector('#lp-spacer');
  window._logsStatusElId = 'lp-status';

  _logsViewport.addEventListener('scroll', () => _logsVirtualRender(), { passive: true });
  ov.querySelector('#lp-search').addEventListener('input', e => {
    _logsSearchQ = e.target.value.trim().toLowerCase(); _logsApplyFilter();
  });
  ov.querySelector('#lp-date-filter').addEventListener('change', e => {
    _logsDateFilter = e.target.value; if (S.logOutputDirHandle) _logsApplyFilter();
  });

  // Clean up when popup closes
  ov.addEventListener('animationend', () => {});
  const obs = new MutationObserver(() => {
    if (!document.contains(ov)) { _logsViewport = null; _logsSpacerEl = null; obs.disconnect(); }
  });
  obs.observe(document.body, { childList: true });

  loadAllLogs();
}

async function renderLogsTab() {
  // No-op ‚Äî logs are now in the Archive popup (showLogsPopup)
}

async function loadAllLogs() {
  if (_logsLoading) return;
  _logsLoading = true;
  _setLogsStatus('Loading‚Ä¶');

  const entries = [];

  // ‚îÄ‚îÄ 1. Load from IDB (works on all platforms) ‚îÄ‚îÄ
  try {
    const idbLogs = await IDBLogs.getAll();
    for (const log of idbLogs) {
      entries.push({
        filename: log.filename,
        path: log.path,
        handle: null,       // no file handle ‚Äî IDB only
        idbId: log.id,      // IDB key for edits/deletes
        preview: log.preview,
        tags: log.tags || [],
        dateLabel: log.dateLabel || _filenameToLabel(log.filename),
        _fullText: log.content,
        loaded: true,
        ts: log.ts || 0,
      });
    }
  } catch(e) { console.warn('IDB log load failed:', e); }

  // ‚îÄ‚îÄ 2. Load from folder (desktop) ‚Äî merge, dedup by filename ‚îÄ‚îÄ
  if (S.logOutputDirHandle) {
    try {
      const perm = await S.logOutputDirHandle.requestPermission({ mode: 'readwrite' });
      if (perm === 'granted') {
        const folderEntries = [];
        await _scanLogDir(S.logOutputDirHandle, '', folderEntries);
        // Add folder entries that aren't already in IDB (dedup by filename)
        const idbFilenames = new Set(entries.map(e => e.filename));
        for (const fe of folderEntries) {
          if (!idbFilenames.has(fe.filename)) entries.push(fe);
        }
      }
    } catch(e) { console.warn('Folder log scan failed:', e.message); }
  }

  if (!entries.length) {
    _logsSetEmpty('No logs yet.<br><small style="color:var(--muted);font-size:11px">Tap the log button to write your first entry.</small>');
    _logsLoading = false; return;
  }

  entries.sort((a, b) => (b.ts || 0) - (a.ts || 0) || b.filename.localeCompare(a.filename));
  _allLogs = entries;
  _logsApplyFilter();
  _logsLoading = false;
}

// Recursively scan a directory for .md files
async function _scanLogDir(dirHandle, prefix, out) {
  try {
    for await (const entry of dirHandle.values()) {
      if (entry.kind === 'directory') {
        await _scanLogDir(entry, prefix ? prefix + '/' + entry.name : entry.name, out);
      } else if (entry.kind === 'file' && entry.name.endsWith('.md')) {
        const path = prefix ? prefix + '/' + entry.name : entry.name;
        // Lazy: only read content when item is rendered (store handle for later)
        out.push({ filename: entry.name, path, handle: entry, preview: null, tags: [], loaded: false });
      }
    }
  } catch {}
}

function _logsApplyFilter() {
  const now = new Date();
  const todayStr2 = now.toISOString().slice(0, 10).replace(/-/g, '');
  const monthStr = now.toISOString().slice(0, 7).replace(/-/g, '');
  const yearStr  = now.getFullYear().toString();
  // Week: compute YYYYMMDD for start of week (Monday)
  const weekStart = new Date(now); weekStart.setDate(now.getDate() - ((now.getDay()+6)%7)); weekStart.setHours(0,0,0,0);
  const weekStartNum = parseInt(weekStart.toISOString().slice(0,10).replace(/-/g,''));

  let base = _allLogs;

  // Date filter
  if (_logsDateFilter !== 'all') {
    base = base.filter(l => {
      const fn = l.filename;
      if (_logsDateFilter === 'today') return fn.includes(todayStr2);
      if (_logsDateFilter === 'week') {
        // extract YYYYMMDD from filename
        const m = fn.match(/(\d{8})/); if (!m) return false;
        return parseInt(m[1]) >= weekStartNum;
      }
      if (_logsDateFilter === 'month') return fn.includes(monthStr) || fn.startsWith(yearStr + '/' + now.toISOString().slice(5,7));
      if (_logsDateFilter === 'year')  return fn.includes(yearStr) || l.path.startsWith(yearStr + '/');
      return true;
    });
  }

  // Search filter
  if (_logsSearchQ) {
    const q = _logsSearchQ;
    base = base.filter(l =>
      l.path.toLowerCase().includes(q) ||
      (l.preview || '').toLowerCase().includes(q) ||
      l.tags.some(t => t.toLowerCase().includes(q))
    );
  }
  _filteredLogs = base;

  // ‚îÄ‚îÄ Purge all existing DOM nodes from the spacer to prevent ghosting ‚îÄ‚îÄ
  if (_logsSpacerEl) _logsSpacerEl.querySelectorAll('.log-item').forEach(n => n.remove());
  _logsNodes = {};
  _logsRenderedRange = { start: 0, end: 0 };

  _setLogsStatus(`${_filteredLogs.length.toLocaleString()} log${_filteredLogs.length !== 1 ? 's' : ''}`);
  if (_filteredLogs.length === 0) {
    _logsSetEmpty(_logsSearchQ ? 'No logs match your search.' : `No logs for ${_logsDateFilter === 'today' ? 'today' : _logsDateFilter === 'week' ? 'this week' : _logsDateFilter === 'month' ? 'this month' : _logsDateFilter === 'year' ? 'this year' : 'selected period'}.`);
    return;
  }
  const emp = _logsViewport?.querySelector('.logs-empty');
  if (emp) emp.remove();
  if (_logsSpacerEl) _logsSpacerEl.style.height = (_filteredLogs.length * LOG_ROW_H) + 'px';
  if (_logsViewport) _logsViewport.scrollTop = 0;
  _logsVirtualRender(true);
}

function _logsSetEmpty(msg) {
  if (!_logsViewport) return;
  _logsViewport.querySelectorAll('.log-item').forEach(n => n.remove());
  _logsNodes = {};
  if (_logsSpacerEl) _logsSpacerEl.style.height = '0';
  let emp = _logsViewport.querySelector('.logs-empty');
  if (!emp) { emp = document.createElement('div'); emp.className = 'logs-empty'; _logsViewport.appendChild(emp); }
  emp.innerHTML = msg;
  _setLogsStatus('');
}

function _setLogsStatus(msg) {
  const id = window._logsStatusElId || 'logs-status';
  const el = document.getElementById(id);
  if (el) el.textContent = msg;
}

function _logsVirtualRender(force) {
  if (!_logsViewport || !_logsSpacerEl) return;
  if (_filteredLogs.length === 0) return;

  const scrollTop = _logsViewport.scrollTop;
  const height = _logsViewport.clientHeight || 400;
  const overscan = 8; // extra rows above/below viewport
  const start = Math.max(0, Math.floor(scrollTop / LOG_ROW_H) - overscan);
  const end   = Math.min(_filteredLogs.length - 1, Math.ceil((scrollTop + height) / LOG_ROW_H) + overscan);

  if (!force && start === _logsRenderedRange.start && end === _logsRenderedRange.end) return;
  _logsRenderedRange = { start, end };

  // Remove nodes outside range
  Object.keys(_logsNodes).forEach(i => {
    const ii = parseInt(i);
    if (ii < start || ii > end) { _logsNodes[i].remove(); delete _logsNodes[i]; }
  });

  // Add nodes in range
  for (let i = start; i <= end; i++) {
    if (_logsNodes[i]) continue;
    const log = _filteredLogs[i];
    const node = document.createElement('div');
    node.className = 'log-item';
    node.style.top = (i * LOG_ROW_H) + 'px';
    node.dataset.idx = i;
    _renderLogNode(node, log);
    _logsSpacerEl.appendChild(node);
    _logsNodes[i] = node;

    // Lazy-load content for search highlighting
    if (!log.loaded) {
      _loadLogPreview(log).then(() => {
        if (_logsNodes[i] === node) _renderLogNode(node, log);
      });
    }
    node.addEventListener('click', () => _openLogDetail(log));
  }
}

async function _loadLogPreview(log) {
  if (log.loaded) return;
  log.loaded = true;
  try {
    const file = await log.handle.getFile();
    const text = await file.text();
    log._fullText = text;
    // Extract log field from frontmatter
    const logM = text.match(/^log:\s*(.+)/m);
    log.preview = logM ? logM[1].replace(/^["']|["']$/g, '').trim() : text.replace(/^---[\s\S]*?---\n?/,'').trim().slice(0,120);
    // Extract tags ‚Äî collect all "  - tagname" lines after "tags:" until a non-indented line
    log.tags = [];
    const lines = text.split('\n');
    let inTags = false;
    for (const line of lines) {
      if (/^tags:\s*$/.test(line)) { inTags = true; continue; }
      if (inTags) {
        const m = line.match(/^\s+-\s+(\S+)/);
        if (m) log.tags.push(m[1]);
        else if (line.trim() !== '' && !/^\s/.test(line)) break; // non-indented line ends block
      }
    }
    // Extract timestamp from filename for display
    log.dateLabel = _filenameToLabel(log.filename);
  } catch { log.preview = log.filename; }
}

function _filenameToLabel(name) {
  // Try to extract YYYYMMDDHHmmss pattern
  const m = name.match(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/);
  if (m) {
    const [,Y,Mo,D,H,Min] = m;
    const d = new Date(+Y,+Mo-1,+D,+H,+Min);
    return d.toLocaleString(undefined, {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
  }
  // Fallback: YYYY-MM-DD
  const m2 = name.match(/(\d{4})-(\d{2})-(\d{2})/);
  if (m2) return `${m2[2]}/${m2[3]}/${m2[1]}`;
  return name.replace('.md','');
}

function _renderLogNode(node, log) {
  const time = log.dateLabel || _filenameToLabel(log.filename);
  const preview = (log.preview || log.filename).slice(0, 90);
  const tags = log.tags.slice(0, 3).map(t => `<span class="log-item-tag">#${t}</span>`).join('');
  node.innerHTML = `
    <div class="log-item-header">
      <span class="log-item-time">${time}</span>
      <span class="log-item-filename">${log.path}</span>
    </div>
    <div class="log-item-preview">${preview}</div>
    ${tags ? `<div class="log-item-tags">${tags}</div>` : ''}`;
}

async function _getLogParentDir(log) {
  // Navigate from the root dir handle to the parent folder of this log file
  const parts = log.path.split('/');
  parts.pop(); // remove filename
  let dir = S.logOutputDirHandle;
  for (const seg of parts) {
    if (seg) dir = await dir.getDirectoryHandle(seg, { create: false });
  }
  return dir;
}

async function _ensureWritePermission(dirHandle) {
  const perm = await dirHandle.queryPermission({ mode: 'readwrite' });
  if (perm === 'granted') return true;
  const req = await dirHandle.requestPermission({ mode: 'readwrite' });
  return req === 'granted';
}

async function _openLogDetail(log) {
  // Always reload from disk to get latest content
  log.loaded = false;
  await _loadLogPreview(log);

  const raw = log._fullText || '';
  const bodyOnly = raw.replace(/^---[\s\S]*?---\r?\n?/m, '').trim();
  const displayBody = bodyOnly || log.preview || log.filename;

  const ov = document.createElement('div'); ov.className = 'modal-overlay';
  ov.innerHTML = `<div class="modal" style="max-height:88dvh;overflow-y:auto">
    <div class="modal-handle"></div>
    <div style="font-size:11px;font-family:var(--font-mono);color:var(--accent);margin-bottom:4px">${log.dateLabel || log.filename}</div>
    ${log.tags.length ? `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${log.tags.map(t=>`<span class="log-item-tag">#${t}</span>`).join('')}</div>` : ''}
    <div class="log-detail-body" id="ld-body" style="white-space:pre-wrap;word-break:break-word;font-size:13px;line-height:1.6;margin-bottom:16px">${displayBody.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</div>
    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="btn btn-ghost" style="flex:1;font-size:13px" id="ld-edit">‚úé Edit</button>
      <button class="btn btn-ghost" style="flex:1;font-size:13px;color:var(--danger);border-color:rgba(255,68,102,.3)" id="ld-delete">‚úï Delete</button>
      <button class="btn btn-ghost" style="flex:1;font-size:13px" id="ld-close">Close</button>
    </div>
  </div>`;
  document.body.appendChild(ov);
  const close = () => { if (ov.parentNode) document.body.removeChild(ov); };
  ov.addEventListener('click', e => { if (e.target === ov) close(); });
  ov.querySelector('#ld-close').addEventListener('click', close);

  // ‚îÄ‚îÄ Edit ‚îÄ‚îÄ
  ov.querySelector('#ld-edit').addEventListener('click', () => {
    close();
    _openLogEditor(log);
  });

  // ‚îÄ‚îÄ Delete ‚îÄ‚îÄ
  ov.querySelector('#ld-delete').addEventListener('click', async () => {
    if (!confirm(`Delete "${log.filename}"?\nThis cannot be undone.`)) return;
    const delBtn = ov.querySelector('#ld-delete');
    delBtn.disabled = true; delBtn.textContent = 'Deleting‚Ä¶';
    try {
      // ‚îÄ‚îÄ Always remove from IDB first (works on all platforms) ‚îÄ‚îÄ
      if (log.idbId) {
        try { await IDBLogs.delete(log.idbId); } catch(e) { console.warn('IDB delete failed:', e); }
      }

      // ‚îÄ‚îÄ Also remove from vault folder if handle is available ‚îÄ‚îÄ
      if (S.logOutputDirHandle && log.handle) {
        try {
          const dir = await _getLogParentDir(log);
          const ok = await _ensureWritePermission(dir);
          if (ok) await dir.removeEntry(log.filename);
        } catch(e) { console.warn('Folder delete failed (IDB already cleaned):', e); }
      }

      _allLogs = _allLogs.filter(l => l.path !== log.path);
      _logsApplyFilter();
      showToast('üóë Log deleted');
      close();
    } catch(e) {
      console.error('Delete failed', e);
      showToast('Delete failed: ' + e.message);
      delBtn.disabled = false; delBtn.textContent = '‚úï Delete';
    }
  });
}

// ‚îÄ‚îÄ LOG EDITOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _openLogEditor(log) {
  const ov = document.createElement('div'); ov.className = 'modal-overlay';
  const rawText = log._fullText || '';

  // ‚îÄ‚îÄ Extract current log text and tags from YAML frontmatter ‚îÄ‚îÄ
  const logMatch = rawText.match(/^log:\s*(.*)$/m);
  let currentLog = logMatch ? logMatch[1].replace(/^["']|["']$/g, '').trim() : '';

  // Parse all tags line-by-line (regex lookahead was stopping after first tag)
  let currentTags = [];
  const rawLines = rawText.split('\n');
  let inTagBlock = false;
  for (const line of rawLines) {
    if (/^tags:\s*$/.test(line)) { inTagBlock = true; continue; }
    if (inTagBlock) {
      const m = line.match(/^\s+-\s+(\S+)/);
      if (m) currentTags.push(m[1]);
      else if (line.trim() !== '' && !/^\s/.test(line)) break;
    }
  }
  // Rebuild into "log text #tag1 #tag2" format for the textarea
  const initialValue = currentLog + (currentTags.length ? ' ' + currentTags.map(t => '#' + t).join(' ') : '');

  ov.innerHTML = `<div class="modal" style="max-height:92dvh;overflow-y:auto">
    <div class="modal-handle"></div>
    <div style="font-size:14px;font-weight:800;margin-bottom:4px">‚úé Edit Log</div>
    <div style="font-size:10px;font-family:var(--font-mono);color:var(--muted);margin-bottom:4px">${log.path}</div>
    <div style="font-size:11px;font-family:var(--font-mono);color:var(--muted);margin-bottom:12px">Use #hashtags to tag your entry</div>
    <textarea id="le-body" placeholder="Your log text‚Ä¶ #tag1 #tag2"
      style="width:100%;min-height:140px;resize:vertical;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-family:var(--font-mono);font-size:14px;outline:none;line-height:1.6;margin-bottom:10px;transition:border-color .15s"></textarea>
    <div id="le-tag-preview" style="min-height:22px;margin-bottom:14px;display:flex;flex-wrap:wrap;gap:6px"></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1" id="le-cancel">Cancel</button>
      <button class="btn btn-green" style="flex:2" id="le-save">‚úì Save Changes</button>
    </div>
  </div>`;
  document.body.appendChild(ov);

  const ta = ov.querySelector('#le-body');
  const tagPreview = ov.querySelector('#le-tag-preview');
  ta.value = initialValue;

  function updateTagPreview() {
    const tags = (ta.value.match(/#[\w]+/g) || []);
    tagPreview.innerHTML = tags.map(t =>
      `<span style="background:rgba(0,255,136,.12);border:1px solid rgba(0,255,136,.3);border-radius:20px;padding:2px 10px;font-size:11px;font-family:var(--font-mono);color:var(--accent)">${t}</span>`
    ).join('');
  }
  updateTagPreview();
  ta.addEventListener('input', () => { updateTagPreview(); ta.style.borderColor = 'var(--accent)'; });
  ta.addEventListener('focus', () => ta.style.borderColor = 'var(--accent)');
  ta.addEventListener('blur',  () => ta.style.borderColor = 'var(--border)');

  const close = () => document.body.removeChild(ov);
  ov.addEventListener('click', e => { if (e.target === ov) close(); });
  ov.querySelector('#le-cancel').addEventListener('click', close);

  ov.querySelector('#le-save').addEventListener('click', async () => {
    const inputText = ta.value.trim();
    if (!inputText) { showToast('Write something first'); return; }
    const btn = ov.querySelector('#le-save');
    btn.disabled = true; btn.textContent = 'Saving‚Ä¶';

    try {
      // ‚îÄ‚îÄ Parse new log text + tags from user input ‚îÄ‚îÄ
      const { tags: newTags, cleaned: newLogText } = extractTagsFromText(inputText);
      const sanitizedLog = sanitizeForYAML(newLogText);
      const finalTags = newTags.length ? newTags : ['explore'];

      // ‚îÄ‚îÄ Rebuild YAML frontmatter cleanly ‚îÄ‚îÄ
      // Normalise line endings first
      const normRaw = rawText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      const fmMatch = normRaw.match(/^---\n([\s\S]*?)\n---/);
      let newFullText;
      if (fmMatch) {
        // Parse existing YAML lines, drop old log/tags, reinsert
        let yamlLines = fmMatch[1].split('\n');
        // Remove old log: line
        yamlLines = yamlLines.filter(l => !l.startsWith('log:'));
        // Remove old tags block
        const ti = yamlLines.findIndex(l => /^tags:\s*$/.test(l));
        if (ti !== -1) {
          let end = ti + 1;
          while (end < yamlLines.length && /^\s+-\s/.test(yamlLines[end])) end++;
          yamlLines.splice(ti, end - ti);
        }
        // Append updated log + tags
        yamlLines.push(`log: ${sanitizedLog}`);
        yamlLines.push('tags:');
        finalTags.forEach(t => yamlLines.push(`  - ${t}`));

        const bodyAfterFm = normRaw.slice(fmMatch[0].length); // everything after closing ---
        newFullText = '---\n' + yamlLines.join('\n') + '\n---' + bodyAfterFm;
      } else {
        // No frontmatter ‚Äî prepend one
        newFullText = `---\nlog: ${sanitizedLog}\ntags:\n${finalTags.map(t=>`  - ${t}`).join('\n')}\n---\n${normRaw}`;
      }

      // ‚îÄ‚îÄ Write: IDB first, then folder ‚îÄ‚îÄ
      // 1. Update IDB entry (always works)
      if (log.idbId) {
        try {
          const existing = await IDBLogs.get(log.idbId);
          if (existing) {
            existing.content = newFullText;
            existing.preview = sanitizedLog.slice(0, 120);
            existing.tags = finalTags;
            await IDBLogs.save(existing);
          }
        } catch(e) { console.warn('IDB log update failed:', e); }
      }

      // 2. Write to folder ‚Äî via file handle (known file) or folder path (IDB-only log)
      const writeToFolder = async () => {
        if (log.handle) {
          // File handle from folder scan ‚Äî write directly
          let perm = await log.handle.queryPermission({ mode: 'readwrite' }).catch(() => 'prompt');
          if (perm !== 'granted') perm = await log.handle.requestPermission({ mode: 'readwrite' }).catch(() => 'denied');
          if (perm !== 'granted') throw new Error('Permission denied on file handle');
          const w = await log.handle.createWritable({ keepExistingData: false });
          await w.write(newFullText);
          await w.close();
        } else if (S.logOutputDirHandle) {
          // IDB-only log ‚Äî navigate to folder and write
          const perm = await S.logOutputDirHandle.requestPermission({ mode: 'readwrite' });
          if (perm !== 'granted') throw new Error('Permission denied on output folder');
          const pathParts = log.path.split('/');
          const filename = pathParts.pop();
          let dir = S.logOutputDirHandle;
          for (const seg of pathParts) { if (seg) dir = await dir.getDirectoryHandle(seg, { create: true }); }
          const fh = await dir.getFileHandle(filename, { create: true });
          const w = await fh.createWritable({ keepExistingData: false });
          await w.write(newFullText);
          await w.close();
        }
      };
      try {
        await writeToFolder();
      } catch(e) {
        console.error('Folder log edit write failed:', e);
        S.logOutputDirHandle = null;
        showToast('\u26a0 Folder error ‚Äî reconnect vault in Settings');
      }

      // ‚îÄ‚îÄ Update in-memory cache ‚îÄ‚îÄ
      log._fullText = newFullText;
      log.loaded = false;
      await _loadLogPreview(log);
      const idx = _filteredLogs.indexOf(log);
      if (idx !== -1 && _logsNodes[idx]) _renderLogNode(_logsNodes[idx], log);
      showToast('‚úì Log saved');
      close();
    } catch(e) {
      console.error('Save failed', e);
      showToast('\u26a0 Save failed');
      btn.disabled = false; btn.textContent = '‚úì Save Changes';
    }
  });

  setTimeout(() => ta.focus(), 100);
}


function autoThemeForTime() { const h = new Date().getHours(); return (h >= 7 && h < 19) ? 'light' : 'dark'; }
function applyTheme(t) {
  LS.set('theme', t);
  const resolved = t === 'auto' ? autoThemeForTime() : t;
  document.documentElement.setAttribute('data-theme', resolved);
  const mc = document.querySelector('meta[name="theme-color"]');
  if (mc) mc.content = resolved === 'light' ? '#f2f2f7' : '#0a0a0f';
}
setInterval(() => { if ((LS.get('theme') || 'auto') === 'auto') applyTheme('auto'); }, 60000);

function isAndroid() { return /android/i.test(navigator.userAgent); }

function showSettings() {
  const ov=document.createElement('div'); ov.className='modal-overlay';
  const vaultName=LS.get('vaultFolderName')||'Not set';
  const vaultOk=!!S.vaultDirHandle;
  const np=S.notifPermission;
  const currentTheme = LS.get('theme') || 'auto';
  const hostedRemotely = !location.hostname.match(/^(localhost|127\.|192\.|10\.|file)/) && location.hostname !== '';
  const notifBlocked = np === 'denied';
  const android = isAndroid();
  const batteryDismissed = LS.get('batteryTipDismissed');

  const batterySection = (android && np === 'granted' && !batteryDismissed) ? `
    <div class="s-section">
      <div class="s-section-title">‚ö° Battery Optimization</div>
      <div style="background:rgba(255,170,0,.07);border:1px solid rgba(255,170,0,.25);border-radius:12px;padding:14px 16px;font-size:12px;font-family:var(--font-mono);color:var(--text);line-height:1.8">
        <div style="color:var(--warn);font-weight:700;margin-bottom:6px">üîã Enable for reliable background alarms</div>
        Android kills Chrome in the background to save battery ‚Äî this stops your alarms from firing when the screen is off.<br><br>
        <b style="color:var(--text)">Fix in 3 taps:</b><br>
        <span style="color:var(--accent)">1.</span> Settings ‚Üí Apps ‚Üí <b>Chrome</b><br>
        <span style="color:var(--accent)">2.</span> Battery ‚Üí <b>Unrestricted</b><br>
        <span style="color:var(--accent)">3.</span> Come back and tap "Done" below
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-ghost" id="s-battery-dismiss" style="flex:1;font-size:13px">‚úì Done / Dismiss</button>
        <button class="btn btn-green" id="s-battery-open" style="flex:2;font-size:13px">Open Android Settings</button>
      </div>
    </div>` : (android && np === 'granted' && batteryDismissed) ? `
    <div class="s-section">
      <div class="s-section-title">‚ö° Battery Optimization</div>
      <div class="s-row">
        <div><div class="s-label">Background Alarms</div><div class="s-sub">Chrome ‚Üí Battery ‚Üí Unrestricted</div></div>
        <span class="pill pill-green">SET ‚úì</span>
      </div>
      <button class="btn btn-ghost" id="s-battery-reset" style="width:100%;margin-top:8px;font-size:13px">Show instructions again</button>
    </div>` : '';

  const notifSection = notifBlocked ? `
    <div class="s-row">
      <div><div class="s-label">Push Alerts</div><div class="s-sub">Background alarm notifications</div></div>
      <span class="pill pill-red">BLOCKED</span>
    </div>
    <div class="notif-fix">
      ${hostedRemotely
        ? `<b>Blocked by your hosting provider.</b><br>Netlify and similar hosts disable notifications via HTTP headers. To fix:<br><br>
           1. Host the app locally instead (see Install Guide)<br>
           2. Or add <code>Permissions-Policy: notifications=(self)</code> to your Netlify <code>_headers</code> file`
        : `Notifications were blocked.<br><br>To unblock: <b>Chrome ‚Üí üîí lock icon ‚Üí Site settings ‚Üí Notifications ‚Üí Allow</b><br>Then reload.`
      }
    </div>` : np === 'default' ? `
    <div class="s-row">
      <div><div class="s-label">Push Alerts</div><div class="s-sub">Background alarm notifications</div></div>
      <span class="pill pill-amber">OFF</span>
    </div>
    <button class="btn btn-green" style="width:100%;margin-top:8px" id="s-notif">Enable Notifications</button>` : `
    <div class="s-row">
      <div><div class="s-label">Push Alerts</div><div class="s-sub">Background alarm notifications</div></div>
      <span class="pill pill-green">ON ‚úì</span>
    </div>`;

  const vaultName2 = LS.get('vaultFolderName') || 'vault';
  const backupSection = `<div class="s-section">
      <div class="s-section-title">Schedule Backups</div>
      <div class="s-row">
        <div>
          <div class="s-label">üìÅ ${vaultName2}/_backup/</div>
          <div class="s-sub">Up to 3 rotating backups saved here on every schedule change. Open in Obsidian or any text editor to restore manually.</div>
        </div>
      </div>
      ${S.vaultDirHandle ? `<button class="btn btn-ghost" style="width:100%;margin-top:8px" id="s-list-backups">View Schedule Backups</button>` : ''}
    </div>`;

  ov.innerHTML=`<div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Settings</div>

    <div class="s-section">
      <div class="s-section-title">üìÖ Calendar Heat Colors</div>
      <div style="font-size:12px;font-family:var(--font-mono);color:var(--muted);margin-bottom:12px;line-height:1.6">The calendar view colors each day based on how many tasks are scheduled ‚Äî from free to fully packed.</div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <div style="display:flex;align-items:center;gap:10px"><div class="cal-heat-0" style="width:22px;height:22px;border-radius:6px;flex-shrink:0;border:1px solid var(--border)"></div><div><div style="font-size:12px;font-weight:700">0 tasks</div><div style="font-size:10px;font-family:var(--font-mono);color:var(--muted)">Completely free</div></div></div>
        <div style="display:flex;align-items:center;gap:10px"><div class="cal-heat-1" style="width:22px;height:22px;border-radius:6px;flex-shrink:0;border:1px solid var(--border)"></div><div><div style="font-size:12px;font-weight:700">1‚Äì2 tasks</div><div style="font-size:10px;font-family:var(--font-mono);color:var(--muted)">Light day</div></div></div>
        <div style="display:flex;align-items:center;gap:10px"><div class="cal-heat-2" style="width:22px;height:22px;border-radius:6px;flex-shrink:0;border:1px solid var(--border)"></div><div><div style="font-size:12px;font-weight:700">3‚Äì4 tasks</div><div style="font-size:10px;font-family:var(--font-mono);color:var(--muted)">Moderate</div></div></div>
        <div style="display:flex;align-items:center;gap:10px"><div class="cal-heat-3" style="width:22px;height:22px;border-radius:6px;flex-shrink:0;border:1px solid var(--border)"></div><div><div style="font-size:12px;font-weight:700">5‚Äì6 tasks</div><div style="font-size:10px;font-family:var(--font-mono);color:var(--muted)">Busy</div></div></div>
        <div style="display:flex;align-items:center;gap:10px"><div class="cal-heat-4" style="width:22px;height:22px;border-radius:6px;flex-shrink:0;border:1px solid var(--border)"></div><div><div style="font-size:12px;font-weight:700">7‚Äì8 tasks</div><div style="font-size:10px;font-family:var(--font-mono);color:var(--muted)">Very busy</div></div></div>
        <div style="display:flex;align-items:center;gap:10px"><div class="cal-heat-5" style="width:22px;height:22px;border-radius:6px;flex-shrink:0;border:1px solid var(--border)"></div><div><div style="font-size:12px;font-weight:700">9‚Äì10 tasks</div><div style="font-size:10px;font-family:var(--font-mono);color:var(--muted)">Packed</div></div></div>
        <div style="display:flex;align-items:center;gap:10px"><div class="cal-heat-6" style="width:22px;height:22px;border-radius:6px;flex-shrink:0;border:1px solid var(--border)"></div><div><div style="font-size:12px;font-weight:700">11+ tasks</div><div style="font-size:10px;font-family:var(--font-mono);color:var(--muted)">Max load ‚Äî fully packed</div></div></div>
      </div>
      <div style="margin-top:10px;padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;font-size:11px;font-family:var(--font-mono);color:var(--muted);line-height:1.6">
        üí° <b style="color:var(--text)">Tip:</b> Tap any day in the calendar to see its tasks broken down by Daily / Weekly / Monthly / Custom tabs below.
      </div>
    </div>

    <div class="s-section">
      <div class="s-section-title">Appearance</div>
      <div class="s-row" style="flex-direction:column;align-items:stretch;gap:10px">
        <div class="s-label">Theme</div>
        <div class="theme-seg" id="theme-seg">
          <button class="theme-seg-btn${currentTheme==='auto'?' active':''}" data-theme="auto">‚òÄÔ∏é/üåô Auto</button>
          <button class="theme-seg-btn${currentTheme==='dark'?' active':''}" data-theme="dark">üåô Dark</button>
          <button class="theme-seg-btn${currentTheme==='light'?' active':''}" data-theme="light">‚òÄÔ∏é Light</button>
        </div>
      </div>
    </div>

    <div class="s-section">
      <div class="s-section-title">‚ñ∂ Focus Timer</div>
      <div class="s-row">
        <div><div class="s-label">Focus selector range</div><div class="s-sub">Max minutes shown in the Focus drum</div></div>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="s-pomo-focus-max" min="1" max="120" value="${pomoGetSettings().focusMaxMins || 60}" style="width:56px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 8px;color:var(--text);font-family:var(--font-mono);font-size:14px;font-weight:700;text-align:center;outline:none"/>
          <span style="font-size:11px;font-family:var(--font-mono);color:var(--muted)">min</span>
        </div>
      </div>
      <div class="s-row">
        <div><div class="s-label">Break selector range</div><div class="s-sub">Max minutes shown in the Break drum</div></div>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="s-pomo-break-max" min="1" max="60" value="${pomoGetSettings().breakMaxMins || 15}" style="width:56px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 8px;color:var(--text);font-family:var(--font-mono);font-size:14px;font-weight:700;text-align:center;outline:none"/>
          <span style="font-size:11px;font-family:var(--font-mono);color:var(--muted)">min</span>
        </div>
      </div>
    </div>

    <div class="s-section">
      <div class="s-section-title">Vault Folder</div>
      <div class="s-row">
        <div><div class="s-label">üìÅ ${vaultName}</div><div class="s-sub">All subfolders are derived automatically from this vault root</div></div>
        <span class="pill ${vaultOk?'pill-green':'pill-amber'}">${vaultOk?'LIVE':'OFFLINE'}</span>
      </div>
      <button class="btn btn-ghost" style="width:100%;margin-top:8px" id="s-change-vault">Change Vault Folder</button>
    </div>

    <div class="s-section">
      <div class="s-section-title">üìÇ Vault Subfolders</div>
      <div style="font-size:11px;font-family:var(--font-mono);color:var(--muted);background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;line-height:2.2">
        <div>üìÅ <span style="color:var(--text)">Habit Tracker:</span> ${vaultName}/0 - Personal Space/Habit Tracker</div>
        <div>üìÅ <span style="color:var(--text)">Log Output:</span> ${vaultName}/0 - Personal Space/Chrono Log/data</div>
        <div>üìÑ <span style="color:var(--text)">Log Template:</span> _Daily_Log_Template.md <span style="color:var(--muted)">(in Log Output)</span></div>
        <div>üìÅ <span style="color:var(--text)">Events:</span> ${vaultName}/0 - Personal Space/Events</div>
      </div>
      <div class="s-row" style="margin-top:10px">
        <div><div class="s-label">Habit Tracker</div></div>
        <span class="pill ${S.habitTrackerDirHandle?'pill-green':'pill-amber'}">${S.habitTrackerDirHandle?'‚úì':'‚Äì'}</span>
      </div>
      <div class="s-row">
        <div><div class="s-label">Log Output</div></div>
        <span class="pill ${S.logOutputDirHandle?'pill-green':'pill-amber'}">${S.logOutputDirHandle?'‚úì':'‚Äì'}</span>
      </div>
      <div class="s-row">
        <div><div class="s-label">Log Template</div></div>
        <span class="pill ${S.logTemplateHandle?'pill-green':'pill-amber'}">${S.logTemplateHandle?'‚úì':'‚Äì'}</span>
      </div>
      <div class="s-row">
        <div><div class="s-label">Events</div></div>
        <span class="pill ${S.eventsDirHandle?'pill-green':'pill-amber'}">${S.eventsDirHandle?'‚úì':'‚Äì'}</span>
      </div>
    </div>

    <div class="s-section">
      <div class="s-section-title">Daily Log</div>
      <div class="s-row" style="flex-direction:column;align-items:stretch;gap:6px">
        <div>
          <div class="s-label">üìÇ Output File Format</div>
          <div class="s-sub">Obsidian-style date tokens. Use / for subfolders.</div>
        </div>
        <input class="fmt-input" id="s-log-fmt" type="text" value="${LS.get('logOutputFormat') || '{{date:YYYY}}/{{date:YYYYMMDDHHmmss}}'}" placeholder="{{date:YYYY}}/{{date:YYYYMMDDHHmmss}}" autocomplete="off" spellcheck="false"/>
        <div class="fmt-hint">Tokens: {{date:YYYY}} {{date:MM}} {{date:DD}} {{date:HH}} {{date:mm}} {{date:ss}}<br>Example ‚Üí <span id="s-fmt-preview"></span></div>
      </div>
    </div>

    <div class="s-section">
      <div class="s-section-title">Notifications</div>
      ${notifSection}
    </div>

    ${batterySection}

    ${backupSection}

    <div class="s-section">
      <div class="s-section-title">App</div>
      <button class="btn btn-ghost" style="width:100%" id="s-install">üì≤ Install Guide</button>
    </div>
    <div class="s-section">
      <div class="s-section-title">Danger Zone</div>
      <button class="btn btn-ghost" style="width:100%;color:var(--danger);border-color:rgba(255,68,102,.3)" id="s-clear">Clear All Data &amp; Reset</button>
    </div>
    <button class="btn btn-ghost" style="width:100%" id="s-close">Close</button>
  </div>`;
  document.body.appendChild(ov);
  const close=()=>document.body.removeChild(ov);
  ov.addEventListener('click',e=>{ if(e.target===ov) close(); });
  ov.querySelector('#s-close').addEventListener('click',close);
  ov.querySelector('#s-change-vault').addEventListener('click',async()=>{ close(); const ok=await pickVaultFolder(); if(ok){ await loadFromVault(); renderAll(); }});


  // ‚îÄ‚îÄ Output format live preview + save ‚îÄ‚îÄ
  const fmtIn = ov.querySelector('#s-log-fmt');
  const fmtPrev = ov.querySelector('#s-fmt-preview');
  function updateFmtPreview() {
    const raw = fmtIn.value.trim() || '{{date:YYYY}}/{{date:YYYYMMDDHHmmss}}';
    try {
      const preview = applyDateFormat(raw, new Date()) + '.md';
      fmtPrev.textContent = preview;
      fmtPrev.style.color = 'var(--accent)';
    } catch { fmtPrev.textContent = 'invalid format'; fmtPrev.style.color = 'var(--danger)'; }
  }
  updateFmtPreview();
  fmtIn.addEventListener('input', () => {
    updateFmtPreview();
    LS.set('logOutputFormat', fmtIn.value.trim() || '{{date:YYYY}}/{{date:YYYYMMDDHHmmss}}');
  });
  ov.querySelector('#s-notif')?.addEventListener('click',async()=>{ S.notifPermission=await Notification.requestPermission(); close(); showSettings(); });
  ov.querySelector('#s-install').addEventListener('click',()=>{ close(); showInstallGuide(); });
  // Battery optimization buttons
  ov.querySelector('#s-battery-open')?.addEventListener('click',()=>{
    // Deep-link into Android settings ‚Äî works on most Android versions
    // This opens the app info page for Chrome; user taps Battery themselves
    try { location.href = 'intent:#Intent;action=android.settings.APPLICATION_DETAILS_SETTINGS;data=package:com.android.chrome;end'; }
    catch { showToast('Go to Settings ‚Üí Apps ‚Üí Chrome ‚Üí Battery'); }
    showToast('Settings opened ‚Äî tap Battery ‚Üí Unrestricted');
  });
  ov.querySelector('#s-battery-dismiss')?.addEventListener('click',()=>{ LS.set('batteryTipDismissed', true); close(); showSettings(); });
  ov.querySelector('#s-battery-reset')?.addEventListener('click',()=>{ LS.del('batteryTipDismissed'); close(); showSettings(); });
  ov.querySelector('#s-clear').addEventListener('click',()=>{
    if (confirm('Clear all app data and reset?')) {
      IDB.del('vaultHandle').catch(()=>{});
      localStorage.clear();
      location.reload();
    }
  });
  // Theme segment
  ov.querySelectorAll('.theme-seg-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      ov.querySelectorAll('.theme-seg-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyTheme(btn.dataset.theme);
    });
  });
  // ‚îÄ‚îÄ Focus timer range settings ‚îÄ‚îÄ
  const pomoFocusMaxIn = ov.querySelector('#s-pomo-focus-max');
  const pomoBreakMaxIn = ov.querySelector('#s-pomo-break-max');
  function savePomoDurations() {
    const prev = pomoGetSettings();
    const fm = Math.max(1, Math.min(120, parseInt(pomoFocusMaxIn.value) || 60));
    const bm = Math.max(1, Math.min(60,  parseInt(pomoBreakMaxIn.value) || 15));
    LS.set('pomoSettings', { ...prev, focusMaxMins: fm, breakMaxMins: bm });
  }
  pomoFocusMaxIn?.addEventListener('change', savePomoDurations);
  pomoBreakMaxIn?.addEventListener('change', savePomoDurations);

  // Vault backup list
  ov.querySelector('#s-list-backups')?.addEventListener('click', async () => {
    close();
    await showVaultBackups();
  });
}

// ‚îÄ‚îÄ INSTALL GUIDE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showInstallGuide() {
  const ov = document.createElement('div'); ov.className='install-guide';
  ov.innerHTML=`<div class="install-modal">
    <div class="modal-handle"></div>
    <div style="font-size:20px;font-weight:800;margin-bottom:6px">üì≤ Install as App</div>
    <div style="font-size:12px;font-family:var(--font-mono);color:var(--muted);margin-bottom:20px;line-height:1.6">
      Install once ‚Äî runs offline, no browser chrome, lives on your home screen / taskbar.
    </div>

    <div class="platform-tabs">
      <button class="ptab active" data-p="local">üíª Local (Best)</button>
      <button class="ptab" data-p="chrome">Chrome Desktop</button>
      <button class="ptab" data-p="android">Android</button>
      <button class="ptab" data-p="ios">iOS</button>
    </div>

    <!-- LOCAL (recommended) -->
    <div class="platform-steps active" id="steps-local">
      <div style="background:rgba(0,255,136,.07);border:1px solid rgba(0,255,136,.2);border-radius:10px;padding:12px 14px;font-size:12px;font-family:var(--font-mono);color:var(--accent);line-height:1.6;margin-bottom:16px">
        ‚ú¶ Recommended. Runs fully offline, notifications work, zero hosting needed.
      </div>
      <div class="install-step">
        <div class="install-num">1</div>
        <div class="install-text">Put all 4 files (<b>index.html</b>, <b>sw.js</b>, <b>manifest.json</b>, <b>icon.svg</b>) in one folder on your computer.
          <small>e.g. C:\Users\You\HabitTracker\ or ~/HabitTracker/</small>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">2</div>
        <div class="install-text">Install <b>Node.js</b> (nodejs.org) if you don't have it. Then open Terminal / Command Prompt and run:
          <div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-top:8px;font-size:11px;font-family:var(--font-mono);color:var(--accent)">npx serve C:\path\to\your\folder</div>
          <small>Or on Mac/Linux: <code>npx serve ~/HabitTracker</code></small>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">3</div>
        <div class="install-text">Open <b>http://localhost:3000</b> in Chrome or Edge.
          <small>Keep the terminal running in background ‚Äî it's your local server.</small>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">4</div>
        <div class="install-text">In Chrome, click the <b>‚äï install icon</b> in the address bar (right side) ‚Üí <b>"Install Vault Dex"</b>.
          <small>The app now appears in your Start Menu / Applications and opens as a standalone window.</small>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">5</div>
        <div class="install-text">First launch: tap <b>"Choose Vault Folder"</b> ‚Üí pick your Obsidian vault. Done ‚Äî notifications will work fully.
          <small>On every subsequent launch, tap the amber "Reconnect" button once to re-grant file access.</small>
        </div>
      </div>
    </div>

    <!-- CHROME DESKTOP -->
    <div class="platform-steps" id="steps-chrome">
      <div class="notif-fix" style="margin-bottom:16px;margin-top:0">
        ‚ö† If hosted on Netlify, notifications will be blocked by their server headers. Use Local method for full functionality.
      </div>
      <div class="install-step">
        <div class="install-num">1</div>
        <div class="install-text">Open the app URL in <b>Chrome</b> or <b>Edge</b> on your computer.</div>
      </div>
      <div class="install-step">
        <div class="install-num">2</div>
        <div class="install-text">Look for the <b>‚äï</b> icon in the address bar (far right). Click it.
          <small>If you don't see it, go to Chrome menu ‚ãÆ ‚Üí "Save and Share" ‚Üí "Install Vault Dex‚Ä¶"</small>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">3</div>
        <div class="install-text">Click <b>"Install"</b> in the popup. The app opens in its own window and gets added to your taskbar / Start Menu.</div>
      </div>
      <div class="install-step">
        <div class="install-num">4</div>
        <div class="install-text">To enable notifications: click the <b>üîí lock icon</b> in the address bar ‚Üí <b>Notifications ‚Üí Allow</b>. Then reload.</div>
      </div>
    </div>

    <!-- ANDROID -->
    <div class="platform-steps" id="steps-android">
      <div class="install-step">
        <div class="install-num">1</div>
        <div class="install-text">Open the app in <b>Chrome for Android</b>.</div>
      </div>
      <div class="install-step">
        <div class="install-num">2</div>
        <div class="install-text">Tap Chrome's <b>‚ãÆ menu</b> ‚Üí <b>"Add to Home Screen"</b> ‚Üí <b>"Add"</b>.
          <small>The ‚è∞ icon appears on your home screen and opens in full-screen standalone mode.</small>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">3</div>
        <div class="install-text">Allow notifications when prompted. If blocked: <b>Settings ‚Üí Apps ‚Üí Chrome ‚Üí Notifications ‚Üí Allow</b>.</div>
      </div>
      <div class="install-step">
        <div class="install-num">4</div>
        <div class="install-text"><b>Allow background alarms (important!)</b><br>
          Go to <b>Settings ‚Üí Apps ‚Üí Chrome ‚Üí Battery ‚Üí Unrestricted</b>.
          <small>Without this, Android kills Chrome in the background and your alarms won't fire when the screen is off.</small>
          <div style="background:rgba(255,170,0,.08);border:1px solid rgba(255,170,0,.25);border-radius:8px;padding:10px 12px;margin-top:8px;font-size:11px;font-family:var(--font-mono);color:var(--warn);line-height:1.6">
            ‚ö† "Optimized" (Android default) = alarms may be delayed or skipped<br>
            ‚úì "Unrestricted" = alarms fire reliably even with screen off
          </div>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">5</div>
        <div class="install-text"><b>Note:</b> Android Chrome supports File System Access API ‚Äî vault folder and file writing works fully.
          <small>Tap "Reconnect" once each time you open the app to re-grant write access.</small>
        </div>
      </div>
    </div>

    <!-- iOS -->
    <div class="platform-steps" id="steps-ios">
      <div class="notif-fix" style="margin-bottom:16px;margin-top:0">
        ‚ö† iOS Safari does <b>not</b> support the File System Access API. The vault folder cannot be read or written on iPhone/iPad. Habits will save to browser storage only.
      </div>
      <div class="install-step">
        <div class="install-num">1</div>
        <div class="install-text">Open the app in <b>Safari</b> on iPhone or iPad.</div>
      </div>
      <div class="install-step">
        <div class="install-num">2</div>
        <div class="install-text">Tap the <b>Share button</b> (box with arrow) at the bottom of Safari.</div>
      </div>
      <div class="install-step">
        <div class="install-num">3</div>
        <div class="install-text">Scroll down and tap <b>"Add to Home Screen"</b> ‚Üí <b>"Add"</b>.
          <small>The ‚è∞ icon appears on your home screen.</small>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">4</div>
        <div class="install-text">Push notifications are <b>supported on iOS 16.4+</b> when installed as a PWA. When the app opens, tap <b>Allow</b> when prompted for notifications.</div>
      </div>
    </div>

    <button class="btn btn-ghost" style="width:100%;margin-top:20px" id="ig-close">Close</button>
  </div>`;
  document.body.appendChild(ov);
  ov.addEventListener('click', e=>{ if(e.target===ov) document.body.removeChild(ov); });
  ov.querySelector('#ig-close').addEventListener('click', ()=>document.body.removeChild(ov));
  // Platform tab switching
  ov.querySelectorAll('.ptab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      ov.querySelectorAll('.ptab').forEach(t=>t.classList.remove('active'));
      ov.querySelectorAll('.platform-steps').forEach(s=>s.classList.remove('active'));
      tab.classList.add('active');
      ov.querySelector('#steps-'+tab.dataset.p).classList.add('active');
    });
  });
}


function showToast(msg) {
  document.querySelector('.toast')?.remove();
  const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
  document.body.appendChild(t); setTimeout(()=>t.remove(),2500);
}

// ‚îÄ‚îÄ FIRST-RUN SETUP SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showFirstRunSetup() {
  document.getElementById('setup-screen')?.remove();
  const sc=document.createElement('div'); sc.className='setup-screen'; sc.id='setup-screen';
  sc.innerHTML=`<div class="setup-inner">
    <div class="setup-icon">üìá</div>
    <div class="setup-title">Vault Dex</div>
    <div class="setup-desc">Select your Obsidian vault folder. The app finds your .md config there, then reads and writes your daily habit data directly to it.</div>
    <button class="btn btn-green" id="fs-pick" style="width:100%;font-size:16px;padding:16px 22px">üìÅ Choose Vault Folder</button>
    <div class="setup-note">
      <b>One-time setup.</b> The folder is remembered. On each app launch you'll see a small "Reconnect" button ‚Äî one tap re-grants write access (browser security requirement).<br><br>
      <b>Folder structure expected:</b><br>
      üìÅ YourVault/<br>
      &nbsp;&nbsp;üìÑ your-config.md<br>
      &nbsp;&nbsp;üìÅ data/ ‚Üê daily files written here<br><br>
      To install as a standalone app, tap <b>‚öô Settings ‚Üí Install Guide</b> after setup.
    </div>
  </div>`;
  document.body.appendChild(sc);
  sc.querySelector('#fs-pick').addEventListener('click', async()=>{
    const ok = await pickVaultFolder();
    if (ok) {
      sc.remove();
      await loadFromVault();
      renderAll();
      showToast('‚úì Vault connected');
    }
  });
}

// ‚îÄ‚îÄ RECONNECT BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showReconnectBanner() {
  const area = document.getElementById('reconnect-area');
  const name = LS.get('vaultFolderName') || 'vault';
  area.innerHTML = `<div class="reconnect-banner">
    <div class="rb-text">üìÅ ${name} needs access<div class="rb-sub">Tap once to reconnect ‚Äî won't ask again this session</div></div>
    <button class="reconnect-btn" id="rb-btn">Reconnect</button>
  </div>`;
  area.querySelector('#rb-btn').addEventListener('click', async () => {
    const ok = await reconnectVault();
    if (ok) {
      await loadFromVault();
      renderAll();
      showToast('‚úì Vault reconnected');
    } else {
      showToast('Could not reconnect ‚Äî try Settings ‚Üí Change Vault');
    }
  });
}

// ‚îÄ‚îÄ BATTERY OPTIMIZATION BANNER (Android only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showBatteryBanner() {
  if (!isAndroid()) return;
  if (S.notifPermission !== 'granted') return;
  if (LS.get('batteryTipDismissed')) return;
  const area = document.getElementById('reconnect-area');
  // Don't replace reconnect banner if it's already showing
  if (area.querySelector('.reconnect-banner')) return;

  const existing = area.querySelector('.battery-banner');
  if (existing) return; // already shown

  const banner = document.createElement('div');
  banner.className = 'battery-banner';
  banner.style.cssText = 'margin:12px 20px 0;background:rgba(255,170,0,.07);border:1px solid rgba(255,170,0,.2);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:12px;animation:fadeUp .3s ease';
  banner.innerHTML = `
    <div style="flex:1;font-size:12px;color:var(--warn);font-family:var(--font-mono);line-height:1.5">
      üîã <b>Enable background alarms</b>
      <div style="font-size:11px;color:var(--muted);margin-top:2px">Settings ‚Üí Apps ‚Üí Chrome ‚Üí Battery ‚Üí <b>Unrestricted</b></div>
    </div>
    <button id="bb-settings" style="padding:7px 12px;background:var(--warn);color:#000;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;flex-shrink:0;font-family:var(--font-display)">Fix it</button>
    <button id="bb-dismiss" style="padding:7px 10px;background:transparent;border:1px solid rgba(255,170,0,.3);border-radius:8px;font-size:12px;color:var(--muted);cursor:pointer;flex-shrink:0;font-family:var(--font-mono)">‚úï</button>`;
  area.appendChild(banner);

  banner.querySelector('#bb-settings').addEventListener('click', () => {
    showSettings();
  });
  banner.querySelector('#bb-dismiss').addEventListener('click', () => {
    LS.set('batteryTipDismissed', true);
    banner.remove();
  });
}


function buildSkeleton() {
  document.getElementById('main-content').innerHTML=`
    <div class="card" id="card-countdown" style="animation-delay:0s">
      <div class="card-header" style="display:flex;align-items:center;justify-content:space-between">
        <span class="card-label">Now</span>
        <button class="pomo-btn" id="pomo-btn" title="Focus Timer"><div class="pomo-dot"></div></button>
      </div>
      <div class="card-body" style="padding:0">
        <div style="display:flex;min-height:0">
          <div id="countdown-left" style="flex:1;min-width:0;padding:14px 16px 16px;border-right:1px solid var(--border)"></div>
          <div id="countdown-event" style="width:120px;flex-shrink:0;padding:12px 10px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;gap:4px;cursor:pointer" id="countdown-event"></div>
        </div>
      </div>
    </div>
    <div class="card" id="card-log" style="animation-delay:.05s">
      <div class="card-header"><span class="card-label">Log</span></div>
      <div class="card-body">
        <div style="display:flex;gap:10px">
          <button id="log-text-btn" style="flex:1;min-width:0;padding:14px 10px;border-radius:12px;border:1px solid var(--border);background:var(--bg3);color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .15s;font-size:13px;font-family:var(--font-display);font-weight:700" title="Text Log">
            <span style="font-size:22px;line-height:1;flex-shrink:0">üìù</span><span>Log</span>
          </button>
          <button id="log-audio-btn" style="flex:1;min-width:0;padding:14px 10px;border-radius:12px;border:1px solid var(--border);background:var(--bg3);color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .15s;font-size:13px;font-family:var(--font-display);font-weight:700" title="Audio Log">
            <span style="font-size:22px;line-height:1;flex-shrink:0">üìã</span><span>Archive</span>
          </button>
        </div>
      </div>
    </div>
    <div class="card" id="card-habits" style="animation-delay:.08s">
      <div class="card-header" id="habits-card-header">
        <span class="card-label">Habits</span>
        <div style="display:flex;align-items:center;gap:10px">
          <span id="habit-edit-btn" style="font-size:12px;color:var(--muted);cursor:pointer;font-family:var(--font-mono)">‚úé edit</span>
        </div>
      </div>
      <div class="card-body"></div>
      <div id="habit-done-ledge" style="display:none;border-top:1px solid var(--border)">
        <button class="habit-done-pill" id="habit-done-pill" style="display:flex;width:100%;border-radius:0 0 var(--radius) var(--radius);padding:10px 16px;justify-content:center;font-size:12px">‚úì Done Editing</button>
      </div>
    </div>`;


  // ‚îÄ‚îÄ Log text button ‚îÄ‚îÄ
  document.getElementById('log-text-btn')?.addEventListener('click', () => showLogTextPopup());
  document.getElementById('log-audio-btn')?.addEventListener('click', () => showLogsPopup());
  document.getElementById('pomo-btn')?.addEventListener('click', showPomoPopup);
  document.getElementById('habit-edit-btn')?.addEventListener('click', ()=>{
    S._habitEditMode = !S._habitEditMode;
    renderHabitBars();
  });
  document.getElementById('habit-done-pill')?.addEventListener('click', ()=>{
    S._habitEditMode = false;
    renderHabitBars();
  });

  const panels = document.getElementById('tab-panels');
  const panelEls = panels.querySelectorAll('.tab-panel');
  // Init: tab 0 active, tab 1 to the right (default via CSS)
  panelEls[0].classList.add('active');

  let activeTab = 0;
  let editMode = false;

  // ‚îÄ‚îÄ Done FAB (visible only in edit mode) ‚îÄ‚îÄ
  const fab = document.createElement('button');
  fab.className = 'edit-fab';
  fab.id = 'schedule-edit-fab';
  fab.innerHTML = 'Done';
  fab.title = 'Save and exit edit';
  fab.style.display = 'none';
  document.body.appendChild(fab);

  // ‚îÄ‚îÄ Add FAB (only in edit mode) ‚îÄ‚îÄ
  const addFab = document.createElement('button');
  addFab.className = 'add-fab';
  addFab.id = 'schedule-add-fab';
  addFab.innerHTML = 'Add';
  addFab.title = 'Add entry';
  document.body.appendChild(addFab);

  addFab.addEventListener('click', () => {
    showAddScheduleSheet(() => { renderScheduleTab(true); });
  });

  function commitEdits(showMsg) {
    const before = JSON.stringify(_scheduleSnapshot || []);
    const after = JSON.stringify(S.config?.schedule || []);
    if (before !== after) {
      saveScheduleToVault();
      forceSwUpdate();
    }
    _scheduleSnapshot = null;
    if (showMsg) showToast('‚úì Schedule saved');
  }

  function enterEditMode() {
    if (editMode) return;
    _scheduleSnapshot = JSON.parse(JSON.stringify(S.config?.schedule || []));
    editMode = true;
    fab.classList.add('editing');
    addFab.classList.add('visible');
    fab.style.display = 'flex';
    renderScheduleTab(true);
    showToast('Edit mode ‚Äî long-press to exit');
  }

  function exitEditMode() {
    if (!editMode) return;
    commitEdits(true);
    editMode = false;
    fab.classList.remove('editing');
    addFab.classList.remove('visible');
    fab.style.display = 'none';
    renderScheduleTab(false);
    renderCountdown();
  }

  // Done FAB ‚Üí exit edit mode
  fab.addEventListener('click', exitEditMode);

  // Expose for empty-state long-press
  S._enterSchedEdit = enterEditMode;

  function updatePanelClasses(idx) {
    panelEls.forEach((p, i) => {
      p.classList.toggle('active', i === idx);
      p.classList.toggle('left',   i < idx);
    });
  }

  function switchTab(idx) {
    if (idx === activeTab) return;
    if (S._habitEditMode) { S._habitEditMode = false; renderHabitBars(); }
    if (activeTab === 1 && editMode) exitEditMode();
    activeTab = idx;
    updatePanelClasses(idx);
    document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
    fab.style.display = (idx === 1 && editMode) ? 'flex' : 'none';
    addFab.classList.toggle('visible', idx === 1 && editMode);
    if (idx === 1) renderScheduleTab(false);
  }

  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => switchTab(parseInt(btn.dataset.tab)));
  });

  // ‚îÄ‚îÄ Swipe between tabs ‚îÄ‚îÄ
  // Panels are absolute, full-width. CSS classes (.active / .left) position them.
  // During a drag we offset EACH panel by the same dx using a data attribute + inline style.
  let swipeStartX = 0, swipeStartY = 0;
  let swipeTracking = false, swipeDecided = false;

  function applyDragOffset(dx) {
    panelEls.forEach(p => {
      p.classList.add('dragging');
      p.style.marginLeft = dx + 'px';
    });
  }

  function clearDragOffset() {
    panelEls.forEach(p => {
      p.classList.remove('dragging');
      p.style.marginLeft = '';
    });
  }

  panels.addEventListener('touchstart', e => {
    swipeStartX = e.touches[0].clientX;
    swipeStartY = e.touches[0].clientY;
    swipeTracking = false;
    swipeDecided  = false;
  }, { passive: true });

  panels.addEventListener('touchmove', e => {
    const dx = e.touches[0].clientX - swipeStartX;
    const dy = e.touches[0].clientY - swipeStartY;

    if (!swipeDecided) {
      if (Math.abs(dx) < 5 && Math.abs(dy) < 5) return;
      swipeDecided  = true;
      swipeTracking = Math.abs(dx) >= Math.abs(dy);
    }
    if (!swipeTracking) return;

    // Clamp: can't pull right on tab 0, can't pull left on last tab
    const clampedDx = activeTab === 0 ? Math.min(0, dx)
                    : activeTab === 1 ? Math.max(0, dx)
                    : dx;
    applyDragOffset(clampedDx);
  }, { passive: true });

  panels.addEventListener('touchend', e => {
    if (!swipeTracking) return;
    swipeTracking = false;
    swipeDecided  = false;
    const dx = e.changedTouches[0].clientX - swipeStartX;
    clearDragOffset();
    if (Math.abs(dx) > 50) {
      switchTab(dx < 0 ? Math.min(1, activeTab + 1) : Math.max(0, activeTab - 1));
    }
  }, { passive: true });

  panels.addEventListener('touchcancel', () => {
    swipeTracking = false;
    swipeDecided  = false;
    clearDragOffset();
  }, { passive: true });

  S._switchTab = switchTab;
  S._getEditMode = () => editMode;
  S._getActiveTab = () => activeTab;

  // Re-snap on resize/orientation change
}

function renderAll() {
  renderCountdown();
  renderHabitBars();
  // Only re-render schedule tab if it's currently visible
  if (S._getActiveTab && S._getActiveTab() === 1) {
    renderScheduleTab(S._getEditMode ? S._getEditMode() : false);
  }
  // Keep SW alarm store in sync
  syncAlarmsToSW();
}

function startTimers() {
  if (S.countdownInterval) clearInterval(S.countdownInterval);
  if (S.checkInterval) clearInterval(S.checkInterval);
  S.countdownInterval=setInterval(()=>{
    tickCountdown();
    if (new Date().getSeconds()===0) {
      renderCountdown();
      if (S._getActiveTab && S._getActiveTab()===1) renderScheduleTab(S._getEditMode?S._getEditMode():false);
    }
  }, 1000);
  S.checkInterval=setInterval(checkAlarms, 2000);
}

async function fetchNepaliDate() {
  // Pure JS Nepali date conversion (BS) ‚Äî works fully offline
  // Uses the Bikram Sambat calendar algorithm
  try {
    const now = new Date();
    const yy = now.getFullYear(), mm = now.getMonth() + 1, dd = now.getDate();

    // BS year data: [days in each month] for BS years 2000-2089
    // Each entry: total days in that BS year's months
    const bsData = {
      2082: [31,32,31,32,31,30,30,30,29,29,30,31],
      2083: [31,31,32,31,31,30,30,30,29,30,30,30],
      2084: [31,31,32,31,31,30,30,30,29,30,30,30],
      2085: [31,32,31,32,30,31,30,29,30,29,30,30],
    };
    const bsMonths = ['Baishakh','Jestha','Ashadh','Shrawan','Bhadra','Ashwin','Kartik','Mangsir','Poush','Magh','Falgun','Chaitra'];

    // Known anchor: 2082 Baishakh 1 = 2025 April 14
    const anchor = new Date(2025, 3, 14); // April 14, 2025 = 2082/01/01
    const diffDays = Math.floor((now - anchor) / 86400000);

    let bsYear = 2082, bsMonth = 1, bsDay = 1;
    let remaining = diffDays;

    outer:
    for (let y = 2082; y <= 2090; y++) {
      const months = bsData[y] || [31,31,32,31,31,31,30,30,29,29,30,30];
      for (let m = 0; m < 12; m++) {
        const daysInMonth = months[m];
        if (remaining < daysInMonth) {
          bsYear = y; bsMonth = m + 1; bsDay = 1 + remaining;
          break outer;
        }
        remaining -= daysInMonth;
      }
    }

    return `${bsMonths[bsMonth - 1]} ${bsDay}, ${bsYear}`;
  } catch { return null; }
}

function updateHeaderDate() {
  const el=document.getElementById('header-date');
  if (!el) return;
  const engDate = new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'}).toUpperCase();
  el.textContent = engDate;
  // Fetch Nepali date asynchronously
  fetchNepaliDate().then(nepDate => {
    if (nepDate && el) el.textContent = engDate + ' / ' + nepDate.toUpperCase();
  });
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function boot() {
  // Apply saved theme immediately
  applyTheme(LS.get('theme') || 'auto');

  // Handle habit action from notification click when app was closed
  const urlParams = new URLSearchParams(location.search);
  const pendingHabit = urlParams.get('ha');
  if (pendingHabit) {
    try {
      const { habitKey, habitVal } = JSON.parse(decodeURIComponent(pendingHabit));
      if (habitKey && habitVal !== undefined) {
        setTimeout(() => { updateHabit(habitKey, habitVal); showToast(`‚úì ${habitKey} logged`); }, 1500);
      }
    } catch {}
    // Clean URL
    history.replaceState({}, '', location.pathname);
  }

  updateHeaderDate();
  setInterval(updateHeaderDate, 60000);

  // Midnight reload of habit data
  const msUntilMidnight=()=>{ const n=new Date(),m=new Date(n); m.setHours(24,0,0,0); return m-n; };
  setTimeout(()=>{ loadFromVault().then(renderHabitBars); setInterval(()=>loadFromVault().then(renderHabitBars), 86400000); }, msUntilMidnight());

  if ('serviceWorker' in navigator) {
    const swReg = await navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(console.error);

    // ‚îÄ‚îÄ App update banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Shows a non-intrusive banner when a new SW version is waiting (i.e. new
    // files deployed to GitHub Pages). User taps "Update" to reload cleanly.
    function showUpdateBanner(waitingSW) {
      const area = document.getElementById('update-banner-area');
      if (!area || area.querySelector('.update-banner')) return; // already shown
      const banner = document.createElement('div');
      banner.className = 'update-banner';
      banner.innerHTML = `
        <div class="update-banner-text">‚¨Ü <b>Update available</b> ‚Äî tap to get the latest version</div>
        <button class="update-btn" id="ub-reload">Update</button>
        <button class="update-dismiss" id="ub-dismiss" title="Dismiss">‚úï</button>`;
      area.appendChild(banner);
      banner.querySelector('#ub-reload').addEventListener('click', () => {
        waitingSW.postMessage({ type: 'SKIP_WAITING' });
        // SW controllerchange fires when the new SW takes over; then we reload
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          window.location.reload();
        }, { once: true });
      });
      banner.querySelector('#ub-dismiss').addEventListener('click', () => banner.remove());
    }

    if (swReg) {
      // Already a waiting SW (e.g. user had the tab open during deploy)
      if (swReg.waiting) showUpdateBanner(swReg.waiting);
      // New SW found during this session
      swReg.addEventListener('updatefound', () => {
        const newSW = swReg.installing;
        if (!newSW) return;
        newSW.addEventListener('statechange', () => {
          if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
            // A new SW installed but the old one is still in control ‚Üí show banner
            showUpdateBanner(newSW);
          }
        });
      });
      // Periodically check for updates (every 10 minutes) so long-running sessions catch deploys
      setInterval(() => swReg.update().catch(() => {}), 10 * 60 * 1000);
    }
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // Once controller is available, start keep-alive and sync alarms
    const kickSW = () => {
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ type: 'START_KEEPALIVE' });
        syncAlarmsToSW();
      }
    };
    if (navigator.serviceWorker.controller) {
      kickSW();
    } else {
      navigator.serviceWorker.addEventListener('controllerchange', kickSW, { once: true });
    }

    // Listen for messages from SW (notification action clicks)
    navigator.serviceWorker.addEventListener('message', e => {
      if (!e.data) return;
      if (e.data.type === 'HABIT_ACTION') {
        const {habitKey, habitVal} = e.data;
        if (habitKey !== undefined && habitVal !== undefined) {
          updateHabit(habitKey, habitVal);
          showToast(`‚úì ${habitKey} logged from notification`);
        }
      } else if (e.data.type === 'SNOOZED') {
        const tag = e.data.tag || '';
        const idxMatch = tag.match(/alarm-(\d+)/);
        const mins = e.data.mins || 5;
        if (idxMatch) {
          const schedIdx = parseInt(idxMatch[1]);
          const until = Date.now() + mins * 60000;
          S.snooze[schedIdx] = until;
          renderCountdown();
          showToast(`Snoozed ${mins}m`);
          // Schedule a notification to fire when snooze expires (if SW available)
          if (S.notifPermission === 'granted' && navigator.serviceWorker.controller && S.config?.schedule[schedIdx]) {
            const item = S.config.schedule[schedIdx];
            const hi = detectHabit(item.activity);
            const snOpts = S.config.habitTracker?.snoozeOptions || [5, 10];
            const actions = [];
            if (hi) {
              const {key, config: cfg} = hi;
              if (cfg.type === 'incremental') actions.push({ action: `habit:${key}:${cfg.increment}`, title: `‚úì Done (+${cfg.increment})` });
              else cfg.choices.slice(0, 2).forEach(c => actions.push({ action: `habit:${key}:${c.value}`, title: c.label }));
            }
            actions.push({ action: 'dismiss', title: 'Dismiss' });
            snOpts.slice(0, 1).forEach(m => actions.push({ action: `snooze:${schedIdx}:${m}`, title: `‚è∞ +${m}m` }));
            navigator.serviceWorker.controller.postMessage({
              type: 'SCHEDULE_ALARM',
              title: `‚è∞ ${item.time} ‚Äî ${item.activity}`,
              body: hi ? `Snooze ended ¬∑ Log ${hi.key}` : 'Snooze ended',
              tag: `alarm-${schedIdx}`,
              delay: mins * 60000,
              actions
            });
          }
        }
      } else if (e.data.type === 'NOTIFICATION_CLICK') {
        // focus app, handled by SW openWindow already
      }
    });
  }

  document.getElementById('btn-reload').addEventListener('click', async()=>{
    if (S.vaultDirHandle) {
      await loadFromVault(); renderAll(); showToast('Reloaded');
    } else {
      const ok = await reconnectVault();
      if (ok) { await loadFromVault(); renderAll(); showToast('‚úì Vault reconnected'); }
      else { showToast('No vault connected ‚Äî tap ‚öô Settings to connect'); }
    }
  });
  document.getElementById('btn-settings').addEventListener('click', showSettings);

  // Load cached config + today's habits for instant render
  const cached=LS.get('lastConfig');
  if (cached?.schedule) S.config=cached;
  S.habitData = LS.get('habitData_' + todayStr()) || {};

  buildSkeleton();
  startTimers();
  renderAll();

  // Attempt to restore vault handle from IndexedDB (optional ‚Äî habit tracker folder)
  const state = await restoreVaultHandle();
  if (state === 'granted') {
    await deriveSubHandles();
    await loadFromVault();
    renderAll();
  } else if (state === 'needs-grant') {
    showReconnectBanner();
  }
  // No vault = fine, app works from localStorage. User connects via Settings.

  // Restore log template + output folder (saved to IDB, auto-reconnect if permission still held)
  await restoreLogTemplateHandle();
  await restoreLogOutputHandle();
  await restoreEventsHandle();

  if (Notification.permission==='default')
    setTimeout(()=>Notification.requestPermission().then(p=>{ S.notifPermission=p; showBatteryBanner(); }), 2000);
  else
    setTimeout(showBatteryBanner, 1000);
}

boot();

// Prevent pull-to-refresh (overscroll-behavior covers Chrome; this covers iOS Safari)
document.addEventListener('touchmove', e => {
  let el = e.target;
  while (el && el !== document.body) {
    const s = getComputedStyle(el);
    if ((s.overflowY === 'auto' || s.overflowY === 'scroll') && el.scrollHeight > el.clientHeight) return;
    el = el.parentElement;
  }
  if (document.scrollingElement && document.scrollingElement.scrollTop === 0) e.preventDefault();
}, { passive: false });
</script>
</body>
</html>
