<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#0a0a0f"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Habits"/>
<title>‚è∞ Habit Tracker</title>
<link rel="manifest" href="./manifest.json"/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>
<style>
  :root{
    --bg:#0a0a0f;--bg2:#111118;--bg3:#1a1a24;
    --accent:#00ff88;--warn:#ffaa00;--danger:#ff4466;
    --text:#e8e8f0;--muted:#555570;--border:#22223a;--radius:14px;
    --font-display:'Syne',sans-serif;--font-mono:'JetBrains Mono',monospace;
  }
  /* Light theme override */
  [data-theme="light"]{
    --bg:#f2f2f7;--bg2:#ffffff;--bg3:#e5e5ea;
    --accent:#00994d;--warn:#b87800;--danger:#cc2244;
    --text:#0a0a18;--muted:#8e8ea0;--border:#c8c8d8;
  }
  /* Auto: resolved by time-of-day via JS */
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font-display);overflow-x:hidden;transition:background .3s,color .3s;overscroll-behavior-y:none}
  body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
    background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");opacity:.4}
  #app{position:relative;z-index:1;max-width:480px;margin:0 auto;height:100dvh;display:flex;flex-direction:column;padding:env(safe-area-inset-top,0) 0 env(safe-area-inset-bottom,0)}

  header{padding:20px 20px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0}
  .header-left{display:flex;flex-direction:column;gap:2px}
  .header-title{font-size:22px;font-weight:800;letter-spacing:-.5px}
  .header-date{font-size:11px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1px}
  .header-actions{display:flex;gap:8px}
  .icon-btn{width:38px;height:38px;border-radius:10px;border:1px solid var(--border);background:var(--bg2);color:var(--text);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
  .icon-btn:active{transform:scale(.92);background:var(--bg3)}

  .reconnect-area-wrap{flex-shrink:0}

  .card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;animation:fadeUp .4s ease both}
  .card-header{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
  .card-header.clickable{cursor:pointer;user-select:none;border-bottom:none}
  .card-header.clickable:active{background:var(--bg3)}
  .card-label{font-size:10px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1.5px;color:var(--muted)}
  .card-body{padding:16px}
  .card-body.collapsed{display:none}
  .collapse-arrow{font-size:11px;color:var(--muted);transition:transform .25s;display:inline-block;font-family:var(--font-mono)}
  .collapse-arrow.open{transform:rotate(180deg)}

  /* countdown */
  .cw{display:flex;flex-direction:column;gap:10px}
  .ca{font-size:17px;font-weight:700;line-height:1.3}
  .cm{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
  .cl{font-size:11px;font-family:var(--font-mono);color:var(--muted)}
  .ct{font-size:36px;font-weight:800;font-family:var(--font-mono);color:var(--accent);letter-spacing:-1px;line-height:1;font-variant-numeric:tabular-nums}
  .ct.urgent{color:var(--warn);animation:pulse 1s ease infinite}
  .pb-wrap{height:3px;background:var(--bg3);border-radius:2px;overflow:hidden}
  .pb-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 1s linear}
  .snooze-row{display:flex;gap:8px;flex-wrap:wrap}
  .sn-btn{padding:6px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:12px;font-family:var(--font-mono);cursor:pointer;transition:all .15s}
  .sn-btn:active{background:var(--border);color:var(--text);transform:scale(.95)}
  .snoozed-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:rgba(255,170,0,.12);border:1px solid rgba(255,170,0,.3);border-radius:20px;font-size:11px;font-family:var(--font-mono);color:var(--warn)}

  /* habits */
  .habits-grid{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;padding:4px 4px 8px}
  .habit-col{display:flex;flex-direction:column;align-items:center;gap:6px;width:56px}
  .habit-bar-track{width:32px;height:100px;background:var(--bg3);border-radius:8px;position:relative;overflow:hidden;border:1px solid var(--border)}
  .habit-bar-fill{position:absolute;bottom:0;left:0;right:0;border-radius:6px;background:linear-gradient(to top,var(--accent),rgba(0,255,136,.4));transition:height .4s cubic-bezier(.34,1.56,.64,1)}
  .habit-bar-fill.complete{background:linear-gradient(to top,var(--accent),#00ffaa)}
  .habit-icon{font-size:26px;cursor:pointer;transition:transform .2s cubic-bezier(.34,1.56,.64,1);user-select:none;line-height:1}
  .habit-icon:active{transform:scale(1.35)}
  .habit-val{font-size:10px;font-family:var(--font-mono);color:var(--muted);background:var(--bg3);padding:2px 6px;border-radius:10px}
  .habit-val.complete{color:var(--accent)}
  /* habit edit mode */
  .habit-remove-btn{position:absolute;top:-6px;right:-6px;width:18px;height:18px;border-radius:50%;background:var(--danger);color:#fff;font-size:10px;font-weight:700;border:2px solid var(--bg2);cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:2;padding:0;box-shadow:0 1px 4px rgba(0,0,0,.35)}
  .habit-remove-btn:active{transform:scale(.88)}
  .habit-add-col{display:flex;flex-direction:column;align-items:center;gap:6px;width:56px;cursor:pointer}
  .habit-add-btn{width:38px;height:38px;border-radius:10px;background:rgba(0,255,136,.08);border:1.5px dashed rgba(0,255,136,.35);color:var(--accent);font-size:22px;display:flex;align-items:center;justify-content:center;transition:all .15s}
  .habit-add-btn:active{background:rgba(0,255,136,.18);transform:scale(.92)}
  .habit-add-label{font-size:9px;font-family:var(--font-mono);color:var(--muted)}
  /* habit edit done pill ‚Äî small, tucked into card header area */
  .habit-done-pill{display:none;align-items:center;gap:6px;padding:5px 12px;background:var(--accent);color:var(--bg);border:none;border-radius:20px;font-size:11px;font-family:var(--font-mono);font-weight:700;cursor:pointer;transition:all .15s;flex-shrink:0}
  .habit-done-pill:active{transform:scale(.93)}
  .habit-done-pill.visible{display:flex}

  /* schedule */
  .sched-list{display:flex;flex-direction:column;gap:2px}
  .sched-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;position:relative}
  .sched-item.current{background:rgba(0,255,136,.07)}
  .sched-item.past{opacity:.4}
  .sched-item.current::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:60%;background:var(--accent);border-radius:2px}
  .sched-time{font-size:11px;font-family:var(--font-mono);color:var(--muted);min-width:52px}
  .sched-act{font-size:14px;flex:1;line-height:1.3}
  .sched-preview{padding:10px 16px 12px;font-size:13px;font-family:var(--font-mono);display:flex;align-items:center;gap:8px;border-top:1px solid var(--border)}

  /* modal */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:200;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(6px);animation:fadeIn .2s ease}
  .modal-overlay.center{align-items:center}
  .modal{background:var(--bg2);border:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-width:480px;padding:20px 20px calc(20px + env(safe-area-inset-bottom,0px));animation:slideUp .3s cubic-bezier(.34,1.56,.64,1);max-height:92dvh;overflow-y:auto}
  .modal.cm-modal{border-radius:20px;animation:scaleIn .25s cubic-bezier(.34,1.56,.64,1);margin:16px}
  .modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px}
  .modal-title{font-size:20px;font-weight:800;margin-bottom:6px}
  .alarm-activity{font-size:18px;font-weight:700;padding:16px;background:var(--bg3);border-radius:12px;text-align:center;margin-bottom:8px;line-height:1.4}
  .alarm-time{font-size:13px;font-family:var(--font-mono);color:var(--accent);text-align:center;margin-bottom:20px}

  /* buttons */
  .btn{padding:12px 22px;border-radius:12px;border:none;cursor:pointer;font-family:var(--font-display);font-size:15px;font-weight:700;transition:all .15s;min-height:48px;display:flex;align-items:center;justify-content:center;gap:6px}
  .btn:active{transform:scale(.95)}
  .btn-green{background:var(--accent);color:var(--bg)}
  .btn-red{background:var(--danger);color:#fff}
  .btn-ghost{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
  .btn-icon{width:52px;height:52px;padding:0;font-size:22px;border-radius:14px;flex-shrink:0}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

  /* reconnect banner */
  .reconnect-banner{margin:12px 20px 0;background:rgba(255,170,0,.07);border:1px solid rgba(255,170,0,.2);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:12px;animation:fadeUp .3s ease}
  .rb-text{flex:1;font-size:12px;color:var(--warn);font-family:var(--font-mono);line-height:1.5}
  .rb-sub{font-size:11px;color:var(--muted);margin-top:2px}
  .reconnect-btn{padding:8px 16px;background:var(--warn);color:#000;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;font-family:var(--font-display);flex-shrink:0}
  .reconnect-btn:active{transform:scale(.95)}

  /* first-run setup */
  .setup-screen{position:fixed;inset:0;background:var(--bg);z-index:300;overflow-y:auto;padding:48px 24px calc(48px + env(safe-area-inset-bottom,0px));display:flex;flex-direction:column;align-items:center;justify-content:center}
  .setup-inner{width:100%;max-width:360px;display:flex;flex-direction:column;gap:20px;align-items:center}
  .setup-icon{font-size:72px;line-height:1}
  .setup-title{font-size:28px;font-weight:800;letter-spacing:-.5px;text-align:center}
  .setup-desc{font-size:13px;color:var(--muted);line-height:1.7;text-align:center;font-family:var(--font-mono)}
  .setup-note{font-size:11px;color:var(--muted);font-family:var(--font-mono);line-height:1.7;padding:14px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;width:100%}
  .setup-note b{color:var(--warn)}

  /* install guide */
  .install-guide{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:400;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(8px);animation:fadeIn .2s ease}
  .install-modal{background:var(--bg2);border:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-width:480px;padding:24px 24px calc(24px + env(safe-area-inset-bottom,0px));max-height:90dvh;overflow-y:auto;animation:slideUp .3s cubic-bezier(.34,1.56,.64,1)}
  .install-step{display:flex;gap:14px;padding:14px 0;border-bottom:1px solid var(--border)}
  .install-step:last-child{border-bottom:none}
  .install-num{width:28px;height:28px;border-radius:8px;background:rgba(0,255,136,.12);border:1px solid rgba(0,255,136,.25);display:flex;align-items:center;justify-content:center;font-size:11px;font-family:var(--font-mono);color:var(--accent);flex-shrink:0;margin-top:2px}
  .install-text{font-size:13px;line-height:1.6;color:var(--text)}
  .install-text b{color:var(--accent)}
  .install-text small{display:block;margin-top:4px;font-size:11px;font-family:var(--font-mono);color:var(--muted)}
  .platform-tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
  .ptab{padding:7px 14px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--muted);font-size:12px;font-family:var(--font-mono);cursor:pointer;transition:all .15s}
  .ptab.active{background:rgba(0,255,136,.12);border-color:rgba(0,255,136,.3);color:var(--accent)}
  .ptab:active{transform:scale(.95)}
  .platform-steps{display:none}
  .platform-steps.active{display:block}
  .notif-fix{background:rgba(255,170,0,.07);border:1px solid rgba(255,170,0,.2);border-radius:10px;padding:12px 14px;font-size:12px;font-family:var(--font-mono);color:var(--warn);line-height:1.6;margin-top:8px}
  .notif-fix b{color:var(--text)}

  /* settings */
  .s-section{margin-bottom:24px}
  .s-section-title{font-size:10px;font-family:var(--font-mono);color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px}
  .s-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border);gap:12px}
  .s-row:last-child{border-bottom:none}
  .s-label{font-size:15px;font-weight:600}
  .s-sub{font-size:12px;color:var(--muted);margin-top:2px;font-family:var(--font-mono);word-break:break-all}
  .pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:20px;font-size:11px;font-family:var(--font-mono);font-weight:600;white-space:nowrap}
  .pill-green{background:rgba(0,255,136,.12);color:var(--accent);border:1px solid rgba(0,255,136,.25)}
  .pill-red{background:rgba(255,68,102,.12);color:var(--danger);border:1px solid rgba(255,68,102,.25)}
  .pill-amber{background:rgba(255,170,0,.12);color:var(--warn);border:1px solid rgba(255,170,0,.25)}
  /* theme segment control */
  .theme-seg{display:flex;background:var(--bg3);border-radius:10px;padding:3px;gap:2px}
  .theme-seg-btn{flex:1;padding:7px 10px;border-radius:7px;border:none;background:transparent;color:var(--muted);font-size:11px;font-family:var(--font-mono);font-weight:600;cursor:pointer;transition:all .15s;text-align:center}
  .theme-seg-btn.active{background:var(--bg2);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.18)}
  .empty-state{text-align:center;padding:40px 20px;color:var(--muted);font-size:14px;line-height:1.6}
  .toast{position:fixed;top:calc(16px + env(safe-area-inset-top,0px));left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:10px 18px;font-size:13px;font-family:var(--font-mono);color:var(--text);z-index:1000;white-space:nowrap;box-shadow:0 4px 24px rgba(0,0,0,.5);animation:toastIn .3s ease;pointer-events:none}

  @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
  @keyframes scaleIn{from{opacity:0;transform:scale(.88)}to{opacity:1;transform:scale(1)}}
  @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  @keyframes emojiPop{0%{opacity:1;transform:translate(-50%,0) scale(1)}60%{opacity:1;transform:translate(-50%,-52px) scale(1.5)}100%{opacity:0;transform:translate(-50%,-80px) scale(.9)}}
  ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

  /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
  .tab-bar{display:flex;border-bottom:1px solid var(--border);background:var(--bg);flex-shrink:0;z-index:10}
  .tab-btn{flex:1;padding:12px 8px;font-size:12px;font-family:var(--font-mono);font-weight:600;letter-spacing:.5px;color:var(--muted);background:none;border:none;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;text-transform:uppercase}
  .tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
  .tab-btn:active{background:var(--bg3)}
  /* tabs-container clips only horizontally */
  .tabs-container{flex:1;overflow:hidden;display:flex;flex-direction:column;min-height:0}
  /* panels row slides left/right, does not clip vertically */
  .tab-panels{display:flex;flex:1;min-height:0;width:100%;transform:translateX(0%);transition:transform .32s cubic-bezier(.4,0,.2,1);will-change:transform;align-items:flex-start}
  /* each panel is full container height and scrolls on its own */
  .tab-panel{flex:0 0 100%;width:100%;height:100%;overflow-y:auto;overflow-x:hidden;padding:16px 20px 120px;display:flex;flex-direction:column;gap:16px;-webkit-overflow-scrolling:touch}

  /* ‚îÄ‚îÄ SCHEDULE TAB ‚îÄ‚îÄ */
  .sched-tab-list{display:flex;flex-direction:column;gap:6px}
  /* View mode items ‚Äî card-like, bigger */
  .sched-tab-item{display:flex;align-items:center;gap:14px;padding:14px 16px;border-radius:14px;background:var(--bg2);border:1px solid var(--border);position:relative;transition:background .15s,border-color .15s}
  .sched-tab-item.current{background:rgba(0,255,136,.07);border-color:rgba(0,255,136,.25)}
  .sched-tab-item.past{opacity:.38}
  .sched-tab-item.current::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:50%;background:var(--accent);border-radius:0 2px 2px 0}
  .sched-tab-time-block{display:flex;flex-direction:column;align-items:flex-start;gap:2px;min-width:64px;flex-shrink:0}
  .sched-tab-time{font-size:13px;font-family:var(--font-mono);font-weight:700;color:var(--accent)}
  .sched-tab-item.past .sched-tab-time{color:var(--muted)}
  .sched-tab-divider{width:1px;height:32px;background:var(--border);flex-shrink:0}
  .sched-tab-act{font-size:15px;font-weight:600;flex:1;line-height:1.35;color:var(--text)}
  .sched-current-label{font-size:9px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px;color:var(--accent);font-weight:700}
  /* Delete button ‚Äî only in edit mode */
  .sched-tab-del{width:34px;height:34px;border-radius:9px;border:1px solid rgba(255,68,102,.3);background:rgba(255,68,102,.08);color:var(--danger);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
  .sched-tab-del:active{background:rgba(255,68,102,.2);transform:scale(.9)}
  /* FABs */
  .edit-fab{position:fixed;bottom:calc(24px + env(safe-area-inset-bottom,0px));right:20px;height:50px;min-width:50px;border-radius:16px;background:var(--accent);color:var(--bg);font-size:20px;font-weight:800;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0 18px;box-shadow:0 4px 20px rgba(0,255,136,.4);transition:all .22s;z-index:50;white-space:nowrap;gap:6px}
  .edit-fab:active{transform:scale(.92)}
  .edit-fab.editing{background:var(--warn);box-shadow:0 4px 20px rgba(255,170,0,.4);font-size:14px;font-weight:700}
  .add-fab{position:fixed;bottom:calc(88px + env(safe-area-inset-bottom,0px));right:20px;height:50px;min-width:50px;border-radius:16px;background:var(--bg2);color:var(--accent);font-size:24px;font-weight:800;border:1px solid rgba(0,255,136,.35);cursor:pointer;display:none;align-items:center;justify-content:center;padding:0 18px;box-shadow:0 4px 16px rgba(0,0,0,.3);transition:all .22s;z-index:50}
  .add-fab:active{transform:scale(.92)}
  .add-fab.visible{display:flex}
  .schedule-empty{text-align:center;padding:60px 20px;color:var(--muted);font-size:14px;line-height:1.8}
  /* Inline edit row */
  .sched-edit-row{background:var(--bg3);border:1px solid var(--border);border-radius:14px;padding:12px 14px;display:flex;align-items:center;gap:10px}
  .sched-edit-fields{display:flex;gap:8px;align-items:center;flex:1;min-width:0}
  .sched-edit-time{width:96px;flex-shrink:0;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px 10px;color:var(--text);font-family:var(--font-mono);font-size:12px;outline:none;transition:border-color .15s}
  .sched-edit-time:focus{border-color:var(--accent)}
  .sched-edit-act{flex:1;min-width:0;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px 10px;color:var(--text);font-family:var(--font-display);font-size:14px;outline:none;transition:border-color .15s}
  .sched-edit-act:focus{border-color:var(--accent)}
  /* Add modal */
  .add-sched-modal{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(6px);animation:fadeIn .2s ease}
  .add-sched-sheet{background:var(--bg2);border:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-width:480px;padding:20px 20px calc(20px + env(safe-area-inset-bottom,0px));animation:slideUp .3s cubic-bezier(.34,1.56,.64,1)}
  .add-sched-sheet input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:13px 14px;color:var(--text);font-family:var(--font-mono);font-size:14px;outline:none;margin-bottom:10px;transition:border-color .15s}
  .add-sched-sheet input:focus{border-color:var(--accent)}
  .add-sched-sheet input::placeholder{color:var(--muted)}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="header-left">
      <div class="header-title">‚è∞ Habits</div>
      <div class="header-date" id="header-date"></div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="btn-reload" title="Reload">‚Ü∫</button>
      <button class="icon-btn" id="btn-settings" title="Settings">‚öô</button>
    </div>
  </header>
  <div id="reconnect-area"></div>
  <div class="tabs-container">
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="0">Today</button>
      <button class="tab-btn" data-tab="1">Schedule</button>
    </div>
    <div class="tab-panels" id="tab-panels">
      <div class="tab-panel" id="main-content"></div>
      <div class="tab-panel" id="schedule-tab"></div>
    </div>
  </div>
</div>

<script>
'use strict';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  config: null,
  habitData: {},
  snooze: {},
  shownAlarms: {},
  evaluatedAlarms: {},
  countdownInterval: null,
  checkInterval: null,
  vaultDirHandle: null,
  _pendingHandle: null,
  scheduleOpen: false, // legacy, unused
  notifPermission: Notification.permission,
};

const LS = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} },
  del: k => { try { localStorage.removeItem(k); } catch {} },
};

// ‚îÄ‚îÄ IndexedDB ‚Äî stores FileSystemDirectoryHandle (localStorage can't) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const IDB = (() => {
  let db = null;
  const open = () => new Promise((res,rej) => {
    if (db) { res(db); return; }
    const r = indexedDB.open('habit-tracker-v1', 1);
    r.onupgradeneeded = e => e.target.result.createObjectStore('kv');
    r.onsuccess = e => { db = e.target.result; res(db); };
    r.onerror = () => rej(r.error);
  });
  return {
    set: async (k,v) => {
      const d = await open();
      return new Promise((res,rej) => {
        const tx = d.transaction('kv','readwrite');
        tx.objectStore('kv').put(v, k);
        tx.oncomplete = () => res(true);
        tx.onerror = () => rej(tx.error);
      });
    },
    get: async (k) => {
      const d = await open();
      return new Promise((res,rej) => {
        const tx = d.transaction('kv','readonly');
        const r = tx.objectStore('kv').get(k);
        r.onsuccess = () => res(r.result);
        r.onerror = () => rej(r.error);
      });
    },
    del: async (k) => {
      const d = await open();
      return new Promise((res,rej) => {
        const tx = d.transaction('kv','readwrite');
        tx.objectStore('kv').delete(k);
        tx.oncomplete = () => res(true);
        tx.onerror = () => rej(tx.error);
      });
    },
  };
})();

// ‚îÄ‚îÄ DATE / FILE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function todayStr() { return new Date().toISOString().slice(0,10).replace(/-/g,''); }
function todayFilename() { return `22101995${todayStr()}HT.md`; }

function parseTime(str) {
  const [t,p] = str.split(' ');
  let [h,m] = t.split(':').map(Number);
  if (p==='PM' && h!==12) h+=12;
  if (p==='AM' && h===12) h=0;
  return {h,m};
}
function schedDate(ts) {
  const {h,m} = parseTime(ts);
  const d = new Date(); d.setHours(h,m,0,0); return d;
}
function fmtMs(ms) {
  const s=Math.floor(ms/1000), hh=Math.floor(s/3600), mm=Math.floor((s%3600)/60), ss=s%60;
  if (hh>0) return `${hh}h ${mm}m ${ss}s`;
  if (mm>0) return `${mm}m ${ss}s`;
  return `${ss}s`;
}

// ‚îÄ‚îÄ VAULT FOLDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pickVaultFolder() {
  try {
    const dh = await window.showDirectoryPicker({ mode:'readwrite', id:'vault' });
    S.vaultDirHandle = dh;
    S._pendingHandle = null;
    await IDB.set('vaultHandle', dh);
    LS.set('vaultFolderName', dh.name);
    showToast(`üìÅ ${dh.name} connected`);
    return true;
  } catch(e) {
    if (e.name !== 'AbortError') showToast('Could not open folder');
    return false;
  }
}

async function restoreVaultHandle() {
  try {
    const dh = await IDB.get('vaultHandle');
    if (!dh) return 'none';
    // Silent check only ‚Äî never call requestPermission here (no user gesture at boot)
    const perm = await dh.queryPermission({ mode: 'readwrite' });
    if (perm === 'granted') {
      S.vaultDirHandle = dh;
      return 'granted';
    }
    // Store handle so reconnect banner can use it
    S._pendingHandle = dh;
    return 'needs-grant';
  } catch { return 'none'; }
}

async function reconnectVault() {
  const dh = S._pendingHandle || await IDB.get('vaultHandle').catch(()=>null);
  if (!dh) { await pickVaultFolder(); return !!S.vaultDirHandle; }
  try {
    const perm = await dh.requestPermission({ mode: 'readwrite' });
    if (perm === 'granted') {
      S.vaultDirHandle = dh;
      S._pendingHandle = null;
      document.getElementById('reconnect-area').innerHTML = '';
      return true;
    }
  } catch {}
  return false;
}

// ‚îÄ‚îÄ GET DATA SUBFOLDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Returns the vault/data/ DirectoryHandle, creating it if needed
async function getDataDir() {
  if (!S.vaultDirHandle) return null;
  try {
    return await S.vaultDirHandle.getDirectoryHandle('data', { create: true });
  } catch(e) { console.error('getDataDir:', e); return null; }
}

// ‚îÄ‚îÄ LOAD FROM VAULT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFromVault() {
  if (!S.vaultDirHandle) return;
  LS.del('lastConfig');
  LS.del('lastScheduleEdit');
  await loadTemplate();
  await loadHabitDataFromFile();
}

async function loadTemplate() {
  if (!S.vaultDirHandle) return false;
  try {
    for await (const entry of S.vaultDirHandle.values()) {
      if (entry.kind==='file' && entry.name.endsWith('.md') && !entry.name.match(/^\d{16}HT\.md$/)) {
        const file = await entry.getFile();
        const text = await file.text();
        const cfg = parseMd(text);
        if (cfg && cfg.schedule?.length) {
          // Check if user has locally-edited the schedule more recently than the vault file
          const lastEdit = LS.get('lastScheduleEdit') || 0;
          const fileModified = file.lastModified || 0;
          const cached = LS.get('lastConfig');

          if (lastEdit > fileModified && cached?.schedule?.length) {
            // Local edits are newer ‚Äî preserve the local schedule but take habit definitions from vault
            S.config = {
              ...cfg,
              schedule: cached.schedule,
            };
          } else {
            S.config = cfg;
            // Vault is the source of truth ‚Äî clear local-edit timestamp
            LS.del('lastScheduleEdit');
          }
          LS.set('lastConfig', S.config);
          return true;
        }
      }
    }
    return false;
  } catch(e) { console.error('loadTemplate:', e); return false; }
}

async function loadHabitDataFromFile() {
  if (S.vaultDirHandle) {
    try {
      const dataDir = await getDataDir();
      if (dataDir) {
        const fh = await dataDir.getFileHandle(todayFilename(), { create:false });
        const text = await (await fh.getFile()).text();
        const m = text.match(/^---\n([\s\S]+?)\n---/);
        if (m) {
          S.habitData = {};
          m[1].split('\n').forEach(line => {
            const lm = line.match(/^(\w+):\s*(.+)/);
            if (lm) S.habitData[lm[1]] = parseInt(lm[2]) || 0;
          });
          return;
        }
      }
    } catch { /* file doesn't exist yet ‚Äî created on first write */ }
  }
  S.habitData = LS.get('habitData_' + todayStr()) || {};
}

async function writeHabitData() {
  // Always save to localStorage immediately as backup
  LS.set('habitData_' + todayStr(), S.habitData);
  if (!S.vaultDirHandle || !S.config) return;
  try {
    const dataDir = await getDataDir();
    if (!dataDir) return;
    const fn = todayFilename();
    let existingBody = '';
    try {
      const ef = await dataDir.getFileHandle(fn, { create:false });
      const txt = await (await ef.getFile()).text();
      const bm = txt.match(/^---\n[\s\S]+?\n---\n?([\s\S]*)/);
      if (bm) existingBody = bm[1].trimStart();
    } catch {}
    const keys = Object.keys(S.config.habitDefinitions || {});
    const yaml = keys.map(k=>`${k}: ${S.habitData[k]??0}`).join('\n');
    const fh = await dataDir.getFileHandle(fn, { create:true });
    const w = await fh.createWritable();
    await w.write(`---\n${yaml}\n---\n${existingBody ? '\n'+existingBody : ''}`);
    await w.close();
  } catch(e) {
    console.warn('Vault write silently failed (localStorage used):', e.message);
  }
}

// ‚îÄ‚îÄ PARSE .MD FRONTMATTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseMd(text) {
  const fm = text.match(/^---\n([\s\S]+?)\n---/);
  if (!fm) return null;
  try {
    const yaml = fm[1];
    const schedule = [];
    const sm = yaml.match(/^schedule:\s*\n([\s\S]*?)(?=^[a-zA-Z]\w*:)/m);
    if (sm) {
      let cur = null;
      for (const line of sm[1].split('\n')) {
        const tM = line.match(/time:\s*["']?(.+?)["']?\s*$/);
        const aM = line.match(/activity:\s*["']?(.+?)["']?\s*$/);
        if (tM) cur = { time: tM[1].trim() };
        else if (aM && cur) { cur.activity = aM[1].trim(); schedule.push(cur); cur = null; }
      }
    }
    const habitDefinitions = {};
    const hm = yaml.match(/^habitDefinitions:\s*\n([\s\S]*?)(?=^[a-zA-Z]\w*:)/m);
    if (hm) {
      for (const block of hm[1].split(/\n(?=  \w)/)) {
        const km = block.match(/^\s{2}(\w+):/);
        if (!km) continue;
        const def = {
          type: (block.match(/type:\s*(\w+)/)||[])[1]||'incremental',
          icon: ((block.match(/icon:\s*(.+?)(\s*#.*)?$/m)||[])[1]||'‚≠ê').trim(),
          messages:{}, choices:[],
        };
        const maxM=block.match(/maxValue:\s*(\d+)/), incrM=block.match(/increment:\s*(\d+)/);
        if (maxM) def.maxValue=parseInt(maxM[1]);
        if (incrM) def.increment=parseInt(incrM[1]);
        const msgM=block.match(/messages:\s*\n([\s\S]*?)(?=\n    \w|\n  \w|$)/);
        if (msgM) msgM[1].split('\n').forEach(ml=>{
          const mm=ml.match(/\s+(\w+):\s*["']?(.+?)["']?\s*$/);
          if (mm) def.messages[isNaN(mm[1])?mm[1]:parseInt(mm[1])]=mm[2].trim();
        });
        const chM=block.match(/choices:\s*\n([\s\S]*?)(?=\n  \w|$)/);
        if (chM) {
          let ch=null;
          for (const cl of chM[1].split('\n')) {
            if (cl.match(/^\s*-\s/)) { if(ch) def.choices.push(ch); ch={}; }
            const vM=cl.match(/value:\s*(\d+)/), lM=cl.match(/label:\s*["']?(.+?)["']?\s*$/), mM=cl.match(/message:\s*["']?(.+?)["']?\s*$/);
            if (vM&&ch) ch.value=parseInt(vM[1]);
            if (lM&&ch) ch.label=lM[1].trim();
            if (mM&&ch) ch.message=mM[1].trim();
          }
          if (ch&&Object.keys(ch).length) def.choices.push(ch);
        }
        habitDefinitions[km[1]]=def;
      }
    }
    const snM=yaml.match(/snoozeOptions:\s*\[([^\]]+)\]/);
    const snoozeOptions=snM?snM[1].split(',').map(s=>parseInt(s.trim())).filter(Boolean):[5,10];
    return { schedule, habitDefinitions, habitTracker:{ enabled:true, snoozeOptions } };
  } catch(e) { console.error('Parse error',e); return null; }
}

// ‚îÄ‚îÄ HABIT UPDATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateHabit(key, value) {
  const cfg=S.config?.habitDefinitions?.[key]; if (!cfg) return;
  if (cfg.type==='incremental') {
    const cur=S.habitData[key]||0;
    S.habitData[key]=Math.min(cfg.maxValue, cur+value);
    showToast(cfg.messages?.[S.habitData[key]]||'Logged!');
  } else {
    S.habitData[key]=value;
    showToast(cfg.choices?.find(c=>c.value===value)?.message||'Logged!');
  }
  writeHabitData();
  renderHabitBars();
}
function decrementHabit(key) {
  const cfg=S.config?.habitDefinitions?.[key];
  if (!cfg||cfg.type!=='incremental') return;
  S.habitData[key]=Math.max(0,(S.habitData[key]||0)-cfg.increment);
  showToast(`${key} ‚Üí ${S.habitData[key]}`);
  writeHabitData();
  renderHabitBars();
}

// ‚îÄ‚îÄ SCHEDULE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getCurNext() {
  const now=new Date(), sc=S.config?.schedule||[];
  let cur=-1, next=-1;
  for (let i=0;i<sc.length;i++) {
    if (schedDate(sc[i].time)<=now) cur=i;
    else if (next===-1) next=i;
  }
  return {cur,next};
}
function detectHabit(activity) {
  for (const [key,cfg] of Object.entries(S.config?.habitDefinitions||{}))
    if (activity.includes(cfg.icon)) return {key,config:cfg};
  return null;
}

// ‚îÄ‚îÄ ALARM CHECK + MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkAlarms() {
  if (!S.config) return;
  const now=Date.now(), sc=S.config.schedule;
  for (const idx in S.snooze) {
    if (S.snooze[idx]<=now) {
      delete S.snooze[idx]; const i=parseInt(idx);
      // Show full alarm modal (with notification) for resumed snooze
      if (!S.shownAlarms[i]||(now-S.shownAlarms[i])>30000) { showAlarmModal(i); return; }
    }
  }
  for (let i=0;i<sc.length;i++) {
    const diff=now-schedDate(sc[i].time).getTime();
    if (diff>=0&&diff<5000) {
      if (S.shownAlarms[i]&&(now-S.shownAlarms[i])<120000) continue;
      if (S.snooze[i]&&S.snooze[i]>now) continue;
      showAlarmModal(i); return;
    }
  }
}

// ‚îÄ‚îÄ SYNC ALL TODAY'S ALARMS TO SERVICE WORKER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Called whenever the schedule changes or the app loads.
// Sends every future alarm for today so the SW can fire them independently.
function syncAlarmsToSW() {
  if (!navigator.serviceWorker?.controller) return;
  if (S.notifPermission !== 'granted') return;
  if (!S.config?.schedule?.length) return;

  const snOpts = S.config.habitTracker?.snoozeOptions || [5, 10];
  const alarms = [];
  const now = Date.now();

  S.config.schedule.forEach((item, idx) => {
    const fireAt = schedDate(item.time).getTime();
    if (fireAt <= now) return; // already past

    const hi = detectHabit(item.activity);
    const actions = [];
    if (hi) {
      const { key, config: cfg } = hi;
      if (cfg.type === 'incremental') actions.push({ action: `habit:${key}:${cfg.increment}`, title: `‚úì Done (+${cfg.increment})` });
      else cfg.choices.slice(0, 2).forEach(c => actions.push({ action: `habit:${key}:${c.value}`, title: c.label }));
    }
    actions.push({ action: 'dismiss', title: 'Dismiss' });
    snOpts.slice(0, 1).forEach(m => actions.push({ action: `snooze:${idx}:${m}`, title: `‚è∞ +${m}m` }));

    alarms.push({
      tag:     `alarm-${idx}`,
      title:   `‚è∞ ${item.time} ‚Äî ${item.activity}`,
      body:    hi ? `Time to log ${hi.key}` : 'Time for your next activity',
      fireAt,
      actions,
      data:    { idx, habitKey: hi?.key, habitVal: hi?.config?.type === 'incremental' ? hi?.config?.increment : null }
    });
  });

  navigator.serviceWorker.controller.postMessage({ type: 'SYNC_ALARMS', alarms });
}

// ‚îÄ‚îÄ FORCE SW UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// When the user saves schedule edits, tell any waiting SW to take over
// immediately so the new alarm times are registered right away.
async function forceSwUpdate() {
  try {
    const reg = await navigator.serviceWorker.getRegistration();
    if (!reg) return;

    // If there's a waiting SW (new version), tell it to skip waiting
    if (reg.waiting) {
      reg.waiting.postMessage({ type: 'SKIP_WAITING' });
      // Wait for the new SW to take control, then re-sync alarms
      await new Promise(resolve => {
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          syncAlarmsToSW();
          resolve();
        }, { once: true });
      });
    } else {
      // Same SW version ‚Äî just re-sync the alarms with updated schedule
      syncAlarmsToSW();
    }
  } catch (err) {
    console.warn('forceSwUpdate failed:', err);
    syncAlarmsToSW(); // fallback: at least re-sync
  }
}

function showAlarmModal(idx) {
  S.shownAlarms[idx]=Date.now();
  const item=S.config.schedule[idx], hi=detectHabit(item.activity);
  const snOpts=S.config.habitTracker?.snoozeOptions||[5,10];
  playBeep();

  // Push notification
  if (S.notifPermission==='granted') {
    const actions = [];
    if (hi) {
      const {key, config:cfg} = hi;
      if (cfg.type==='incremental') actions.push({ action:`habit:${key}:${cfg.increment}`, title:`‚úì Done (+${cfg.increment})` });
      else cfg.choices.slice(0,2).forEach(c=>actions.push({ action:`habit:${key}:${c.value}`, title:c.label }));
    }
    actions.push({ action:'dismiss', title:'Dismiss' });
    snOpts.slice(0,1).forEach(m=>actions.push({ action:`snooze:${idx}:${m}`, title:`‚è∞ +${m}m` }));
    if (navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({
        type:'SHOW_ALARM', title:`‚è∞ ${item.time} ‚Äî ${item.activity}`,
        body: hi ? `Tap to log ${hi.key}` : 'Time for your next activity',
        tag:`alarm-${idx}`, data:{idx, habitKey:hi?.key, habitVal:hi?.config?.type==='incremental'?hi?.config?.increment:null}, actions
      });
    } else {
      new Notification(`‚è∞ ${item.activity}`, { body:`${item.time}${hi?` ¬∑ Log ${hi.key}`:''}`, tag:`alarm-${idx}`, requireInteraction:true });
    }
  }

  // Prevent duplicate in-app modals
  document.querySelector('.alarm-modal-ov')?.remove();

  let habitBtns = '';
  if (hi) {
    const {key,config:cfg}=hi;
    if (cfg.type==='incremental') habitBtns=`<button class="btn btn-green aa" data-key="${key}" data-val="${cfg.increment}" style="flex:1">‚úì Done</button>`;
    else habitBtns=cfg.choices.map(c=>`<button class="btn btn-green aa" data-key="${key}" data-val="${c.value}" style="flex:1">${c.label}</button>`).join('');
  }
  const failOpt=hi?.config?.type==='choice'&&hi?.config?.messages?.failed;
  const dismissBtn=failOpt
    ?`<button class="btn btn-red ad" data-key="${hi.key}" data-fail="1" style="flex:1">‚úï Failed</button>`
    :`<button class="btn btn-ghost ad" style="flex:1">Dismiss</button>`;

  const ov=document.createElement('div'); ov.className='modal-overlay center alarm-modal-ov';
  ov.innerHTML=`<div class="modal cm-modal" style="max-width:340px;width:calc(100% - 32px)">
    <div style="text-align:center;font-size:11px;font-family:var(--font-mono);color:var(--accent);margin-bottom:10px;letter-spacing:1.5px;text-transform:uppercase">‚è∞ Time for Activity</div>
    <div class="alarm-activity">${item.activity}</div>
    <div class="alarm-time">${item.time}</div>
    <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">${habitBtns}${dismissBtn}</div>
    <div style="display:flex;gap:8px">
      ${snOpts.map(m=>`<button class="btn btn-ghost as" data-idx="${idx}" data-min="${m}" style="flex:1;font-size:12px;min-height:40px;padding:8px">‚è∞ +${m}m</button>`).join('')}
    </div>
  </div>`;
  document.body.appendChild(ov);
  const close=()=>{ ov.remove(); renderCountdown(); };
  ov.addEventListener('click',e=>{ if(e.target===ov) close(); });
  ov.querySelectorAll('.aa').forEach(b=>b.addEventListener('click',()=>{ updateHabit(b.dataset.key,parseInt(b.dataset.val)); S.evaluatedAlarms[idx]=true; close(); }));
  ov.querySelectorAll('.ad').forEach(b=>b.addEventListener('click',()=>{ if(b.dataset.fail&&b.dataset.key){ updateHabit(b.dataset.key,0); S.evaluatedAlarms[idx]=true; } close(); }));
  ov.querySelectorAll('.as').forEach(b=>b.addEventListener('click',()=>{ S.snooze[parseInt(b.dataset.idx)]=Date.now()+parseInt(b.dataset.min)*60000; showToast(`Snoozed ${b.dataset.min}m`); close(); }));
}

function playBeep() {
  try {
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator(), g=ctx.createGain();
    osc.connect(g); g.connect(ctx.destination);
    osc.frequency.setValueAtTime(880,ctx.currentTime);
    osc.frequency.setValueAtTime(660,ctx.currentTime+0.1);
    g.gain.setValueAtTime(0.3,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.4);
    osc.start(); osc.stop(ctx.currentTime+0.4);
  } catch{}
}

// ‚îÄ‚îÄ RENDER ‚Äî COUNTDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCountdown() {
  const el=document.getElementById('card-countdown'); if (!el) return;
  const body=el.querySelector('.card-body');
  if (!S.config?.schedule?.length) { body.innerHTML=`<div class="empty-state">No schedule loaded</div>`; return; }
  for (const idx in S.snooze) {
    const until=S.snooze[idx];
    if (until>Date.now()) {
      const item=S.config.schedule[parseInt(idx)];
      body.innerHTML=`<div class="cw"><span class="snoozed-badge">üîï Snoozed</span>
        <div class="ca" style="margin-top:8px">${item.activity}</div>
        <div class="cm"><span class="cl">Resumes ${new Date(until).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
        <span class="ct" id="snooze-timer">${fmtMs(until-Date.now())}</span></div></div>`;
      return;
    }
  }
  const {cur,next}=getCurNext();
  if (cur===-1&&next===-1) { body.innerHTML=`<div class="empty-state">‚ú® All done for today!</div>`; return; }
  if (cur===-1) {
    const ni=S.config.schedule[next]; const rem=schedDate(ni.time)-Date.now();
    body.innerHTML=`<div class="cw"><div class="ca">Up next: ${ni.activity}</div>
      <div class="cm"><span class="cl">Starts in</span><span class="ct${rem<60000?' urgent':''}" id="main-timer">${fmtMs(rem)}</span></div>
      <div class="pb-wrap"><div class="pb-fill" id="prog-bar" style="width:0%"></div></div></div>`;
    return;
  }
  const ci=S.config.schedule[cur];
  if (next===-1) {
    body.innerHTML=`<div class="cw"><div class="ca">${ci.activity}</div>
      <div style="font-size:12px;font-family:var(--font-mono);color:var(--accent);margin-top:4px">‚ú® Final activity</div></div>`;
    return;
  }
  const ni=S.config.schedule[next], rem=schedDate(ni.time)-Date.now();
  const span=schedDate(ni.time)-schedDate(ci.time), pct=Math.max(0,Math.min(100,100-(rem/span*100)));
  body.innerHTML=`<div class="cw"><div class="ca">${ci.activity}</div>
    <div class="cm"><span class="cl">Next: ${ni.time}</span><span class="ct${rem<60000?' urgent':''}" id="main-timer">${fmtMs(rem)}</span></div>
    <div class="pb-wrap"><div class="pb-fill" id="prog-bar" style="width:${pct}%"></div></div></div>`;
}

function tickCountdown() {
  const snEl=document.getElementById('snooze-timer');
  if (snEl) { for (const idx in S.snooze) { if(S.snooze[idx]>Date.now()){ snEl.textContent=fmtMs(S.snooze[idx]-Date.now()); return; }} renderCountdown(); return; }
  const tEl=document.getElementById('main-timer'); if (!tEl) return;
  const {next}=getCurNext(); if (next===-1) { renderCountdown(); return; }
  const rem=schedDate(S.config.schedule[next].time)-Date.now();
  if (rem<=0) { renderCountdown(); return; }
  tEl.textContent=fmtMs(rem);
  rem<60000?tEl.classList.add('urgent'):tEl.classList.remove('urgent');
  const prog=document.getElementById('prog-bar');
  if (prog) { const {cur}=getCurNext(); if(cur!==-1){ const sp=schedDate(S.config.schedule[next].time)-schedDate(S.config.schedule[cur].time); prog.style.width=Math.max(0,Math.min(100,100-(rem/sp*100)))+'%'; }}
}

// ‚îÄ‚îÄ RENDER ‚Äî HABIT BARS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHabitBars() {
  const el = document.getElementById('card-habits'); if (!el) return;
  const body = el.querySelector('.card-body');
  const defs = S.config?.habitDefinitions;
  const editMode = !!S._habitEditMode;

  // Toggle done ledge
  const ledge = document.getElementById('habit-done-ledge');
  if (ledge) ledge.style.display = editMode ? 'block' : 'none';
  const pill = document.getElementById('habit-done-pill');
  if (pill) pill.style.display = editMode ? 'flex' : 'none';
  const editBtn = document.getElementById('habit-edit-btn');
  if (editBtn) { editBtn.textContent = editMode ? '‚úé editing' : '‚úé edit'; editBtn.style.color = editMode ? 'var(--accent)' : 'var(--muted)'; }

  if (!defs || !Object.keys(defs).length) {
    if (editMode) {
      const g = document.createElement('div'); g.className = 'habits-grid';
      const ac = document.createElement('div'); ac.className = 'habit-add-col';
      ac.innerHTML = `<div class="habit-add-btn">Ôºã</div><div class="habit-add-label">add</div>`;
      ac.addEventListener('click', () => showAddHabitSheet());
      g.appendChild(ac); body.innerHTML = ''; body.appendChild(g);
    } else {
      body.innerHTML = `<div class="empty-state">No habits configured</div>`;
    }
    return;
  }

  const grid = document.createElement('div'); grid.className = 'habits-grid';

  for (const [key, cfg] of Object.entries(defs)) {
    const raw = S.habitData[key] || 0;
    const dv = cfg.type === 'choice' ? (raw > 0 ? 1 : 0) : raw;
    const mv = cfg.type === 'choice' ? 1 : (cfg.maxValue || 1);
    const complete = dv >= mv, pct = Math.max(2, (dv / mv) * 100);
    const col = document.createElement('div');
    col.className = 'habit-col'; col.dataset.key = key;

    if (editMode) {
      col.style.cssText = 'position:relative;width:56px;display:flex;flex-direction:column;align-items:center;gap:0;padding-top:6px';
      col.innerHTML = `
        <div style="font-size:30px;line-height:1;user-select:none;padding-bottom:4px">${cfg.icon}</div>
        <button class="habit-edit-icon" data-key="${key}" style="width:52px;padding:3px 0;background:rgba(0,255,136,.13);border:1.5px solid rgba(0,255,136,.35);border-bottom:none;border-radius:8px 8px 0 0;color:var(--accent);font-size:10px;font-family:var(--font-mono);font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:3px">‚úé edit</button>
        <button class="habit-remove-btn-inline" data-key="${key}" style="width:52px;padding:3px 0;background:rgba(255,68,102,.1);border:1.5px solid rgba(255,68,102,.3);border-radius:0 0 8px 8px;color:var(--danger);font-size:10px;font-family:var(--font-mono);font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:3px">‚úï del</button>
        <div style="font-size:9px;font-family:var(--font-mono);color:var(--muted);text-align:center;max-width:52px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:5px">${key}</div>`;
    } else {
      col.innerHTML = `
        <div class="habit-bar-track"><div class="habit-bar-fill${complete ? ' complete' : ''}" style="height:${pct}%"></div></div>
        <div class="habit-icon" data-key="${key}">${cfg.icon}</div>
        <div class="habit-val${complete ? ' complete' : ''}">${dv}/${mv}</div>`;

      const iconEl = col.querySelector('.habit-icon');
      iconEl.addEventListener('click', () => {
        showManualModal(key);
      });

      // Double-tap ‚Üí jump to schedule
      let lastTap = 0;
      col.addEventListener('click', () => {
        const now = Date.now();
        if (now - lastTap < 350) {
          if (S._switchTab) S._switchTab(1);
          setTimeout(() => {
            document.getElementById('schedule-tab')?.querySelector('.sched-tab-item.current, .current')
              ?.scrollIntoView({ block: 'center', behavior: 'smooth' });
          }, 380);
        }
        lastTap = now;
      });
    }
    grid.appendChild(col);
  }

  // Add "+" in edit mode
  if (editMode) {
    const ac = document.createElement('div'); ac.className = 'habit-add-col';
    ac.innerHTML = `<div class="habit-add-btn" style="margin-top:6px">Ôºã</div><div class="habit-add-label">add</div>`;
    ac.addEventListener('click', () => showAddHabitSheet());
    grid.appendChild(ac);
  }

  body.innerHTML = ''; body.appendChild(grid);

  // Wire remove buttons
  grid.querySelectorAll('.habit-remove-btn-inline').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const k = btn.dataset.key;
      if (!S.config?.habitDefinitions || !confirm(`Remove habit "${k}"?`)) return;
      delete S.config.habitDefinitions[k];
      LS.set('lastConfig', S.config);
      saveHabitDefinitionsToVault();
      renderHabitBars();
      showToast(`Removed ${k}`);
    });
  });

  // Wire edit icon click in edit mode
  grid.querySelectorAll('.habit-edit-icon').forEach(iconEl => {
    iconEl.addEventListener('click', e => {
      e.stopPropagation();
      showEditHabitSheet(iconEl.dataset.key);
    });
  });
}

// ‚îÄ‚îÄ EMOJI POP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showEmojiPop(emoji, anchorEl) {
  const r = anchorEl.getBoundingClientRect();
  const p = document.createElement('div');
  p.textContent = emoji;
  p.style.cssText = `position:fixed;left:${r.left+r.width/2}px;top:${r.top}px;font-size:32px;pointer-events:none;z-index:9999;transform:translate(-50%,0);animation:emojiPop .65s cubic-bezier(.34,1.56,.64,1) forwards`;
  document.body.appendChild(p);
  setTimeout(() => p.remove(), 700);
}

// ‚îÄ‚îÄ SAVE HABIT DEFINITIONS TO VAULT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Writes the habitDefinitions block back into the .md frontmatter
async function saveHabitDefinitionsToVault() {
  LS.set('lastConfig', S.config);
  LS.set('lastScheduleEdit', Date.now());
  if (!S.vaultDirHandle || !S.config) return;
  try {
    for await (const entry of S.vaultDirHandle.values()) {
      if (entry.kind === 'file' && entry.name.endsWith('.md') && !entry.name.match(/^\d{16}HT\.md$/)) {
        const file = await entry.getFile();
        const originalText = await file.text();
        const newText = rebuildHabitDefsInMd(originalText, S.config.habitDefinitions || {});
        if (newText === null) continue;
        const fh = await S.vaultDirHandle.getFileHandle(entry.name, { create: false });
        const w = await fh.createWritable();
        await w.write(newText);
        await w.close();
        return;
      }
    }
  } catch(e) { console.warn('Habit def vault write failed:', e.message); }
}

// Rebuild habitDefinitions block inside .md frontmatter
function rebuildHabitDefsInMd(text, defs) {
  const fmMatch = text.match(/^(---\n)([\s\S]+?)(\n---)([\s\S]*)$/);
  if (!fmMatch) return null;
  const [, open, yaml, close, body] = fmMatch;

  // Build YAML for each habit def
  const defLines = ['habitDefinitions:'];
  for (const [key, cfg] of Object.entries(defs)) {
    defLines.push(`  ${key}:`);
    defLines.push(`    type: ${cfg.type || 'incremental'}`);
    defLines.push(`    icon: ${cfg.icon || '‚≠ê'}`);
    if (cfg.type === 'incremental') {
      defLines.push(`    maxValue: ${cfg.maxValue || 1}`);
      defLines.push(`    increment: ${cfg.increment || 1}`);
      if (cfg.messages && Object.keys(cfg.messages).length) {
        defLines.push('    messages:');
        for (const [mk, mv] of Object.entries(cfg.messages)) defLines.push(`      ${mk}: '${mv}'`);
      }
    } else {
      if (cfg.messages?.failed) {
        defLines.push('    messages:');
        defLines.push(`      failed: '${cfg.messages.failed}'`);
      }
      if (cfg.choices?.length) {
        defLines.push('    choices:');
        cfg.choices.forEach(c => {
          defLines.push(`      - value: ${c.value}`);
          defLines.push(`        label: '${c.label}'`);
          if (c.message) defLines.push(`        message: '${c.message}'`);
        });
      }
    }
  }

  // Line-by-line replacement
  const lines = yaml.split('\n'); const out = []; let inBlock = false;
  for (const line of lines) {
    if (/^habitDefinitions:\s*$/.test(line)) { inBlock = true; out.push(...defLines); continue; }
    if (inBlock) { if (/^\s+/.test(line) || line.trim() === '') continue; inBlock = false; }
    out.push(line);
  }
  if (!out.some(l => l.startsWith('habitDefinitions:'))) out.push(...defLines);
  return open + out.join('\n') + close + body;
}

// ‚îÄ‚îÄ ADD HABIT SHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAddHabitSheet() {
  const existingKeys = Object.keys(S.config?.habitDefinitions || {}).map(k => k.toLowerCase());

  const ov = document.createElement('div'); ov.className = 'add-sched-modal';
  ov.innerHTML = `<div class="add-sched-sheet" style="max-height:88dvh;overflow-y:auto">
    <div class="modal-handle"></div>
    <div style="font-size:16px;font-weight:800;margin-bottom:16px">Add Habit</div>

    <div style="display:flex;gap:8px;margin-bottom:14px" id="ah-type-row">
      <button class="btn btn-green" id="ah-type-incr" style="flex:1;font-size:13px">‚¨Ü Incremental</button>
      <button class="btn btn-ghost" id="ah-type-choice" style="flex:1;font-size:13px">‚òë Choice</button>
    </div>

    <input type="text" id="ah-key" placeholder="Habit key ‚Äî e.g. water" autocomplete="off" spellcheck="false"/>
    <input type="text" id="ah-icon" placeholder="Emoji icon ‚Äî e.g. üíß" autocomplete="off"/>

    <div id="ah-incr-fields">
      <input type="number" id="ah-max" placeholder="Daily goal ‚Äî e.g. 8" min="1" max="200"/>
      <input type="number" id="ah-incr" placeholder="Count per tap ‚Äî e.g. 1" min="1" max="50"/>
    </div>

    <div id="ah-choice-fields" style="display:none">
      <div style="font-size:11px;font-family:var(--font-mono);color:var(--muted);margin-bottom:8px">Add choices (at least 1):</div>
      <div id="ah-choices-list"></div>
      <button class="btn btn-ghost" id="ah-add-choice" style="width:100%;margin-bottom:10px;font-size:13px">Ôºã Add Choice</button>
    </div>

    <div style="display:flex;gap:10px;margin-top:6px">
      <button class="btn btn-ghost" id="ah-cancel" style="flex:1">Cancel</button>
      <button class="btn btn-green" id="ah-add" style="flex:2">Ôºã Add Habit</button>
    </div>
  </div>`;
  document.body.appendChild(ov);

  let habitType = 'incremental';
  const choicesList = ov.querySelector('#ah-choices-list');
  let choiceCount = 0;

  function addChoiceRow(label = '', value = '') {
    choiceCount++;
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;gap:6px;align-items:center;margin-bottom:6px';
    row.dataset.choiceIdx = choiceCount;
    row.innerHTML = `
      <input type="text" placeholder="Label ‚Äî e.g. Good" value="${label}" style="flex:2;margin-bottom:0" class="ah-ch-label"/>
      <input type="number" placeholder="Val" value="${value}" min="0" max="100" style="flex:1;margin-bottom:0;width:60px" class="ah-ch-val"/>
      <button style="width:28px;height:28px;border-radius:7px;border:1px solid rgba(255,68,102,.3);background:rgba(255,68,102,.08);color:var(--danger);font-size:13px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center" class="ah-ch-del">‚úï</button>`;
    row.querySelector('.ah-ch-del').addEventListener('click', () => row.remove());
    // style inputs to match sheet
    row.querySelectorAll('input').forEach(i => {
      i.style.cssText += ';width:auto;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 10px;color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none';
      i.addEventListener('focus', () => i.style.borderColor='var(--accent)');
      i.addEventListener('blur', () => i.style.borderColor='var(--border)');
    });
    choicesList.appendChild(row);
  }
  // Start with 2 default choices
  addChoiceRow('', 1);
  addChoiceRow('', 2);

  // Type switcher
  ov.querySelector('#ah-type-incr').addEventListener('click', () => {
    habitType = 'incremental';
    ov.querySelector('#ah-type-incr').className = 'btn btn-green'; ov.querySelector('#ah-type-incr').style.flex='1'; ov.querySelector('#ah-type-incr').style.fontSize='13px';
    ov.querySelector('#ah-type-choice').className = 'btn btn-ghost'; ov.querySelector('#ah-type-choice').style.flex='1'; ov.querySelector('#ah-type-choice').style.fontSize='13px';
    ov.querySelector('#ah-incr-fields').style.display = '';
    ov.querySelector('#ah-choice-fields').style.display = 'none';
  });
  ov.querySelector('#ah-type-choice').addEventListener('click', () => {
    habitType = 'choice';
    ov.querySelector('#ah-type-choice').className = 'btn btn-green'; ov.querySelector('#ah-type-choice').style.flex='1'; ov.querySelector('#ah-type-choice').style.fontSize='13px';
    ov.querySelector('#ah-type-incr').className = 'btn btn-ghost'; ov.querySelector('#ah-type-incr').style.flex='1'; ov.querySelector('#ah-type-incr').style.fontSize='13px';
    ov.querySelector('#ah-incr-fields').style.display = 'none';
    ov.querySelector('#ah-choice-fields').style.display = '';
  });

  ov.querySelector('#ah-add-choice').addEventListener('click', () => addChoiceRow());

  const close = () => document.body.removeChild(ov);
  ov.addEventListener('click', e => { if (e.target === ov) close(); });
  ov.querySelector('#ah-cancel').addEventListener('click', close);
  setTimeout(() => ov.querySelector('#ah-key').focus(), 100);

  ov.querySelector('#ah-add').addEventListener('click', () => {
    const rawKey = ov.querySelector('#ah-key').value.trim().replace(/\s+/g, '_');
    const icon = ov.querySelector('#ah-icon').value.trim() || '‚≠ê';
    if (!rawKey) { showToast('Enter a habit name'); return; }

    // Duplicate check
    if (existingKeys.includes(rawKey.toLowerCase())) {
      showToast(`"${rawKey}" already exists`); return;
    }

    if (!S.config) S.config = { schedule: [], habitDefinitions: {}, habitTracker: { enabled: true, snoozeOptions: [5, 10] } };
    if (!S.config.habitDefinitions) S.config.habitDefinitions = {};

    if (habitType === 'incremental') {
      const maxVal = parseInt(ov.querySelector('#ah-max').value) || 1;
      const incrVal = parseInt(ov.querySelector('#ah-incr').value) || 1;
      S.config.habitDefinitions[rawKey] = { type: 'incremental', icon, maxValue: maxVal, increment: incrVal, messages: {} };
    } else {
      const rows = choicesList.querySelectorAll('[data-choice-idx]');
      const choices = [];
      let v = 0;
      rows.forEach(row => {
        const label = row.querySelector('.ah-ch-label').value.trim();
        const val = parseInt(row.querySelector('.ah-ch-val').value);
        if (label) { v++; choices.push({ value: isNaN(val) ? v : val, label }); }
      });
      if (!choices.length) { showToast('Add at least one choice'); return; }
      S.config.habitDefinitions[rawKey] = { type: 'choice', icon, choices, messages: {} };
    }

    LS.set('lastConfig', S.config);
    saveHabitDefinitionsToVault();
    close();
    renderHabitBars();
    showToast(`‚úì ${rawKey} added`);
  });
}

// ‚îÄ‚îÄ EDIT HABIT SHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showEditHabitSheet(key) {
  const existingCfg = S.config?.habitDefinitions?.[key]; if (!existingCfg) return;

  const ov = document.createElement('div'); ov.className = 'add-sched-modal';
  ov.innerHTML = `<div class="add-sched-sheet" style="max-height:88dvh;overflow-y:auto">
    <div class="modal-handle"></div>
    <div style="font-size:16px;font-weight:800;margin-bottom:16px">Edit Habit</div>

    <div style="display:flex;gap:8px;margin-bottom:14px" id="ah-type-row">
      <button class="btn ${existingCfg.type==='incremental'?'btn-green':'btn-ghost'}" id="ah-type-incr" style="flex:1;font-size:13px">‚¨Ü Incremental</button>
      <button class="btn ${existingCfg.type==='choice'?'btn-green':'btn-ghost'}" id="ah-type-choice" style="flex:1;font-size:13px">‚òë Choice</button>
    </div>

    <input type="text" id="ah-key" placeholder="Habit key ‚Äî e.g. water" value="${key}" autocomplete="off" spellcheck="false"/>
    <input type="text" id="ah-icon" placeholder="Emoji icon ‚Äî e.g. üíß" value="${existingCfg.icon||'‚≠ê'}" autocomplete="off"/>

    <div id="ah-incr-fields" style="${existingCfg.type==='choice'?'display:none':''}">
      <input type="number" id="ah-max" placeholder="Daily goal ‚Äî e.g. 8" min="1" max="200" value="${existingCfg.maxValue||''}"/>
      <input type="number" id="ah-incr" placeholder="Count per tap ‚Äî e.g. 1" min="1" max="50" value="${existingCfg.increment||''}"/>
    </div>

    <div id="ah-choice-fields" style="${existingCfg.type==='incremental'?'display:none':''}">
      <div style="font-size:11px;font-family:var(--font-mono);color:var(--muted);margin-bottom:8px">Choices:</div>
      <div id="ah-choices-list"></div>
      <button class="btn btn-ghost" id="ah-add-choice" style="width:100%;margin-bottom:10px;font-size:13px">Ôºã Add Choice</button>
    </div>

    <div style="display:flex;gap:10px;margin-top:6px">
      <button class="btn btn-ghost" id="ah-cancel" style="flex:1">Cancel</button>
      <button class="btn btn-green" id="ah-save" style="flex:2">‚úì Save Changes</button>
    </div>
  </div>`;
  document.body.appendChild(ov);

  let habitType = existingCfg.type || 'incremental';
  const choicesList = ov.querySelector('#ah-choices-list');
  let choiceCount = 0;

  function addChoiceRow(label = '', value = '') {
    choiceCount++;
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;gap:6px;align-items:center;margin-bottom:6px';
    row.dataset.choiceIdx = choiceCount;
    row.innerHTML = `
      <input type="text" placeholder="Label ‚Äî e.g. Good" value="${label}" style="flex:2;margin-bottom:0" class="ah-ch-label"/>
      <input type="number" placeholder="Val" value="${value}" min="0" max="100" style="flex:1;margin-bottom:0;width:60px" class="ah-ch-val"/>
      <button style="width:28px;height:28px;border-radius:7px;border:1px solid rgba(255,68,102,.3);background:rgba(255,68,102,.08);color:var(--danger);font-size:13px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center" class="ah-ch-del">‚úï</button>`;
    row.querySelector('.ah-ch-del').addEventListener('click', () => row.remove());
    row.querySelectorAll('input').forEach(i => {
      i.style.cssText += ';width:auto;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 10px;color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none';
      i.addEventListener('focus', () => i.style.borderColor='var(--accent)');
      i.addEventListener('blur', () => i.style.borderColor='var(--border)');
    });
    choicesList.appendChild(row);
  }

  // Pre-populate choices if editing a choice habit
  if (existingCfg.type === 'choice' && existingCfg.choices?.length) {
    existingCfg.choices.forEach(c => addChoiceRow(c.label || '', c.value || ''));
  } else if (existingCfg.type !== 'choice') {
    addChoiceRow('', 1); addChoiceRow('', 2);
  }

  ov.querySelector('#ah-type-incr').addEventListener('click', () => {
    habitType = 'incremental';
    ov.querySelector('#ah-type-incr').className = 'btn btn-green'; ov.querySelector('#ah-type-incr').style.flex='1'; ov.querySelector('#ah-type-incr').style.fontSize='13px';
    ov.querySelector('#ah-type-choice').className = 'btn btn-ghost'; ov.querySelector('#ah-type-choice').style.flex='1'; ov.querySelector('#ah-type-choice').style.fontSize='13px';
    ov.querySelector('#ah-incr-fields').style.display = '';
    ov.querySelector('#ah-choice-fields').style.display = 'none';
  });
  ov.querySelector('#ah-type-choice').addEventListener('click', () => {
    habitType = 'choice';
    ov.querySelector('#ah-type-choice').className = 'btn btn-green'; ov.querySelector('#ah-type-choice').style.flex='1'; ov.querySelector('#ah-type-choice').style.fontSize='13px';
    ov.querySelector('#ah-type-incr').className = 'btn btn-ghost'; ov.querySelector('#ah-type-incr').style.flex='1'; ov.querySelector('#ah-type-incr').style.fontSize='13px';
    ov.querySelector('#ah-incr-fields').style.display = 'none';
    ov.querySelector('#ah-choice-fields').style.display = '';
  });

  ov.querySelector('#ah-add-choice').addEventListener('click', () => addChoiceRow());

  const close = () => document.body.removeChild(ov);
  ov.addEventListener('click', e => { if (e.target === ov) close(); });
  ov.querySelector('#ah-cancel').addEventListener('click', close);

  ov.querySelector('#ah-save').addEventListener('click', () => {
    const newKey = ov.querySelector('#ah-key').value.trim().replace(/\s+/g, '_');
    const icon = ov.querySelector('#ah-icon').value.trim() || '‚≠ê';
    if (!newKey) { showToast('Enter a habit name'); return; }

    if (!S.config) S.config = { schedule: [], habitDefinitions: {}, habitTracker: { enabled: true, snoozeOptions: [5, 10] } };
    if (!S.config.habitDefinitions) S.config.habitDefinitions = {};

    // If key changed, remove old entry
    if (newKey !== key) {
      delete S.config.habitDefinitions[key];
      if (S.habitData[key] !== undefined) { S.habitData[newKey] = S.habitData[key]; delete S.habitData[key]; }
    }

    if (habitType === 'incremental') {
      const maxVal = parseInt(ov.querySelector('#ah-max').value) || 1;
      const incrVal = parseInt(ov.querySelector('#ah-incr').value) || 1;
      S.config.habitDefinitions[newKey] = { type: 'incremental', icon, maxValue: maxVal, increment: incrVal, messages: existingCfg.messages||{} };
    } else {
      const rows = choicesList.querySelectorAll('[data-choice-idx]');
      const choices = [];
      let v = 0;
      rows.forEach(row => {
        const label = row.querySelector('.ah-ch-label').value.trim();
        const val = parseInt(row.querySelector('.ah-ch-val').value);
        if (label) { v++; choices.push({ value: isNaN(val) ? v : val, label }); }
      });
      if (!choices.length) { showToast('Add at least one choice'); return; }
      S.config.habitDefinitions[newKey] = { type: 'choice', icon, choices, messages: existingCfg.messages||{} };
    }

    LS.set('lastConfig', S.config);
    saveHabitDefinitionsToVault();
    close();
    renderHabitBars();
    showToast(`‚úì ${newKey} updated`);
  });
}


function showManualModal(key) {
  const cfg=S.config?.habitDefinitions?.[key]; if (!cfg) return;
  const raw=S.habitData[key]||0;
  const dv=cfg.type==='choice'?(raw>0?1:0):raw, mv=cfg.type==='choice'?1:(cfg.maxValue||1);
  const isComplete = dv >= mv;
  const ov=document.createElement('div'); ov.className='modal-overlay';
  let actions='';
  const showSimpleIncr = cfg.type==='incremental' && cfg.maxValue===1 && (cfg.increment||1)===1;
  if (cfg.type==='incremental') {
    const currentDisplay = showSimpleIncr ? '' : `<div style="font-size:12px;font-family:var(--font-mono);color:var(--muted);text-align:center;margin-bottom:${isComplete?'8px':'16px'}">
        Current: <strong style="color:var(--text)">${dv} / ${mv}</strong></div>`;
    actions=`${currentDisplay}
      ${isComplete?`<div style="font-size:11px;font-family:var(--font-mono);color:var(--accent);text-align:center;margin-bottom:14px;padding:6px 12px;background:rgba(0,255,136,.08);border-radius:8px">‚úì Goal reached!</div>`:''}
      <div class="btn-row">
        <button class="btn btn-green btn-icon" id="mh-inc" ${isComplete?'disabled style="opacity:.45;cursor:not-allowed"':''}>Ôºã</button>
        <button class="btn btn-red btn-icon" id="mh-dec">‚àí</button>
      </div>`;
  } else {
    actions=`${isComplete?`<div style="font-size:11px;font-family:var(--font-mono);color:var(--accent);text-align:center;margin-bottom:14px;padding:6px 12px;background:rgba(0,255,136,.08);border-radius:8px">‚úì Already completed ‚Äî tap to change</div>`:''}
      <div class="btn-row">
        ${cfg.choices.map(c=>`<button class="btn btn-green mh-ch" data-val="${c.value}" style="${raw===c.value?'outline:2px solid var(--accent)':''}">${c.label}</button>`).join('')}
        ${cfg.messages?.failed?`<button class="btn btn-red mh-fail">‚úï Fail</button>`:''}
      </div>`;
  }
  ov.innerHTML=`<div class="modal">
    <div class="modal-handle"></div>
    <div style="font-size:48px;text-align:center;margin-bottom:8px">${cfg.icon}</div>
    <div style="font-size:16px;font-weight:700;text-align:center;margin-bottom:16px">${key}</div>
    ${actions}
    <div style="margin-top:16px"><button class="btn btn-ghost" style="width:100%" id="mh-close">Close</button></div>
  </div>`;
  document.body.appendChild(ov);
  ov.addEventListener('click',e=>{ if(e.target===ov) document.body.removeChild(ov); });
  ov.querySelector('#mh-close').addEventListener('click',()=>document.body.removeChild(ov));
  if (cfg.type==='incremental') {
    ov.querySelector('#mh-inc').addEventListener('click',()=>{ 
      const cur2 = S.habitData[key]||0;
      if (cur2 >= cfg.maxValue) { showToast(cfg.messages?.maxReached||'Already at max!'); return; }
      S.habitData[key]=Math.min(cfg.maxValue, cur2+(cfg.increment||1));
      showToast(cfg.messages?.[S.habitData[key]]||'Logged!');
      writeHabitData(); renderHabitBars();
      document.body.removeChild(ov); 
    });
    ov.querySelector('#mh-dec').addEventListener('click',()=>{ decrementHabit(key); document.body.removeChild(ov); });
  } else {
    ov.querySelectorAll('.mh-ch').forEach(b=>b.addEventListener('click',()=>{ updateHabit(key,parseInt(b.dataset.val)); document.body.removeChild(ov); }));
    ov.querySelector('.mh-fail')?.addEventListener('click',()=>{ updateHabit(key,0); document.body.removeChild(ov); });
  }
}

// ‚îÄ‚îÄ RENDER ‚Äî SCHEDULE TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Store a snapshot for dirty-checking before saving a backup
let _scheduleSnapshot = null;

function renderScheduleTab(editMode) {
  const el = document.getElementById('schedule-tab');
  if (!el) return;

  const sc = S.config?.schedule;

  if (!sc?.length && !editMode) {
    el.innerHTML = `<div class="schedule-empty">üì≠ No schedule loaded<br>
      <small style="font-size:11px;font-family:var(--font-mono);opacity:.7">Connect your vault or tap ‚úé to add entries</small></div>`;
    return;
  }

  const { cur } = getCurNext(), now = new Date();
  let html = '';

  if (!sc?.length) {
    html += `<div class="schedule-empty" style="padding:40px 0">No entries yet ‚Äî tap ‚úé to add one</div>`;
  } else {
    html += `<div class="sched-tab-list">`;
    sc.forEach((item, i) => {
      const t = schedDate(item.time);
      const isCur = i === cur, isPast = t < now && !isCur;

      if (editMode) {
        html += `<div class="sched-edit-row" data-idx="${i}">
          <button class="sched-tab-del" data-idx="${i}" title="Delete">‚úï</button>
          <div class="sched-edit-fields">
            <input class="sched-edit-time" data-idx="${i}" value="${item.time.replace(/&/g,'&amp;').replace(/"/g,'&quot;')}" placeholder="9:00 AM" autocomplete="off" spellcheck="false"/>
            <input class="sched-edit-act" data-idx="${i}" value="${item.activity.replace(/&/g,'&amp;').replace(/"/g,'&quot;')}" placeholder="Activity" autocomplete="off"/>
          </div>
        </div>`;
      } else {
        html += `<div class="sched-tab-item ${isCur ? 'current' : ''} ${isPast ? 'past' : ''}">
          <div class="sched-tab-time-block">
            <span class="sched-tab-time">${item.time}</span>
            ${isCur ? `<span class="sched-current-label">Now</span>` : ''}
          </div>
          <div class="sched-tab-divider"></div>
          <span class="sched-tab-act">${item.activity}</span>
        </div>`;
      }
    });
    html += `</div>`;
  }

  el.innerHTML = html;

  if (!editMode) {
    setTimeout(() => el.querySelector('.current')?.scrollIntoView({ block: 'center', behavior: 'smooth' }), 150);
    return;
  }

  // ‚îÄ‚îÄ Edit mode: wire up fields ‚îÄ‚îÄ

  // Flush ALL current field values into S.config immediately (before any re-render)
  function flushAllEdits() {
    el.querySelectorAll('.sched-edit-time').forEach(inp => {
      const idx = parseInt(inp.dataset.idx);
      const actEl = el.querySelector(`.sched-edit-act[data-idx="${idx}"]`);
      const t = inp.value.trim(), a = actEl?.value.trim() || '';
      if (t && a && S.config?.schedule[idx]) {
        S.config.schedule[idx] = { time: t, activity: a };
      }
    });
    LS.set('lastConfig', S.config);
  }

  // Save on every keystroke so nothing is lost
  el.querySelectorAll('.sched-edit-time, .sched-edit-act').forEach(input => {
    input.addEventListener('input', () => {
      const idx = parseInt(input.dataset.idx);
      const timeEl = el.querySelector(`.sched-edit-time[data-idx="${idx}"]`);
      const actEl = el.querySelector(`.sched-edit-act[data-idx="${idx}"]`);
      if (!timeEl || !actEl) return;
      const t = timeEl.value.trim(), a = actEl.value.trim();
      if (t && a && S.config?.schedule[idx]) {
        S.config.schedule[idx] = { time: t, activity: a };
        LS.set('lastConfig', S.config);
      }
    });
    input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); input.blur(); } });
  });

  // Delete button ‚Äî flush first, then splice
  el.querySelectorAll('.sched-tab-del').forEach(b => {
    b.addEventListener('click', () => {
      flushAllEdits();
      const idx = parseInt(b.dataset.idx);
      S.config.schedule.splice(idx, 1);
      LS.set('lastConfig', S.config);
      saveScheduleToVault();
      forceSwUpdate();
      renderScheduleTab(true);
    });
  });
}

// ‚îÄ‚îÄ ADD SCHEDULE ENTRY SHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAddScheduleSheet(onDone) {
  const ov = document.createElement('div');
  ov.className = 'add-sched-modal';
  ov.innerHTML = `<div class="add-sched-sheet">
    <div class="modal-handle"></div>
    <div style="font-size:16px;font-weight:800;margin-bottom:16px">Add Schedule Entry</div>
    <input type="text" id="as-time" placeholder="Time ‚Äî e.g. 9:00 AM" autocomplete="off" spellcheck="false"/>
    <input type="text" id="as-act" placeholder="Activity description" autocomplete="off"/>
    <div style="display:flex;gap:10px;margin-top:4px">
      <button class="btn btn-ghost" id="as-cancel" style="flex:1">Cancel</button>
      <button class="btn btn-green" id="as-add" style="flex:2">+ Add</button>
    </div>
  </div>`;
  document.body.appendChild(ov);
  const timeIn = ov.querySelector('#as-time');
  const actIn = ov.querySelector('#as-act');
  setTimeout(() => timeIn.focus(), 100);
  const close = () => document.body.removeChild(ov);
  ov.querySelector('#as-cancel').addEventListener('click', close);
  ov.addEventListener('click', e => { if (e.target === ov) close(); });
  ov.querySelector('#as-add').addEventListener('click', () => {
    const t = timeIn.value.trim(), a = actIn.value.trim();
    if (!t || !a) { showToast('Fill in both fields'); return; }
    if (!S.config) S.config = { schedule: [], habitDefinitions: {}, habitTracker: { enabled: true, snoozeOptions: [5, 10] } };
    S.config.schedule.push({ time: t, activity: a });
    try { S.config.schedule.sort((a, b) => schedDate(a.time) - schedDate(b.time)); } catch {}
    LS.set('lastConfig', S.config);
    saveScheduleToVault();
    forceSwUpdate();
    close();
    onDone();
    showToast('‚úì Entry added');
  });
  // Enter on activity field submits
  actIn.addEventListener('keydown', e => { if (e.key === 'Enter') ov.querySelector('#as-add').click(); });
}

async function saveScheduleToVault() {
  // Always persist to localStorage with a timestamp so loadTemplate knows not to overwrite
  LS.set('lastConfig', S.config);
  LS.set('lastScheduleEdit', Date.now());

  if (!S.vaultDirHandle || !S.config) return;
  try {
    // Find the config .md file
    for await (const entry of S.vaultDirHandle.values()) {
      if (entry.kind === 'file' && entry.name.endsWith('.md') && !entry.name.match(/^\d{16}HT\.md$/)) {
        const file = await entry.getFile();
        const originalText = await file.text();

        // Rebuild the frontmatter schedule block while preserving everything else
        const newText = rebuildScheduleInMd(originalText, S.config.schedule);
        if (newText === null) continue;

        // Write backup BEFORE overwriting the main file
        await writeScheduleBackup(originalText, entry.name);

        // Write the updated config back to the main .md file
        const fh = await S.vaultDirHandle.getFileHandle(entry.name, { create: false });
        const w = await fh.createWritable();
        await w.write(newText);
        await w.close();
        return;
      }
    }
  } catch(e) {
    console.warn('Schedule vault write failed (localStorage used):', e.message);
  }
}

// Write a rotating backup (max 3) into vault/backup/ folder
async function writeScheduleBackup(originalText, sourceFilename) {
  try {
    // Get or create vault/backup/ directory
    const backupDir = await S.vaultDirHandle.getDirectoryHandle('backup', { create: true });

    // Collect existing schedule backup files, sorted oldest-first
    const existing = [];
    for await (const entry of backupDir.values()) {
      if (entry.kind === 'file' && entry.name.startsWith('schedule-backup-') && entry.name.endsWith('.md')) {
        existing.push(entry.name);
      }
    }
    existing.sort(); // ISO timestamp prefix = chronological sort

    // Delete oldest backups if we already have 3 or more
    while (existing.length >= 3) {
      const oldest = existing.shift();
      try { await backupDir.removeEntry(oldest); } catch {}
    }

    // Write new backup file named with current timestamp
    const ts = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    const backupName = `schedule-backup-${ts}.md`;
    const bfh = await backupDir.getFileHandle(backupName, { create: true });
    const bw = await bfh.createWritable();
    await bw.write(`# Schedule Backup ‚Äî ${new Date().toLocaleString()}\n# Source: ${sourceFilename}\n\n${originalText}`);
    await bw.close();
  } catch(e) {
    console.warn('Backup write failed:', e.message);
  }
}

// Rebuild the schedule block inside .md frontmatter (line-by-line, no regex gotchas)
function rebuildScheduleInMd(text, schedule) {
  const fmMatch = text.match(/^(---\n)([\s\S]+?)(\n---)([\s\S]*)$/);
  if (!fmMatch) return null;
  const [, open, yaml, close, body] = fmMatch;
  const schedLines = ['schedule:'];
  schedule.forEach(item => { schedLines.push(`  - time: '${item.time}'`); schedLines.push(`    activity: '${item.activity}'`); });
  const lines = yaml.split('\n'); const out = []; let inBlock = false;
  for (const line of lines) {
    if (/^schedule:\s*$/.test(line)) { inBlock = true; out.push(...schedLines); continue; }
    if (inBlock) { if (/^\s+/.test(line) || line.trim() === '') continue; inBlock = false; }
    out.push(line);
  }
  if (!out.some(l => l.startsWith('schedule:'))) out.push(...schedLines);
  return open + out.join('\n') + close + body;
}

// ‚îÄ‚îÄ VAULT BACKUP VIEWER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function showVaultBackups() {
  const ov = document.createElement('div'); ov.className = 'modal-overlay';
  ov.innerHTML = `<div class="modal"><div class="modal-handle"></div>
    <div class="modal-title">Schedule Backups</div>
    <div id="backup-list-body"><div class="empty-state" style="padding:24px 0">Loading‚Ä¶</div></div>
    <button class="btn btn-ghost" style="width:100%;margin-top:16px" id="bv-close">Close</button>
  </div>`;
  document.body.appendChild(ov);
  const close = () => document.body.removeChild(ov);
  ov.addEventListener('click', e => { if (e.target === ov) close(); });
  ov.querySelector('#bv-close').addEventListener('click', close);

  const body = ov.querySelector('#backup-list-body');

  try {
    const backupDir = await S.vaultDirHandle.getDirectoryHandle('backup', { create: false });
    const files = [];
    for await (const entry of backupDir.values()) {
      if (entry.kind === 'file' && entry.name.startsWith('schedule-backup-') && entry.name.endsWith('.md')) {
        files.push(entry);
      }
    }
    files.sort((a, b) => b.name.localeCompare(a.name)); // newest first

    if (!files.length) {
      body.innerHTML = `<div class="empty-state" style="padding:24px 0">No backups yet.<br><small style="font-size:11px">Backups are created automatically when you save schedule changes.</small></div>`;
      return;
    }

    body.innerHTML = files.map((f, i) => {
      // Parse timestamp from filename: schedule-backup-2024-01-15T10-30-00.md
      const tsPart = f.name.replace('schedule-backup-', '').replace('.md', '').replace(/T/, ' ').replace(/-/g, (m, o) => o > 10 ? ':' : '-');
      return `<div class="s-row" style="flex-direction:column;align-items:stretch;gap:8px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div><div class="s-label" style="font-size:13px">Backup ${files.length - i}</div>
          <div class="s-sub">${f.name}</div></div>
          <button class="btn btn-ghost" style="min-height:36px;padding:6px 14px;font-size:13px" data-backup-idx="${i}">Restore</button>
        </div>
      </div>`;
    }).join('');

    // Wire restore buttons
    body.querySelectorAll('[data-backup-idx]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Restore this backup? Your current schedule will be replaced.')) return;
        try {
          const f = files[parseInt(btn.dataset.backupIdx)];
          const text = await (await f.getFile()).text();
          // The backup file starts with comment lines then the original .md content
          // Strip the comment header lines we added
          const mdStart = text.indexOf('---\n');
          if (mdStart === -1) { showToast('Could not parse backup file'); return; }
          const mdText = text.slice(mdStart);
          const cfg = parseMd(mdText);
          if (!cfg?.schedule?.length) { showToast('No schedule found in backup'); return; }
          if (!S.config) S.config = { schedule: [], habitDefinitions: {}, habitTracker: { enabled: true, snoozeOptions: [5, 10] } };
          S.config.schedule = cfg.schedule;
          LS.set('lastConfig', S.config);
          LS.set('lastScheduleEdit', Date.now());
          renderAll();
          showToast('‚Ü© Schedule restored from backup');
          close();
        } catch(e) {
          showToast('Restore failed: ' + e.message);
        }
      });
    });

  } catch(e) {
    body.innerHTML = `<div class="empty-state" style="padding:24px 0">No backup folder found yet.<br><small style="font-size:11px;font-family:var(--font-mono)">vault/backup/ is created automatically on first save.</small></div>`;
  }
}

// ‚îÄ‚îÄ SETTINGS MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function autoThemeForTime() { const h = new Date().getHours(); return (h >= 7 && h < 19) ? 'light' : 'dark'; }
function applyTheme(t) {
  LS.set('theme', t);
  const resolved = t === 'auto' ? autoThemeForTime() : t;
  document.documentElement.setAttribute('data-theme', resolved);
  const mc = document.querySelector('meta[name="theme-color"]');
  if (mc) mc.content = resolved === 'light' ? '#f2f2f7' : '#0a0a0f';
}
setInterval(() => { if ((LS.get('theme') || 'auto') === 'auto') applyTheme('auto'); }, 60000);

function isAndroid() { return /android/i.test(navigator.userAgent); }

function showSettings() {
  const ov=document.createElement('div'); ov.className='modal-overlay';
  const vaultName=LS.get('vaultFolderName')||'Not set';
  const vaultOk=!!S.vaultDirHandle;
  const np=S.notifPermission;
  const currentTheme = LS.get('theme') || 'auto';
  const hostedRemotely = !location.hostname.match(/^(localhost|127\.|192\.|10\.|file)/) && location.hostname !== '';
  const notifBlocked = np === 'denied';
  const android = isAndroid();
  const batteryDismissed = LS.get('batteryTipDismissed');

  const batterySection = (android && np === 'granted' && !batteryDismissed) ? `
    <div class="s-section">
      <div class="s-section-title">‚ö° Battery Optimization</div>
      <div style="background:rgba(255,170,0,.07);border:1px solid rgba(255,170,0,.25);border-radius:12px;padding:14px 16px;font-size:12px;font-family:var(--font-mono);color:var(--text);line-height:1.8">
        <div style="color:var(--warn);font-weight:700;margin-bottom:6px">üîã Enable for reliable background alarms</div>
        Android kills Chrome in the background to save battery ‚Äî this stops your alarms from firing when the screen is off.<br><br>
        <b style="color:var(--text)">Fix in 3 taps:</b><br>
        <span style="color:var(--accent)">1.</span> Settings ‚Üí Apps ‚Üí <b>Chrome</b><br>
        <span style="color:var(--accent)">2.</span> Battery ‚Üí <b>Unrestricted</b><br>
        <span style="color:var(--accent)">3.</span> Come back and tap "Done" below
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-ghost" id="s-battery-dismiss" style="flex:1;font-size:13px">‚úì Done / Dismiss</button>
        <button class="btn btn-green" id="s-battery-open" style="flex:2;font-size:13px">Open Android Settings</button>
      </div>
    </div>` : (android && np === 'granted' && batteryDismissed) ? `
    <div class="s-section">
      <div class="s-section-title">‚ö° Battery Optimization</div>
      <div class="s-row">
        <div><div class="s-label">Background Alarms</div><div class="s-sub">Chrome ‚Üí Battery ‚Üí Unrestricted</div></div>
        <span class="pill pill-green">SET ‚úì</span>
      </div>
      <button class="btn btn-ghost" id="s-battery-reset" style="width:100%;margin-top:8px;font-size:13px">Show instructions again</button>
    </div>` : '';

  const notifSection = notifBlocked ? `
    <div class="s-row">
      <div><div class="s-label">Push Alerts</div><div class="s-sub">Background alarm notifications</div></div>
      <span class="pill pill-red">BLOCKED</span>
    </div>
    <div class="notif-fix">
      ${hostedRemotely
        ? `<b>Blocked by your hosting provider.</b><br>Netlify and similar hosts disable notifications via HTTP headers. To fix:<br><br>
           1. Host the app locally instead (see Install Guide)<br>
           2. Or add <code>Permissions-Policy: notifications=(self)</code> to your Netlify <code>_headers</code> file`
        : `Notifications were blocked.<br><br>To unblock: <b>Chrome ‚Üí üîí lock icon ‚Üí Site settings ‚Üí Notifications ‚Üí Allow</b><br>Then reload.`
      }
    </div>` : np === 'default' ? `
    <div class="s-row">
      <div><div class="s-label">Push Alerts</div><div class="s-sub">Background alarm notifications</div></div>
      <span class="pill pill-amber">OFF</span>
    </div>
    <button class="btn btn-green" style="width:100%;margin-top:8px" id="s-notif">Enable Notifications</button>` : `
    <div class="s-row">
      <div><div class="s-label">Push Alerts</div><div class="s-sub">Background alarm notifications</div></div>
      <span class="pill pill-green">ON ‚úì</span>
    </div>`;

  const vaultName2 = LS.get('vaultFolderName') || 'vault';
  const backupSection = `<div class="s-section">
      <div class="s-section-title">Schedule Backups</div>
      <div class="s-row">
        <div>
          <div class="s-label">üìÅ ${vaultName2}/backup/</div>
          <div class="s-sub">Up to 3 rotating backups saved here on every schedule change. Open in Obsidian or any text editor to restore manually.</div>
        </div>
      </div>
      ${S.vaultDirHandle ? `<button class="btn btn-ghost" style="width:100%;margin-top:8px" id="s-list-backups">View Backup Files</button>` : ''}
    </div>`;

  ov.innerHTML=`<div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Settings</div>

    <div class="s-section">
      <div class="s-section-title">Appearance</div>
      <div class="s-row" style="flex-direction:column;align-items:stretch;gap:10px">
        <div class="s-label">Theme</div>
        <div class="theme-seg" id="theme-seg">
          <button class="theme-seg-btn${currentTheme==='auto'?' active':''}" data-theme="auto">‚òÄÔ∏é/üåô Auto</button>
          <button class="theme-seg-btn${currentTheme==='dark'?' active':''}" data-theme="dark">üåô Dark</button>
          <button class="theme-seg-btn${currentTheme==='light'?' active':''}" data-theme="light">‚òÄÔ∏é Light</button>
        </div>
      </div>
    </div>

    <div class="s-section">
      <div class="s-section-title">Vault Folder</div>
      <div class="s-row">
        <div><div class="s-label">üìÅ ${vaultName}</div><div class="s-sub">üìÑ .md config in root ¬∑ üìÅ data/ for daily files</div></div>
        <span class="pill ${vaultOk?'pill-green':'pill-amber'}">${vaultOk?'LIVE':'OFFLINE'}</span>
      </div>
      <button class="btn btn-ghost" style="width:100%;margin-top:8px" id="s-change-vault">Change Vault Folder</button>
      <button class="btn btn-ghost" style="width:100%;margin-top:8px" id="s-sync">‚Ü∫ Sync Now</button>
    </div>

    <div class="s-section">
      <div class="s-section-title">Notifications</div>
      ${notifSection}
    </div>

    ${batterySection}

    ${backupSection}

    <div class="s-section">
      <div class="s-section-title">App</div>
      <button class="btn btn-ghost" style="width:100%" id="s-install">üì≤ Install Guide</button>
    </div>
    <div class="s-section">
      <div class="s-section-title">Danger Zone</div>
      <button class="btn btn-ghost" style="width:100%;color:var(--danger);border-color:rgba(255,68,102,.3)" id="s-clear">Clear All Data &amp; Reset</button>
    </div>
    <button class="btn btn-ghost" style="width:100%" id="s-close">Close</button>
  </div>`;
  document.body.appendChild(ov);
  const close=()=>document.body.removeChild(ov);
  ov.addEventListener('click',e=>{ if(e.target===ov) close(); });
  ov.querySelector('#s-close').addEventListener('click',close);
  ov.querySelector('#s-sync').addEventListener('click',async()=>{ await loadFromVault(); renderAll(); showToast('Synced'); close(); });
  ov.querySelector('#s-change-vault').addEventListener('click',async()=>{ close(); const ok=await pickVaultFolder(); if(ok){ await loadFromVault(); renderAll(); }});
  ov.querySelector('#s-notif')?.addEventListener('click',async()=>{ S.notifPermission=await Notification.requestPermission(); close(); showSettings(); });
  ov.querySelector('#s-install').addEventListener('click',()=>{ close(); showInstallGuide(); });
  // Battery optimization buttons
  ov.querySelector('#s-battery-open')?.addEventListener('click',()=>{
    // Deep-link into Android settings ‚Äî works on most Android versions
    // This opens the app info page for Chrome; user taps Battery themselves
    try { location.href = 'intent:#Intent;action=android.settings.APPLICATION_DETAILS_SETTINGS;data=package:com.android.chrome;end'; }
    catch { showToast('Go to Settings ‚Üí Apps ‚Üí Chrome ‚Üí Battery'); }
    showToast('Settings opened ‚Äî tap Battery ‚Üí Unrestricted');
  });
  ov.querySelector('#s-battery-dismiss')?.addEventListener('click',()=>{ LS.set('batteryTipDismissed', true); close(); showSettings(); });
  ov.querySelector('#s-battery-reset')?.addEventListener('click',()=>{ LS.del('batteryTipDismissed'); close(); showSettings(); });
  ov.querySelector('#s-clear').addEventListener('click',()=>{
    if (confirm('Clear all app data and reset?')) {
      IDB.del('vaultHandle').catch(()=>{});
      localStorage.clear();
      location.reload();
    }
  });
  // Theme segment
  ov.querySelectorAll('.theme-seg-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      ov.querySelectorAll('.theme-seg-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyTheme(btn.dataset.theme);
    });
  });
  // Vault backup list
  ov.querySelector('#s-list-backups')?.addEventListener('click', async () => {
    close();
    await showVaultBackups();
  });
}

// ‚îÄ‚îÄ INSTALL GUIDE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showInstallGuide() {
  const ov = document.createElement('div'); ov.className='install-guide';
  ov.innerHTML=`<div class="install-modal">
    <div class="modal-handle"></div>
    <div style="font-size:20px;font-weight:800;margin-bottom:6px">üì≤ Install as App</div>
    <div style="font-size:12px;font-family:var(--font-mono);color:var(--muted);margin-bottom:20px;line-height:1.6">
      Install once ‚Äî runs offline, no browser chrome, lives on your home screen / taskbar.
    </div>

    <div class="platform-tabs">
      <button class="ptab active" data-p="local">üíª Local (Best)</button>
      <button class="ptab" data-p="chrome">Chrome Desktop</button>
      <button class="ptab" data-p="android">Android</button>
      <button class="ptab" data-p="ios">iOS</button>
    </div>

    <!-- LOCAL (recommended) -->
    <div class="platform-steps active" id="steps-local">
      <div style="background:rgba(0,255,136,.07);border:1px solid rgba(0,255,136,.2);border-radius:10px;padding:12px 14px;font-size:12px;font-family:var(--font-mono);color:var(--accent);line-height:1.6;margin-bottom:16px">
        ‚ú¶ Recommended. Runs fully offline, notifications work, zero hosting needed.
      </div>
      <div class="install-step">
        <div class="install-num">1</div>
        <div class="install-text">Put all 4 files (<b>index.html</b>, <b>sw.js</b>, <b>manifest.json</b>, <b>icon.svg</b>) in one folder on your computer.
          <small>e.g. C:\Users\You\HabitTracker\ or ~/HabitTracker/</small>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">2</div>
        <div class="install-text">Install <b>Node.js</b> (nodejs.org) if you don't have it. Then open Terminal / Command Prompt and run:
          <div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-top:8px;font-size:11px;font-family:var(--font-mono);color:var(--accent)">npx serve C:\path\to\your\folder</div>
          <small>Or on Mac/Linux: <code>npx serve ~/HabitTracker</code></small>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">3</div>
        <div class="install-text">Open <b>http://localhost:3000</b> in Chrome or Edge.
          <small>Keep the terminal running in background ‚Äî it's your local server.</small>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">4</div>
        <div class="install-text">In Chrome, click the <b>‚äï install icon</b> in the address bar (right side) ‚Üí <b>"Install ‚è∞ Habit Tracker"</b>.
          <small>The app now appears in your Start Menu / Applications and opens as a standalone window.</small>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">5</div>
        <div class="install-text">First launch: tap <b>"Choose Vault Folder"</b> ‚Üí pick your Obsidian vault. Done ‚Äî notifications will work fully.
          <small>On every subsequent launch, tap the amber "Reconnect" button once to re-grant file access.</small>
        </div>
      </div>
    </div>

    <!-- CHROME DESKTOP -->
    <div class="platform-steps" id="steps-chrome">
      <div class="notif-fix" style="margin-bottom:16px;margin-top:0">
        ‚ö† If hosted on Netlify, notifications will be blocked by their server headers. Use Local method for full functionality.
      </div>
      <div class="install-step">
        <div class="install-num">1</div>
        <div class="install-text">Open the app URL in <b>Chrome</b> or <b>Edge</b> on your computer.</div>
      </div>
      <div class="install-step">
        <div class="install-num">2</div>
        <div class="install-text">Look for the <b>‚äï</b> icon in the address bar (far right). Click it.
          <small>If you don't see it, go to Chrome menu ‚ãÆ ‚Üí "Save and Share" ‚Üí "Install ‚è∞ Habit Tracker‚Ä¶"</small>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">3</div>
        <div class="install-text">Click <b>"Install"</b> in the popup. The app opens in its own window and gets added to your taskbar / Start Menu.</div>
      </div>
      <div class="install-step">
        <div class="install-num">4</div>
        <div class="install-text">To enable notifications: click the <b>üîí lock icon</b> in the address bar ‚Üí <b>Notifications ‚Üí Allow</b>. Then reload.</div>
      </div>
    </div>

    <!-- ANDROID -->
    <div class="platform-steps" id="steps-android">
      <div class="install-step">
        <div class="install-num">1</div>
        <div class="install-text">Open the app in <b>Chrome for Android</b>.</div>
      </div>
      <div class="install-step">
        <div class="install-num">2</div>
        <div class="install-text">Tap Chrome's <b>‚ãÆ menu</b> ‚Üí <b>"Add to Home Screen"</b> ‚Üí <b>"Add"</b>.
          <small>The ‚è∞ icon appears on your home screen and opens in full-screen standalone mode.</small>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">3</div>
        <div class="install-text">Allow notifications when prompted. If blocked: <b>Settings ‚Üí Apps ‚Üí Chrome ‚Üí Notifications ‚Üí Allow</b>.</div>
      </div>
      <div class="install-step">
        <div class="install-num">4</div>
        <div class="install-text"><b>Allow background alarms (important!)</b><br>
          Go to <b>Settings ‚Üí Apps ‚Üí Chrome ‚Üí Battery ‚Üí Unrestricted</b>.
          <small>Without this, Android kills Chrome in the background and your alarms won't fire when the screen is off.</small>
          <div style="background:rgba(255,170,0,.08);border:1px solid rgba(255,170,0,.25);border-radius:8px;padding:10px 12px;margin-top:8px;font-size:11px;font-family:var(--font-mono);color:var(--warn);line-height:1.6">
            ‚ö† "Optimized" (Android default) = alarms may be delayed or skipped<br>
            ‚úì "Unrestricted" = alarms fire reliably even with screen off
          </div>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">5</div>
        <div class="install-text"><b>Note:</b> Android Chrome supports File System Access API ‚Äî vault folder and file writing works fully.
          <small>Tap "Reconnect" once each time you open the app to re-grant write access.</small>
        </div>
      </div>
    </div>

    <!-- iOS -->
    <div class="platform-steps" id="steps-ios">
      <div class="notif-fix" style="margin-bottom:16px;margin-top:0">
        ‚ö† iOS Safari does <b>not</b> support the File System Access API. The vault folder cannot be read or written on iPhone/iPad. Habits will save to browser storage only.
      </div>
      <div class="install-step">
        <div class="install-num">1</div>
        <div class="install-text">Open the app in <b>Safari</b> on iPhone or iPad.</div>
      </div>
      <div class="install-step">
        <div class="install-num">2</div>
        <div class="install-text">Tap the <b>Share button</b> (box with arrow) at the bottom of Safari.</div>
      </div>
      <div class="install-step">
        <div class="install-num">3</div>
        <div class="install-text">Scroll down and tap <b>"Add to Home Screen"</b> ‚Üí <b>"Add"</b>.
          <small>The ‚è∞ icon appears on your home screen.</small>
        </div>
      </div>
      <div class="install-step">
        <div class="install-num">4</div>
        <div class="install-text">Push notifications are <b>supported on iOS 16.4+</b> when installed as a PWA. When the app opens, tap <b>Allow</b> when prompted for notifications.</div>
      </div>
    </div>

    <button class="btn btn-ghost" style="width:100%;margin-top:20px" id="ig-close">Close</button>
  </div>`;
  document.body.appendChild(ov);
  ov.addEventListener('click', e=>{ if(e.target===ov) document.body.removeChild(ov); });
  ov.querySelector('#ig-close').addEventListener('click', ()=>document.body.removeChild(ov));
  // Platform tab switching
  ov.querySelectorAll('.ptab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      ov.querySelectorAll('.ptab').forEach(t=>t.classList.remove('active'));
      ov.querySelectorAll('.platform-steps').forEach(s=>s.classList.remove('active'));
      tab.classList.add('active');
      ov.querySelector('#steps-'+tab.dataset.p).classList.add('active');
    });
  });
}


function showToast(msg) {
  document.querySelector('.toast')?.remove();
  const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
  document.body.appendChild(t); setTimeout(()=>t.remove(),2500);
}

// ‚îÄ‚îÄ FIRST-RUN SETUP SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showFirstRunSetup() {
  document.getElementById('setup-screen')?.remove();
  const sc=document.createElement('div'); sc.className='setup-screen'; sc.id='setup-screen';
  sc.innerHTML=`<div class="setup-inner">
    <div class="setup-icon">‚è∞</div>
    <div class="setup-title">Habit Tracker</div>
    <div class="setup-desc">Select your Obsidian vault folder. The app finds your .md config there, then reads and writes your daily habit data directly to it.</div>
    <button class="btn btn-green" id="fs-pick" style="width:100%;font-size:16px;padding:16px 22px">üìÅ Choose Vault Folder</button>
    <div class="setup-note">
      <b>One-time setup.</b> The folder is remembered. On each app launch you'll see a small "Reconnect" button ‚Äî one tap re-grants write access (browser security requirement).<br><br>
      <b>Folder structure expected:</b><br>
      üìÅ YourVault/<br>
      &nbsp;&nbsp;üìÑ your-config.md<br>
      &nbsp;&nbsp;üìÅ data/ ‚Üê daily files written here<br><br>
      To install as a standalone app, tap <b>‚öô Settings ‚Üí Install Guide</b> after setup.
    </div>
  </div>`;
  document.body.appendChild(sc);
  sc.querySelector('#fs-pick').addEventListener('click', async()=>{
    const ok = await pickVaultFolder();
    if (ok) {
      sc.remove();
      await loadFromVault();
      renderAll();
      showToast('‚úì Vault connected');
    }
  });
}

// ‚îÄ‚îÄ RECONNECT BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showReconnectBanner() {
  const area = document.getElementById('reconnect-area');
  const name = LS.get('vaultFolderName') || 'vault';
  area.innerHTML = `<div class="reconnect-banner">
    <div class="rb-text">üìÅ ${name} needs access<div class="rb-sub">Tap once to reconnect ‚Äî won't ask again this session</div></div>
    <button class="reconnect-btn" id="rb-btn">Reconnect</button>
  </div>`;
  area.querySelector('#rb-btn').addEventListener('click', async () => {
    const ok = await reconnectVault();
    if (ok) {
      await loadFromVault();
      renderAll();
      showToast('‚úì Vault reconnected');
    } else {
      showToast('Could not reconnect ‚Äî try Settings ‚Üí Change Vault');
    }
  });
}

// ‚îÄ‚îÄ BATTERY OPTIMIZATION BANNER (Android only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showBatteryBanner() {
  if (!isAndroid()) return;
  if (S.notifPermission !== 'granted') return;
  if (LS.get('batteryTipDismissed')) return;
  const area = document.getElementById('reconnect-area');
  // Don't replace reconnect banner if it's already showing
  if (area.querySelector('.reconnect-banner')) return;

  const existing = area.querySelector('.battery-banner');
  if (existing) return; // already shown

  const banner = document.createElement('div');
  banner.className = 'battery-banner';
  banner.style.cssText = 'margin:12px 20px 0;background:rgba(255,170,0,.07);border:1px solid rgba(255,170,0,.2);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:12px;animation:fadeUp .3s ease';
  banner.innerHTML = `
    <div style="flex:1;font-size:12px;color:var(--warn);font-family:var(--font-mono);line-height:1.5">
      üîã <b>Enable background alarms</b>
      <div style="font-size:11px;color:var(--muted);margin-top:2px">Settings ‚Üí Apps ‚Üí Chrome ‚Üí Battery ‚Üí <b>Unrestricted</b></div>
    </div>
    <button id="bb-settings" style="padding:7px 12px;background:var(--warn);color:#000;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;flex-shrink:0;font-family:var(--font-display)">Fix it</button>
    <button id="bb-dismiss" style="padding:7px 10px;background:transparent;border:1px solid rgba(255,170,0,.3);border-radius:8px;font-size:12px;color:var(--muted);cursor:pointer;flex-shrink:0;font-family:var(--font-mono)">‚úï</button>`;
  area.appendChild(banner);

  banner.querySelector('#bb-settings').addEventListener('click', () => {
    showSettings();
  });
  banner.querySelector('#bb-dismiss').addEventListener('click', () => {
    LS.set('batteryTipDismissed', true);
    banner.remove();
  });
}


function buildSkeleton() {
  document.getElementById('main-content').innerHTML=`
    <div class="card" id="card-countdown" style="animation-delay:0s">
      <div class="card-header"><span class="card-label">Now</span></div>
      <div class="card-body"></div>
    </div>
    <div class="card" id="card-habits" style="animation-delay:.08s">
      <div class="card-header" id="habits-card-header">
        <span class="card-label">Today's Habits</span>
        <div style="display:flex;align-items:center;gap:10px">
          <span id="habit-edit-btn" style="font-size:12px;color:var(--muted);cursor:pointer;font-family:var(--font-mono)">‚úé edit</span>
          <span id="sync-btn" style="font-size:12px;color:var(--muted);cursor:pointer;font-family:var(--font-mono)">‚Ü∫ sync</span>
        </div>
      </div>
      <div class="card-body"></div>
      <div id="habit-done-ledge" style="display:none;border-top:1px solid var(--border)">
        <button class="habit-done-pill" id="habit-done-pill" style="display:flex;width:100%;border-radius:0 0 var(--radius) var(--radius);padding:10px 16px;justify-content:center;font-size:12px">‚úì Done Editing</button>
      </div>
    </div>`;

  document.getElementById('sync-btn')?.addEventListener('click', async()=>{ await loadFromVault(); renderAll(); showToast('Synced'); });
  document.getElementById('habit-edit-btn')?.addEventListener('click', ()=>{
    S._habitEditMode = !S._habitEditMode;
    renderHabitBars();
  });
  document.getElementById('habit-done-pill')?.addEventListener('click', ()=>{
    S._habitEditMode = false;
    renderHabitBars();
  });

  const panels = document.getElementById('tab-panels');
  panels.style.transform = 'translateX(0%)';

  let activeTab = 0;
  let editMode = false;
  let touchStartX = 0, touchStartY = 0, isSwiping = false;

  // ‚îÄ‚îÄ Done FAB (edit ‚Üí save) ‚îÄ‚îÄ
  const fab = document.createElement('button');
  fab.className = 'edit-fab';
  fab.id = 'schedule-edit-fab';
  fab.innerHTML = 'Edit';
  fab.title = 'Edit schedule';
  fab.style.display = 'none';
  document.body.appendChild(fab);

  // ‚îÄ‚îÄ Add FAB (only in edit mode) ‚îÄ‚îÄ
  const addFab = document.createElement('button');
  addFab.className = 'add-fab';
  addFab.id = 'schedule-add-fab';
  addFab.innerHTML = 'Add';
  addFab.title = 'Add entry';
  document.body.appendChild(addFab);

  addFab.addEventListener('click', () => {
    showAddScheduleSheet(() => { renderScheduleTab(true); });
  });

  function commitEdits(showMsg) {
    const before = JSON.stringify(_scheduleSnapshot || []);
    const after = JSON.stringify(S.config?.schedule || []);
    if (before !== after) {
      saveScheduleToVault();
      forceSwUpdate(); // force SW re-sync with new alarm times
    }
    _scheduleSnapshot = null;
    if (showMsg) showToast('‚úì Schedule saved');
  }

  fab.addEventListener('click', () => {
    if (editMode) {
      const el = document.getElementById('schedule-tab');
      if (el) {
        el.querySelectorAll('.sched-edit-time').forEach(inp => {
          const idx = parseInt(inp.dataset.idx);
          const actEl = el.querySelector(`.sched-edit-act[data-idx="${idx}"]`);
          const t = inp.value.trim(), a = actEl?.value.trim() || '';
          if (t && a && S.config?.schedule[idx]) S.config.schedule[idx] = { time: t, activity: a };
        });
        try { S.config.schedule.sort((a, b) => schedDate(a.time) - schedDate(b.time)); } catch {}
        LS.set('lastConfig', S.config);
      }
      commitEdits(true);
      editMode = false;
      fab.innerHTML = 'Edit'; fab.title = 'Edit schedule';
      fab.classList.remove('editing');
      addFab.classList.remove('visible');
      renderScheduleTab(false);
      renderCountdown();
    } else {
      _scheduleSnapshot = JSON.parse(JSON.stringify(S.config?.schedule || []));
      editMode = true;
      fab.innerHTML = 'Done'; fab.title = 'Save and exit edit';
      fab.classList.add('editing');
      addFab.classList.add('visible');
      renderScheduleTab(true);
    }
  });

  function switchTab(idx) {
    if (idx === activeTab) return;
    // Auto-close habit edit mode when switching to schedule tab
    if (S._habitEditMode) {
      S._habitEditMode = false;
      renderHabitBars();
    }
    // Auto-commit schedule edits when leaving schedule tab
    if (activeTab === 1 && editMode) {
      const el = document.getElementById('schedule-tab');
      if (el) {
        el.querySelectorAll('.sched-edit-time').forEach(inp => {
          const idx2 = parseInt(inp.dataset.idx);
          const actEl = el.querySelector(`.sched-edit-act[data-idx="${idx2}"]`);
          const t = inp.value.trim(), a = actEl?.value.trim() || '';
          if (t && a && S.config?.schedule[idx2]) S.config.schedule[idx2] = { time: t, activity: a };
        });
        try { S.config.schedule.sort((a, b) => schedDate(a.time) - schedDate(b.time)); } catch {}
        LS.set('lastConfig', S.config);
      }
      commitEdits(false);
      editMode = false;
      fab.innerHTML = 'Edit';
      fab.classList.remove('editing');
      addFab.classList.remove('visible');
    }
    activeTab = idx;
    panels.style.transform = `translateX(${-idx * 100}%)`;
    document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
    fab.style.display = idx === 1 ? 'flex' : 'none';
    if (idx === 1) renderScheduleTab(false);
  }

  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => switchTab(parseInt(btn.dataset.tab)));
  });

  panels.addEventListener('touchstart', e => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    isSwiping = false;
  }, { passive: true });

  panels.addEventListener('touchmove', e => {
    const dx = e.touches[0].clientX - touchStartX;
    const dy = e.touches[0].clientY - touchStartY;
    if (!isSwiping && Math.abs(dx) > Math.abs(dy) * 1.5 && Math.abs(dx) > 12) isSwiping = true;
  }, { passive: true });

  panels.addEventListener('touchend', e => {
    if (!isSwiping) return;
    const dx = e.changedTouches[0].clientX - touchStartX;
    if (Math.abs(dx) > 60) switchTab(dx < 0 ? Math.min(1, activeTab + 1) : Math.max(0, activeTab - 1));
    isSwiping = false;
  }, { passive: true });

  S._switchTab = switchTab;
  S._getEditMode = () => editMode;
  S._getActiveTab = () => activeTab;
}

function renderAll() {
  renderCountdown();
  renderHabitBars();
  // Only re-render schedule tab if it's currently visible
  if (S._getActiveTab && S._getActiveTab() === 1) {
    renderScheduleTab(S._getEditMode ? S._getEditMode() : false);
  }
  // Keep SW alarm store in sync
  syncAlarmsToSW();
}

function startTimers() {
  if (S.countdownInterval) clearInterval(S.countdownInterval);
  if (S.checkInterval) clearInterval(S.checkInterval);
  S.countdownInterval=setInterval(()=>{
    tickCountdown();
    if (new Date().getSeconds()===0) {
      renderCountdown();
      if (S._getActiveTab && S._getActiveTab()===1) renderScheduleTab(S._getEditMode?S._getEditMode():false);
    }
  }, 1000);
  S.checkInterval=setInterval(checkAlarms, 2000);
}

async function fetchNepaliDate() {
  // Pure JS Nepali date conversion (BS) ‚Äî works fully offline
  // Uses the Bikram Sambat calendar algorithm
  try {
    const now = new Date();
    const yy = now.getFullYear(), mm = now.getMonth() + 1, dd = now.getDate();

    // BS year data: [days in each month] for BS years 2000-2089
    // Each entry: total days in that BS year's months
    const bsData = {
      2082: [31,32,31,32,31,30,30,30,29,29,30,31],
      2083: [31,31,32,31,31,30,30,30,29,30,30,30],
      2084: [31,31,32,31,31,30,30,30,29,30,30,30],
      2085: [31,32,31,32,30,31,30,29,30,29,30,30],
    };
    const bsMonths = ['Baishakh','Jestha','Ashadh','Shrawan','Bhadra','Ashwin','Kartik','Mangsir','Poush','Magh','Falgun','Chaitra'];

    // Known anchor: 2082 Baishakh 1 = 2025 April 14
    const anchor = new Date(2025, 3, 14); // April 14, 2025 = 2082/01/01
    const diffDays = Math.floor((now - anchor) / 86400000);

    let bsYear = 2082, bsMonth = 1, bsDay = 1;
    let remaining = diffDays;

    outer:
    for (let y = 2082; y <= 2090; y++) {
      const months = bsData[y] || [31,31,32,31,31,31,30,30,29,29,30,30];
      for (let m = 0; m < 12; m++) {
        const daysInMonth = months[m];
        if (remaining < daysInMonth) {
          bsYear = y; bsMonth = m + 1; bsDay = 1 + remaining;
          break outer;
        }
        remaining -= daysInMonth;
      }
    }

    return `${bsMonths[bsMonth - 1]} ${bsDay}, ${bsYear}`;
  } catch { return null; }
}

function updateHeaderDate() {
  const el=document.getElementById('header-date');
  if (!el) return;
  const engDate = new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'}).toUpperCase();
  el.textContent = engDate;
  // Fetch Nepali date asynchronously
  fetchNepaliDate().then(nepDate => {
    if (nepDate && el) el.textContent = engDate + ' / ' + nepDate.toUpperCase();
  });
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function boot() {
  // Apply saved theme immediately
  applyTheme(LS.get('theme') || 'auto');

  // Handle habit action from notification click when app was closed
  const urlParams = new URLSearchParams(location.search);
  const pendingHabit = urlParams.get('ha');
  if (pendingHabit) {
    try {
      const { habitKey, habitVal } = JSON.parse(decodeURIComponent(pendingHabit));
      if (habitKey && habitVal !== undefined) {
        setTimeout(() => { updateHabit(habitKey, habitVal); showToast(`‚úì ${habitKey} logged`); }, 1500);
      }
    } catch {}
    // Clean URL
    history.replaceState({}, '', location.pathname);
  }

  updateHeaderDate();
  setInterval(updateHeaderDate, 60000);

  // Midnight reload of habit data
  const msUntilMidnight=()=>{ const n=new Date(),m=new Date(n); m.setHours(24,0,0,0); return m-n; };
  setTimeout(()=>{ loadFromVault().then(renderHabitBars); setInterval(()=>loadFromVault().then(renderHabitBars), 86400000); }, msUntilMidnight());

  if ('serviceWorker' in navigator) {
    const swReg = await navigator.serviceWorker.register('./sw.js').catch(console.error);
    // Once controller is available, start keep-alive and sync alarms
    const kickSW = () => {
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ type: 'START_KEEPALIVE' });
        syncAlarmsToSW();
      }
    };
    if (navigator.serviceWorker.controller) {
      kickSW();
    } else {
      navigator.serviceWorker.addEventListener('controllerchange', kickSW, { once: true });
    }

    // Listen for messages from SW (notification action clicks)
    navigator.serviceWorker.addEventListener('message', e => {
      if (!e.data) return;
      if (e.data.type === 'HABIT_ACTION') {
        const {habitKey, habitVal} = e.data;
        if (habitKey !== undefined && habitVal !== undefined) {
          updateHabit(habitKey, habitVal);
          showToast(`‚úì ${habitKey} logged from notification`);
        }
      } else if (e.data.type === 'SNOOZED') {
        const tag = e.data.tag || '';
        const idxMatch = tag.match(/alarm-(\d+)/);
        const mins = e.data.mins || 5;
        if (idxMatch) {
          const schedIdx = parseInt(idxMatch[1]);
          const until = Date.now() + mins * 60000;
          S.snooze[schedIdx] = until;
          renderCountdown();
          showToast(`Snoozed ${mins}m`);
          // Schedule a notification to fire when snooze expires (if SW available)
          if (S.notifPermission === 'granted' && navigator.serviceWorker.controller && S.config?.schedule[schedIdx]) {
            const item = S.config.schedule[schedIdx];
            const hi = detectHabit(item.activity);
            const snOpts = S.config.habitTracker?.snoozeOptions || [5, 10];
            const actions = [];
            if (hi) {
              const {key, config: cfg} = hi;
              if (cfg.type === 'incremental') actions.push({ action: `habit:${key}:${cfg.increment}`, title: `‚úì Done (+${cfg.increment})` });
              else cfg.choices.slice(0, 2).forEach(c => actions.push({ action: `habit:${key}:${c.value}`, title: c.label }));
            }
            actions.push({ action: 'dismiss', title: 'Dismiss' });
            snOpts.slice(0, 1).forEach(m => actions.push({ action: `snooze:${schedIdx}:${m}`, title: `‚è∞ +${m}m` }));
            navigator.serviceWorker.controller.postMessage({
              type: 'SCHEDULE_ALARM',
              title: `‚è∞ ${item.time} ‚Äî ${item.activity}`,
              body: hi ? `Snooze ended ¬∑ Log ${hi.key}` : 'Snooze ended',
              tag: `alarm-${schedIdx}`,
              delay: mins * 60000,
              actions
            });
          }
        }
      } else if (e.data.type === 'NOTIFICATION_CLICK') {
        // focus app, handled by SW openWindow already
      }
    });
  }

  document.getElementById('btn-reload').addEventListener('click', async()=>{
    if (S.vaultDirHandle) {
      await loadFromVault(); renderAll(); showToast('Reloaded');
    } else {
      // Use this user gesture to request permission
      const ok = await reconnectVault();
      if (ok) { await loadFromVault(); renderAll(); showToast('‚úì Reloaded'); }
      else { showFirstRunSetup(); }
    }
  });
  document.getElementById('btn-settings').addEventListener('click', showSettings);

  // Load cached config + today's habits for instant render
  const cached=LS.get('lastConfig');
  if (cached?.schedule) S.config=cached;
  S.habitData = LS.get('habitData_' + todayStr()) || {};

  buildSkeleton();
  startTimers();
  renderAll();

  // Attempt to restore vault handle from IndexedDB
  const state = await restoreVaultHandle();
  if (state === 'granted') {
    await loadFromVault();
    renderAll();
  } else if (state === 'needs-grant') {
    showReconnectBanner();
  } else if (!LS.get('vaultFolderName')) {
    // First ever launch
    showFirstRunSetup();
  }
  // else: no vault handle, but config in localStorage ‚Äî still renders fine

  if (Notification.permission==='default')
    setTimeout(()=>Notification.requestPermission().then(p=>{ S.notifPermission=p; showBatteryBanner(); }), 2000);
  else
    setTimeout(showBatteryBanner, 1000);
}

boot();

// Prevent pull-to-refresh (overscroll-behavior covers Chrome; this covers iOS Safari)
document.addEventListener('touchmove', e => {
  let el = e.target;
  while (el && el !== document.body) {
    const s = getComputedStyle(el);
    if ((s.overflowY === 'auto' || s.overflowY === 'scroll') && el.scrollHeight > el.clientHeight) return;
    el = el.parentElement;
  }
  if (document.scrollingElement && document.scrollingElement.scrollTop === 0) e.preventDefault();
}, { passive: false });
</script>
</body>
</html>
